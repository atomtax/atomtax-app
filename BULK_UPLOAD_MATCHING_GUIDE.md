# 일괄 업로드 매칭 안내 개선 완료

## 📅 작업 일자
2026-01-27

## 🎯 개선 목표
사용자가 **물건목록**과 **필요경비**의 매칭 방식을 명확히 이해하고, 정확하게 작성할 수 있도록 안내 개선

## ✅ 개선 내용

### 1. 양식 다운로드 시 상세 안내 메시지

**변경 전**:
```
✅ 엑셀 양식이 다운로드되었습니다.

양식에 데이터를 입력한 후 "일괄 업로드" 버튼을 클릭하세요.
```

**변경 후**:
```
✅ 엑셀 양식이 다운로드되었습니다.

📋 작성 방법:
1. Sheet 1 (물건목록): 사업자번호*와 물건명을 정확히 입력
2. Sheet 2 (필요경비상세): 사업자번호*와 물건명*을 물건목록과 동일하게 입력

⚠️ 중요: 물건명은 띄어쓰기까지 정확히 일치해야 매칭됩니다!
   (복사&붙여넣기 권장)

작성 완료 후 "일괄 업로드" 버튼을 클릭하세요.
```

### 2. 엑셀 Sheet 1 (물건목록) 안내 추가

**추가된 내용**:
```
행 1: 📋 물건목록 작성 방법: 아래 예시를 참고하여 사업자번호*와 물건명을 
      정확히 입력하세요. 물건명은 필요경비 시트에서 매칭에 사용됩니다.
행 2: (빈 행)
행 3: [컬럼 헤더]
행 4~: [데이터]
```

### 3. 엑셀 Sheet 2 (필요경비상세) 안내 추가

**추가된 내용**:
```
행 1: 📋 필요경비 작성 방법: 사업자번호*와 물건명*은 물건목록 시트와 
      정확히 일치해야 합니다. (복사&붙여넣기 권장)
행 2: (빈 행)
행 3: [컬럼 헤더] - '물건명* (물건목록과 동일)'로 명확히 표시
행 4~: [데이터] - 비고란에 "물건목록의 첫번째 물건" 등 매칭 설명 추가
```

**예시 데이터**:
| 사업자번호* | 물건명* (물건목록과 동일) | 번호 | 비용명 | 비고 |
|------------|-------------------------|------|--------|------|
| 123-45-67890 | 서울시 강남구 아파트 | 1 | 중개수수료 | 물건목록의 첫번째 물건 |
| 123-45-67890 | 서울시 강남구 아파트 | 2 | 취득세 | |
| 123-45-67890 | 서울시 서초구 오피스텔 | 1 | 중개수수료 | 물건목록의 두번째 물건 |

### 4. 매칭 실패 감지 및 상세 리포트

**추가된 기능**:
```javascript
// 필요경비 매칭 시 성공/실패 추적
let matchedExpenseCount = 0;
let unmatchedExpenses = [];

for (const expenseRow of expenseJson) {
    // ... 매칭 로직 ...
    
    if (matched) {
        matchedExpenseCount++;  // 성공 카운트
    } else {
        unmatchedExpenses.push({  // 실패 기록
            businessNumber: businessNumber,
            propertyName: propertyName,
            expenseName: expense.expense_name
        });
    }
}
```

### 5. 업로드 결과 메시지 개선

**변경 전**:
```
✅ 업로드 완료!

성공: 25건
실패: 2건

[오류 내역]
사업자번호 111-22-33333: 고객사를 찾을 수 없습니다.
사업자번호 444-55-66666: 고객사를 찾을 수 없습니다.
```

**변경 후**:
```
✅ 업로드 완료!

📦 물건 목록: 25건 성공, 2건 실패
💰 필요경비: 68건 매칭, 5건 매칭 실패

[물건 등록 오류]
사업자번호 111-22-33333: 고객사를 찾을 수 없습니다.
사업자번호 444-55-66666: 고객사를 찾을 수 없습니다.

[필요경비 매칭 실패]
⚠️ 물건명이 일치하지 않아 연결되지 않은 경비:
- 123-45-67890 / "서울시 강남구아파트" / 중개수수료
- 123-45-67890 / "서울 서초구 오피스텔" / 취득세
- 987-65-43210 / "부산시해운대상가" / 등기비용
... 외 2건
💡 물건명을 물건목록 시트와 정확히 일치시켜주세요.
```

## 📋 매칭 방식 설명

### 매칭 키
1. **사업자번호** (1차 매칭)
2. **물건명** (2차 매칭)

### 매칭 과정
```
Step 1: 사업자번호로 그룹화
  123-45-67890 → [아파트, 오피스텔]
  987-65-43210 → [상가]

Step 2: 필요경비 읽기
  123-45-67890 + "서울시 강남구 아파트" → 중개수수료
  123-45-67890 + "서울시 강남구 아파트" → 취득세
  123-45-67890 + "서울시 서초구 오피스텔" → 중개수수료

Step 3: 물건명으로 매칭
  "서울시 강남구 아파트" 물건에
    → 중개수수료 연결 ✅
    → 취득세 연결 ✅
  
  "서울시 서초구 오피스텔" 물건에
    → 중개수수료 연결 ✅
```

### 매칭 성공 조건
- ✅ 사업자번호가 정확히 일치
- ✅ 물건명이 **완전히** 일치 (띄어쓰기, 대소문자 포함)

### 매칭 실패 사례
```
물건목록: "서울시 강남구 아파트"
필요경비: "서울시강남구아파트"     ❌ 띄어쓰기 다름
필요경비: "서울시 강남구 아파트 "  ❌ 뒤에 공백
필요경비: "서울시 강남구 아파트101" ❌ 문자 추가됨
```

## 🎯 사용자 가이드

### 권장 작성 방법

#### 방법 1: 복사 & 붙여넣기 (가장 안전)
```
1. Sheet 1 (물건목록)에서 물건명 입력
   예: "서울시 강남구 테헤란로 123 아파트"

2. 해당 셀 선택 후 복사 (Ctrl+C)

3. Sheet 2 (필요경비상세)로 이동

4. 물건명* 컬럼에 붙여넣기 (Ctrl+V)
   → 100% 동일하게 복사됨 ✅

5. 필요경비 여러 행에 같은 방법으로 붙여넣기
```

#### 방법 2: 엑셀 수식 사용
```
Sheet 2의 B4 셀 (물건명* 첫 데이터):
='물건목록'!B4

이후 아래로 드래그하여 수식 복사
→ 자동으로 물건목록 참조 ✅
```

#### 방법 3: 데이터 검증 (드롭다운)
```
Sheet 2의 B열 전체 선택
  ↓
데이터 → 데이터 검증
  ↓
제한 대상: 목록
원본: ='물건목록'!$B$4:$B$100
  ↓
이제 드롭다운으로 물건명 선택 가능 ✅
```

## 📊 개선 효과

### Before (개선 전)
- ❌ 매칭 방식 설명 부족
- ❌ 양식에 안내 없음
- ❌ 매칭 실패 시 원인 파악 어려움
- ❌ 결과 메시지 단순함

### After (개선 후)
- ✅ 명확한 매칭 방식 안내
- ✅ 양식에 상세한 설명 추가
- ✅ 매칭 실패 항목 상세 리포트
- ✅ 해결 방법 제시 (복사&붙여넣기 권장)
- ✅ 성공/실패 건수 분리 표시

## 🧪 테스트 시나리오

### 시나리오 1: 정상 매칭
```
물건목록:
  123-45-67890 | 서울시 강남구 아파트

필요경비:
  123-45-67890 | 서울시 강남구 아파트 | 중개수수료
  123-45-67890 | 서울시 강남구 아파트 | 취득세

결과:
✅ 업로드 완료!
📦 물건 목록: 1건 성공
💰 필요경비: 2건 매칭
```

### 시나리오 2: 물건명 불일치
```
물건목록:
  123-45-67890 | 서울시 강남구 아파트

필요경비:
  123-45-67890 | 서울시강남구아파트 | 중개수수료  ← 띄어쓰기 없음

결과:
✅ 업로드 완료!
📦 물건 목록: 1건 성공
💰 필요경비: 0건 매칭, 1건 매칭 실패

[필요경비 매칭 실패]
⚠️ 물건명이 일치하지 않아 연결되지 않은 경비:
- 123-45-67890 / "서울시강남구아파트" / 중개수수료
💡 물건명을 물건목록 시트와 정확히 일치시켜주세요.
```

### 시나리오 3: 사업자번호 불일치
```
물건목록:
  123-45-67890 | 서울시 강남구 아파트

필요경비:
  987-65-43210 | 서울시 강남구 아파트 | 중개수수료  ← 다른 사업자번호

결과:
✅ 업로드 완료!
📦 물건 목록: 1건 성공
💰 필요경비: 0건 매칭, 1건 매칭 실패

[필요경비 매칭 실패]
⚠️ 물건명이 일치하지 않아 연결되지 않은 경비:
- 987-65-43210 / "서울시 강남구 아파트" / 중개수수료
💡 물건명을 물건목록 시트와 정확히 일치시켜주세요.
```

## 📝 변경된 파일

1. ✅ `traders-data.html`
   - 양식 다운로드 안내 메시지 개선
   - Sheet 1 안내 행 추가
   - Sheet 2 안내 행 및 컬럼명 개선
   - 매칭 실패 감지 로직 추가
   - 결과 메시지 상세화

2. ✅ `BULK_UPLOAD_MATCHING_GUIDE.md`
   - 매칭 안내 개선 완료 문서

## 💡 추가 권장 사항

### 1. 매칭 검증 기능 (향후 추가 가능)
```javascript
// 업로드 전 미리보기 기능
function previewMatching() {
    // 엑셀 읽기
    // 매칭 결과 테이블로 표시
    // 매칭 실패 항목 강조
    // 확인 후 업로드 진행
}
```

### 2. 자동 수정 제안
```
매칭 실패 시:
"서울시강남구아파트"와 유사한 물건:
  - "서울시 강남구 아파트" (유사도 95%)
자동으로 매칭하시겠습니까?
```

### 3. 엑셀 매크로 제공
```vba
' Sheet 2에서 Sheet 1의 물건명 자동 참조
Sub AutoMatchPropertyName()
    ' 물건명 자동 복사 매크로
End Sub
```

---

**작업 완료 시각**: 2026-01-27  
**담당자**: AI Assistant  
**승인**: 사용자 확인 대기

## 🎉 완료!

이제 사용자가 **매칭 방식을 명확히 이해**하고, **정확하게 엑셀을 작성**할 수 있습니다!
