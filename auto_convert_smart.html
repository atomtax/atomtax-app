<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê¸°ì¥ì´ê´„í‘œ â†’ ì¼ê´„ì—…ë¡œë“œ ì–‘ì‹ ìë™ ë³€í™˜</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
        }
        .step {
            background: #f0f9ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 20px 0;
        }
        .success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
        }
        .error {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 12px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: left;
        }
        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        tr:nth-child(even) {
            background: #f9f9f9;
        }
        pre {
            background: #f4f4f4;
            padding: 12px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 11px;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            margin: 10px 5px;
        }
        .btn:hover {
            background: #5568d3;
        }
        .loading {
            text-align: center;
            padding: 40px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ ê¸°ì¥ì´ê´„í‘œ â†’ ì¼ê´„ì—…ë¡œë“œ ì–‘ì‹ ìë™ ë³€í™˜</h1>
        
        <div id="output">
            <div class="loading">
                <div class="spinner"></div>
                <p>íŒŒì¼ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
            </div>
        </div>
        
        <div id="downloadSection" style="display: none; text-align: center; margin-top: 20px;">
            <button class="btn" onclick="downloadConvertedFile()">
                ğŸ“¥ ë³€í™˜ëœ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
            </button>
        </div>
    </div>

    <script>
        let convertedWorkbook = null;

        async function autoAnalyze() {
            const output = document.getElementById('output');
            
            try {
                output.innerHTML = '<div class="step"><strong>1ï¸âƒ£ íŒŒì¼ ë¡œë“œ ì¤‘...</strong></div>';
                
                const response = await fetch('ê¸°ì¥ì´ê´„í‘œ_ì›ë³¸.xlsx');
                if (!response.ok) throw new Error('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, {type: 'array', cellDates: true});
                
                output.innerHTML += '<div class="step success"><strong>âœ… íŒŒì¼ ë¡œë“œ ì™„ë£Œ</strong></div>';
                
                // ì‹œíŠ¸ ë¶„ì„
                output.innerHTML += `<div class="step"><strong>2ï¸âƒ£ ì‹œíŠ¸ ë¶„ì„ ì¤‘...</strong><br>ì´ ${workbook.SheetNames.length}ê°œ ì‹œíŠ¸ ë°œê²¬</div>`;
                
                let html = '';
                let mainSheetIndex = 0;
                let maxRows = 0;
                
                // ê°€ì¥ ë§ì€ ë°ì´í„°ê°€ ìˆëŠ” ì‹œíŠ¸ ì°¾ê¸°
                workbook.SheetNames.forEach((sheetName, idx) => {
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    html += `<div class="step">
                        <strong>ì‹œíŠ¸ ${idx + 1}: ${sheetName}</strong><br>
                        í–‰ ê°œìˆ˜: ${jsonData.length}ê°œ
                    </div>`;
                    
                    if (jsonData.length > maxRows) {
                        maxRows = jsonData.length;
                        mainSheetIndex = idx;
                    }
                });
                
                output.innerHTML += html;
                output.innerHTML += `<div class="step success"><strong>âœ… ë©”ì¸ ì‹œíŠ¸ ì„ íƒ: ${workbook.SheetNames[mainSheetIndex]} (${maxRows}í–‰)</strong></div>`;
                
                // ë©”ì¸ ì‹œíŠ¸ ë°ì´í„° ë¶„ì„
                const mainSheet = workbook.Sheets[workbook.SheetNames[mainSheetIndex]];
                const jsonDataArray = XLSX.utils.sheet_to_json(mainSheet, {header: 1});
                const jsonDataObjects = XLSX.utils.sheet_to_json(mainSheet);
                
                output.innerHTML += '<div class="step"><strong>3ï¸âƒ£ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (ì²˜ìŒ 10í–‰)</strong></div>';
                
                // í…Œì´ë¸”ë¡œ í‘œì‹œ
                let tableHtml = '<table><tr>';
                if (jsonDataArray.length > 0) {
                    jsonDataArray[0].forEach((header, idx) => {
                        tableHtml += `<th>${idx + 1}. ${header || '(ë¹ˆì¹¸)'}</th>`;
                    });
                    tableHtml += '</tr>';
                    
                    jsonDataArray.slice(1, 11).forEach(row => {
                        tableHtml += '<tr>';
                        row.forEach(cell => {
                            tableHtml += `<td>${cell || ''}</td>`;
                        });
                        tableHtml += '</tr>';
                    });
                    tableHtml += '</table>';
                    output.innerHTML += tableHtml;
                }
                
                // ì»¬ëŸ¼ ìë™ ê°ì§€
                output.innerHTML += '<div class="step"><strong>4ï¸âƒ£ ì»¬ëŸ¼ ìë™ ê°ì§€ ì¤‘...</strong></div>';
                
                const headers = jsonDataArray[0] || [];
                const columnMapping = detectColumns(headers);
                
                output.innerHTML += `<div class="step success">
                    <strong>âœ… ì»¬ëŸ¼ ë§¤í•‘ ì™„ë£Œ</strong><br>
                    <pre>${JSON.stringify(columnMapping, null, 2)}</pre>
                </div>`;
                
                // ë°ì´í„° ë³€í™˜ (1-20ë²ˆ)
                output.innerHTML += '<div class="step"><strong>5ï¸âƒ£ ë°ì´í„° ë³€í™˜ ì¤‘ (1-20ë²ˆ)...</strong></div>';
                
                const convertedData = convertData(jsonDataObjects, columnMapping, 20);
                
                output.innerHTML += `<div class="step success"><strong>âœ… ${convertedData.length}ê±´ ë³€í™˜ ì™„ë£Œ</strong></div>`;
                
                // ë³€í™˜ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°
                output.innerHTML += '<div class="step"><strong>6ï¸âƒ£ ë³€í™˜ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° (ì²˜ìŒ 5ê±´)</strong></div>';
                output.innerHTML += `<pre>${JSON.stringify(convertedData.slice(0, 5), null, 2)}</pre>`;
                
                // ì—‘ì…€ íŒŒì¼ ìƒì„±
                output.innerHTML += '<div class="step"><strong>7ï¸âƒ£ ì—‘ì…€ íŒŒì¼ ìƒì„± ì¤‘...</strong></div>';
                
                convertedWorkbook = createExcelFile(convertedData);
                
                output.innerHTML += '<div class="step success"><strong>âœ… ëª¨ë“  ì‘ì—… ì™„ë£Œ!</strong></div>';
                
                // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œ
                document.getElementById('downloadSection').style.display = 'block';
                
            } catch (error) {
                output.innerHTML += `<div class="step error"><strong>âŒ ì˜¤ë¥˜ ë°œìƒ:</strong><br>${error.message}</div>`;
                console.error(error);
            }
        }

        function detectColumns(headers) {
            const mapping = {};
            
            headers.forEach((header, idx) => {
                const h = String(header).toLowerCase();
                
                if (h.includes('ì‚¬ì—…ì') && h.includes('ë²ˆí˜¸')) {
                    mapping.businessNumber = idx;
                } else if (h.includes('ë¬¼ê±´') || h.includes('ë¶€ë™ì‚°')) {
                    mapping.propertyName = idx;
                } else if (h.includes('ì†Œì¬ì§€') || h.includes('ì£¼ì†Œ')) {
                    mapping.address = idx;
                } else if (h.includes('ì·¨ë“') && (h.includes('ê°€ì•¡') || h.includes('ê¸ˆì•¡'))) {
                    mapping.acquisitionValue = idx;
                } else if (h.includes('ì–‘ë„') && (h.includes('ê°€ì•¡') || h.includes('ê¸ˆì•¡'))) {
                    mapping.transferValue = idx;
                } else if (h.includes('ì¢…ì†Œì„¸') || (h.includes('ì†Œë“ì„¸') && !h.includes('ì§€ë°©'))) {
                    mapping.prepaidIncomeTax = idx;
                } else if (h.includes('ì§€ë°©') && h.includes('ì†Œë“ì„¸')) {
                    mapping.prepaidLocalTax = idx;
                } else if (h.includes('ì–‘ë„ì¼') || h.includes('ë§¤ë„ì¼')) {
                    mapping.transferDate = idx;
                }
            });
            
            // ê¸°ë³¸ê°’ ì„¤ì • (ë§¤í•‘ë˜ì§€ ì•Šì€ ê²½ìš°)
            if (mapping.businessNumber === undefined) mapping.businessNumber = 0;
            if (mapping.propertyName === undefined) mapping.propertyName = 1;
            if (mapping.address === undefined) mapping.address = 2;
            
            return mapping;
        }

        function convertData(jsonData, mapping, limit) {
            const converted = [];
            const headers = Object.keys(jsonData[0] || {});
            
            for (let i = 0; i < Math.min(limit, jsonData.length); i++) {
                const row = jsonData[i];
                const rowArray = headers.map(h => row[h]);
                
                const item = {
                    'ì‚¬ì—…ìë²ˆí˜¸*': rowArray[mapping.businessNumber] || '',
                    'ë¬¼ê±´ëª…': rowArray[mapping.propertyName] || `ë¬¼ê±´${i + 1}`,
                    'ì†Œì¬ì§€': rowArray[mapping.address] || '',
                    'ì·¨ë“ê°€ì•¡': parseFloat(rowArray[mapping.acquisitionValue]) || 0,
                    'ê¸°íƒ€í•„ìš”ê²½ë¹„': 0,
                    'ì–‘ë„ê°€ì•¡': parseFloat(rowArray[mapping.transferValue]) || 0,
                    'ì²˜ë¶„ë¹„': 0,
                    'ì–‘ë„ì†Œë“': '',
                    'ì–‘ë„ì¼(YYYYMMDD)': formatDate(rowArray[mapping.transferDate]),
                    'ì‹ ê³ ê¸°í•œ': '',
                    'ê¸°ë‚©ë¶€ ì¢…ì†Œì„¸': parseFloat(rowArray[mapping.prepaidIncomeTax]) || 0,
                    'ê¸°ë‚©ë¶€ ì§€ë°©ì†Œë“ì„¸': parseFloat(rowArray[mapping.prepaidLocalTax]) || 0,
                    '85ì´ˆê³¼(Y/N)': 'N',
                    'ì§„í–‰ë‹¨ê³„': 'ë¯¸í™•ì¸',
                    'ë¹„ê³ ': ''
                };
                
                converted.push(item);
            }
            
            return converted;
        }

        function formatDate(dateValue) {
            if (!dateValue) return '';
            
            // ì´ë¯¸ YYYYMMDD í˜•ì‹ì¸ ê²½ìš°
            const str = String(dateValue).replace(/[^0-9]/g, '');
            if (str.length === 8) return str;
            
            // Date ê°ì²´ì¸ ê²½ìš°
            if (dateValue instanceof Date) {
                const year = dateValue.getFullYear();
                const month = String(dateValue.getMonth() + 1).padStart(2, '0');
                const day = String(dateValue.getDate()).padStart(2, '0');
                return `${year}${month}${day}`;
            }
            
            return '';
        }

        function createExcelFile(data) {
            const wb = XLSX.utils.book_new();
            
            // Sheet 1: ë¬¼ê±´ëª©ë¡
            const ws1 = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws1, 'ë¬¼ê±´ëª©ë¡');
            
            // Sheet 2: í•„ìš”ê²½ë¹„ìƒì„¸ (ë¹ˆ í…œí”Œë¦¿)
            const expenseTemplate = [
                ['ì‚¬ì—…ìë²ˆí˜¸*', 'ë¬¼ê±´ëª…*', 'ë²ˆí˜¸', 'ë¹„ìš©ëª…', 'êµ¬ë¶„(ì·¨ë“ê°€ì•¡/ê¸°íƒ€í•„ìš”ê²½ë¹„)', 'ê¸ˆì•¡', 'ë¹„ìš©ì¸ì •(O/X)', 'ë¹„ê³ ']
            ];
            const ws2 = XLSX.utils.aoa_to_sheet(expenseTemplate);
            XLSX.utils.book_append_sheet(wb, ws2, 'í•„ìš”ê²½ë¹„ìƒì„¸');
            
            return wb;
        }

        function downloadConvertedFile() {
            if (!convertedWorkbook) {
                alert('ë³€í™˜ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            const fileName = `ë§¤ë§¤ì‚¬ì—…ì_ì¼ê´„ì—…ë¡œë“œ_ì–‘ì‹_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(convertedWorkbook, fileName);
            
            alert(`âœ… íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!\n\níŒŒì¼ëª…: ${fileName}\n\nì´ì œ traders-data.htmlì—ì„œ "ì¼ê´„ ì—…ë¡œë“œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”!`);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
        window.onload = autoAnalyze;
    </script>
</body>
</html>
