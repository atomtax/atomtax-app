<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—‘ì…€ íŒŒì¼ ìë™ ë¶„ì„ ë° ë³€í™˜</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <h1>ìë™ ë¶„ì„ ì¤‘...</h1>
    <div id="output"></div>
    <script>
        // íŒŒì¼ ìë™ ë¡œë“œ ë° ë¶„ì„
        async function autoAnalyze() {
            try {
                const response = await fetch('ê¸°ì¥ì´ê´„í‘œ_ì›ë³¸.xlsx');
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, {type: 'array'});
                
                let output = document.getElementById('output');
                output.innerHTML = '<h2>ğŸ“Š íŒŒì¼ ë¶„ì„ ê²°ê³¼</h2>';
                
                // ëª¨ë“  ì‹œíŠ¸ ë¶„ì„
                output.innerHTML += `<p><strong>ì‹œíŠ¸ ê°œìˆ˜:</strong> ${workbook.SheetNames.length}</p>`;
                output.innerHTML += '<hr>';
                
                workbook.SheetNames.forEach((sheetName, idx) => {
                    output.innerHTML += `<h3>ì‹œíŠ¸ ${idx + 1}: ${sheetName}</h3>`;
                    
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    output.innerHTML += `<p><strong>í–‰ ê°œìˆ˜:</strong> ${jsonData.length}</p>`;
                    
                    // ì²« 20í–‰ í‘œì‹œ
                    if (jsonData.length > 0) {
                        output.innerHTML += '<table border="1" style="border-collapse: collapse; font-size: 12px;">';
                        jsonData.slice(0, 25).forEach((row, rowIdx) => {
                            output.innerHTML += '<tr>';
                            row.forEach((cell, cellIdx) => {
                                if (rowIdx === 0) {
                                    output.innerHTML += `<th style="padding: 5px; background: #667eea; color: white;">${cell || ''}</th>`;
                                } else {
                                    output.innerHTML += `<td style="padding: 5px;">${cell || ''}</td>`;
                                }
                            });
                            output.innerHTML += '</tr>';
                        });
                        output.innerHTML += '</table>';
                    }
                    
                    output.innerHTML += '<hr>';
                });
                
                // JSON í˜•ì‹ìœ¼ë¡œë„ ì¶œë ¥
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonWithHeaders = XLSX.utils.sheet_to_json(firstSheet);
                
                output.innerHTML += '<h3>JSON í˜•ì‹ (ì²˜ìŒ 5ê°œ):</h3>';
                output.innerHTML += `<pre style="background: #f4f4f4; padding: 15px; overflow-x: auto;">${JSON.stringify(jsonWithHeaders.slice(0, 5), null, 2)}</pre>`;
                
                // ë³€í™˜ ë¡œì§ ì‹¤í–‰
                output.innerHTML += '<hr><h2>ğŸ”„ ì¼ê´„ì—…ë¡œë“œ ì–‘ì‹ ë³€í™˜ ì‹œì‘...</h2>';
                convertToUploadFormat(workbook);
                
            } catch (error) {
                document.getElementById('output').innerHTML = `<p style="color: red;">ì˜¤ë¥˜: ${error.message}</p>`;
                console.error(error);
            }
        }
        
        function convertToUploadFormat(workbook) {
            try {
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                // ì»¬ëŸ¼ëª… ìë™ ê°ì§€
                const firstRow = jsonData[0];
                const columns = Object.keys(firstRow);
                
                document.getElementById('output').innerHTML += `<p><strong>ê°ì§€ëœ ì»¬ëŸ¼:</strong> ${columns.join(', ')}</p>`;
                
                // ì»¬ëŸ¼ ë§¤í•‘ (í•œê¸€ ì»¬ëŸ¼ëª… ì°¾ê¸°)
                const columnMapping = {
                    businessNumber: columns.find(col => col.includes('ì‚¬ì—…ì') || col.includes('ë²ˆí˜¸')) || columns[0],
                    propertyName: columns.find(col => col.includes('ë¬¼ê±´') || col.includes('ë¶€ë™ì‚°') || col.includes('ëª…ì¹­')) || columns[1],
                    address: columns.find(col => col.includes('ì†Œì¬ì§€') || col.includes('ì£¼ì†Œ') || col.includes('ìœ„ì¹˜')) || columns[2],
                    acquisitionValue: columns.find(col => col.includes('ì·¨ë“') && col.includes('ê°€ì•¡')) || columns[3],
                    transferValue: columns.find(col => col.includes('ì–‘ë„') && col.includes('ê°€ì•¡')) || columns[4],
                    prepaidIncomeTax: columns.find(col => col.includes('ì¢…ì†Œì„¸') || col.includes('ì†Œë“ì„¸')) || columns[5],
                    prepaidLocalTax: columns.find(col => col.includes('ì§€ë°©') && col.includes('ì†Œë“ì„¸')) || columns[6],
                    transferDate: columns.find(col => col.includes('ì–‘ë„ì¼') || col.includes('ë§¤ë„ì¼')) || columns[7]
                };
                
                document.getElementById('output').innerHTML += '<h3>ì»¬ëŸ¼ ë§¤í•‘:</h3>';
                document.getElementById('output').innerHTML += `<pre>${JSON.stringify(columnMapping, null, 2)}</pre>`;
                
                // 1-20ë²ˆ ë°ì´í„° ì¶”ì¶œ
                const mappedData = jsonData.slice(0, 20).map((row, idx) => {
                    return {
                        'ì‚¬ì—…ìë²ˆí˜¸*': row[columnMapping.businessNumber] || '',
                        'ë¬¼ê±´ëª…': row[columnMapping.propertyName] || `ë¬¼ê±´${idx + 1}`,
                        'ì†Œì¬ì§€': row[columnMapping.address] || '',
                        'ì·¨ë“ê°€ì•¡': row[columnMapping.acquisitionValue] || 0,
                        'ê¸°íƒ€í•„ìš”ê²½ë¹„': 0,
                        'ì–‘ë„ê°€ì•¡': row[columnMapping.transferValue] || 0,
                        'ì²˜ë¶„ë¹„': 0,
                        'ì–‘ë„ì†Œë“': '',
                        'ì–‘ë„ì¼(YYYYMMDD)': row[columnMapping.transferDate] || '',
                        'ì‹ ê³ ê¸°í•œ': '',
                        'ê¸°ë‚©ë¶€ ì¢…ì†Œì„¸': row[columnMapping.prepaidIncomeTax] || 0,
                        'ê¸°ë‚©ë¶€ ì§€ë°©ì†Œë“ì„¸': row[columnMapping.prepaidLocalTax] || 0,
                        '85ì´ˆê³¼(Y/N)': 'N',
                        'ì§„í–‰ë‹¨ê³„': 'ë¯¸í™•ì¸',
                        'ë¹„ê³ ': ''
                    };
                });
                
                document.getElementById('output').innerHTML += '<h3>ë³€í™˜ëœ ë°ì´í„° (ì²˜ìŒ 5ê°œ):</h3>';
                document.getElementById('output').innerHTML += `<pre>${JSON.stringify(mappedData.slice(0, 5), null, 2)}</pre>`;
                
                // ì—‘ì…€ íŒŒì¼ ìƒì„±
                const wb = XLSX.utils.book_new();
                
                // Sheet 1: ë¬¼ê±´ëª©ë¡
                const ws1 = XLSX.utils.json_to_sheet(mappedData);
                XLSX.utils.book_append_sheet(wb, ws1, 'ë¬¼ê±´ëª©ë¡');
                
                // Sheet 2: í•„ìš”ê²½ë¹„ìƒì„¸ (ë¹ˆ ì‹œíŠ¸)
                const expenseData = [
                    ['ì‚¬ì—…ìë²ˆí˜¸*', 'ë¬¼ê±´ëª…*', 'ë²ˆí˜¸', 'ë¹„ìš©ëª…', 'êµ¬ë¶„(ì·¨ë“ê°€ì•¡/ê¸°íƒ€í•„ìš”ê²½ë¹„)', 'ê¸ˆì•¡', 'ë¹„ìš©ì¸ì •(O/X)', 'ë¹„ê³ ']
                ];
                const ws2 = XLSX.utils.aoa_to_sheet(expenseData);
                XLSX.utils.book_append_sheet(wb, ws2, 'í•„ìš”ê²½ë¹„ìƒì„¸');
                
                // ë‹¤ìš´ë¡œë“œ
                XLSX.writeFile(wb, `ë§¤ë§¤ì‚¬ì—…ì_ì¼ê´„ì—…ë¡œë“œ_ì–‘ì‹_ë³€í™˜_${new Date().toISOString().slice(0,10)}.xlsx`);
                
                document.getElementById('output').innerHTML += '<h2 style="color: green;">âœ… íŒŒì¼ ë³€í™˜ ì™„ë£Œ! ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë©ë‹ˆë‹¤.</h2>';
                
            } catch (error) {
                document.getElementById('output').innerHTML += `<p style="color: red;">ë³€í™˜ ì˜¤ë¥˜: ${error.message}</p>`;
                console.error(error);
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
        window.onload = autoAnalyze;
    </script>
</body>
</html>
