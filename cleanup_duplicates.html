<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¤‘ë³µ ë°ì´í„° ì •ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div style="max-width: 1200px; margin: 40px auto; padding: 0 20px;">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-broom mr-2"></i>ì¤‘ë³µ ë°ì´í„° ì •ë¦¬ (ì‚¬ì—…ìë²ˆí˜¸ ê¸°ì¤€)
                </h2>
            </div>
            
            <div style="padding: 24px;">
                <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 16px; margin-bottom: 24px; border-radius: 4px;">
                    <p style="color: #92400e; font-weight: 600; margin-bottom: 8px;">
                        <i class="fas fa-exclamation-triangle mr-2"></i>ê²½ê³ 
                    </p>
                    <p style="color: #92400e; font-size: 14px;">
                        ì‚¬ì—…ìë²ˆí˜¸ê°€ ë™ì¼í•œ ì¤‘ë³µ ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•©ë‹ˆë‹¤.<br>
                        ê° ì‚¬ì—…ìë²ˆí˜¸ë‹¹ ê°€ì¥ ìµœê·¼ì— ë“±ë¡ëœ ë°ì´í„° 1ê°œë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ëŠ” ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.<br>
                        <strong>ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!</strong>
                    </p>
                </div>
                
                <div style="text-align: center; margin: 40px 0;">
                    <button id="startCleanup" class="btn btn-danger" style="font-size: 18px; padding: 16px 32px;">
                        <i class="fas fa-broom mr-2"></i>ì¤‘ë³µ ë°ì´í„° ì •ë¦¬ ì‹œì‘
                    </button>
                </div>
                
                <div id="progressContainer" style="display: none;">
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: #374151;">ì§„í–‰ ìƒí™©</span>
                            <span id="progressText" style="font-weight: 600; color: #ef4444;">0 / 0</span>
                        </div>
                        <div style="background: #e5e7eb; height: 24px; border-radius: 12px; overflow: hidden;">
                            <div id="progressBar" style="background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%); height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    
                    <div id="logContainer" style="background: #1f2937; color: #e5e7eb; padding: 16px; border-radius: 8px; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 13px;">
                        <div id="logs"></div>
                    </div>
                </div>
                
                <div id="resultContainer" style="display: none; margin-top: 24px;">
                    <div style="background: #d1fae5; border-left: 4px solid #059669; padding: 16px; border-radius: 4px; margin-bottom: 16px;">
                        <p style="color: #047857; font-weight: 600; margin-bottom: 8px;">
                            <i class="fas fa-check-circle mr-2"></i>ì •ë¦¬ ì™„ë£Œ!
                        </p>
                        <p style="color: #047857; font-size: 14px;" id="resultMessage"></p>
                    </div>
                    
                    <div style="text-align: center;">
                        <a href="clients.html" class="btn btn-primary">
                            <i class="fas fa-list mr-2"></i>ê³ ê°ì‚¬ ëª©ë¡ ë³´ê¸°
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script>
        let isProcessing = false;
        let deletedCount = 0;
        let keptCount = 0;

        function addLog(message, type = 'info') {
            const logsContainer = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            const colors = {
                info: '#60a5fa',
                success: '#34d399',
                warning: '#fbbf24',
                error: '#f87171'
            };
            const icons = {
                info: 'info-circle',
                success: 'check-circle',
                warning: 'exclamation-triangle',
                error: 'times-circle'
            };
            
            const logEntry = document.createElement('div');
            logEntry.style.marginBottom = '4px';
            logEntry.innerHTML = `<span style="color: #9ca3af;">[${timestamp}]</span> <i class="fas fa-${icons[type]}" style="color: ${colors[type]};"></i> ${message}`;
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function updateProgress(current, total) {
            const percent = Math.round((current / total) * 100);
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = `${current} / ${total}`;
        }

        async function cleanupDuplicates() {
            if (isProcessing) return;
            
            if (!confirm('ì •ë§ë¡œ ì¤‘ë³µ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!')) {
                return;
            }
            
            isProcessing = true;
            document.getElementById('startCleanup').disabled = true;
            document.getElementById('progressContainer').style.display = 'block';
            
            try {
                addLog('ë°ì´í„° ë¡œë”© ì¤‘...', 'info');
                const response = await API.getClients();
                const allClients = response.data || [];
                addLog(`ì´ ${allClients.length}ê°œì˜ ê³ ê°ì‚¬ ë°œê²¬`, 'info');
                
                // Group by business_number
                const businessNumberMap = new Map();
                
                allClients.forEach(client => {
                    const businessNumber = client.business_number?.trim();
                    
                    // Skip if no business number
                    if (!businessNumber || businessNumber === '') {
                        addLog(`âš ï¸ ${client.company_name}: ì‚¬ì—…ìë²ˆí˜¸ ì—†ìŒ (ìœ ì§€)`, 'warning');
                        keptCount++;
                        return;
                    }
                    
                    if (!businessNumberMap.has(businessNumber)) {
                        businessNumberMap.set(businessNumber, []);
                    }
                    businessNumberMap.get(businessNumber).push(client);
                });
                
                addLog(`${businessNumberMap.size}ê°œì˜ ê³ ìœ  ì‚¬ì—…ìë²ˆí˜¸ ë°œê²¬`, 'success');
                
                // Find duplicates
                const duplicatesToDelete = [];
                
                businessNumberMap.forEach((clients, businessNumber) => {
                    if (clients.length > 1) {
                        // Sort by created_at (most recent first)
                        clients.sort((a, b) => {
                            const dateA = new Date(a.created_at || 0).getTime();
                            const dateB = new Date(b.created_at || 0).getTime();
                            return dateB - dateA;
                        });
                        
                        // Keep the first (most recent), delete the rest
                        const toKeep = clients[0];
                        const toDelete = clients.slice(1);
                        
                        addLog(`ğŸ“‹ ì‚¬ì—…ìë²ˆí˜¸ ${businessNumber}: ${clients.length}ê°œ ì¤‘ë³µ ë°œê²¬`, 'warning');
                        addLog(`  âœ“ ìœ ì§€: ${toKeep.company_name} (${toKeep.number})`, 'success');
                        
                        toDelete.forEach(client => {
                            addLog(`  âœ— ì‚­ì œ: ${client.company_name} (${client.number})`, 'error');
                            duplicatesToDelete.push(client);
                        });
                        
                        keptCount++;
                    } else {
                        // No duplicates
                        keptCount++;
                    }
                });
                
                if (duplicatesToDelete.length === 0) {
                    addLog('ì¤‘ë³µ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!', 'success');
                    showResult(0, keptCount);
                    return;
                }
                
                addLog(`${duplicatesToDelete.length}ê°œì˜ ì¤‘ë³µ ë°ì´í„° ì‚­ì œ ì‹œì‘...`, 'warning');
                
                // Delete duplicates
                let processed = 0;
                const total = duplicatesToDelete.length;
                
                for (const client of duplicatesToDelete) {
                    try {
                        await API.deleteClient(client.id);
                        deletedCount++;
                        processed++;
                        addLog(`âœ“ ${client.company_name} ì‚­ì œ ì™„ë£Œ`, 'success');
                        updateProgress(processed, total);
                    } catch (error) {
                        addLog(`âœ— ${client.company_name} ì‚­ì œ ì‹¤íŒ¨: ${error.message}`, 'error');
                        processed++;
                        updateProgress(processed, total);
                    }
                    
                    // Small delay to prevent overwhelming the API
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                addLog('ì •ë¦¬ ì™„ë£Œ!', 'success');
                showResult(deletedCount, keptCount);
                
            } catch (error) {
                console.error('Cleanup error:', error);
                addLog(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
            } finally {
                isProcessing = false;
            }
        }

        function showResult(deleted, kept) {
            document.getElementById('resultContainer').style.display = 'block';
            document.getElementById('resultMessage').innerHTML = `
                ì‚­ì œëœ ì¤‘ë³µ ë°ì´í„°: <strong>${deleted}ê°œ</strong><br>
                ìœ ì§€ëœ ê³ ê°ì‚¬: <strong>${kept}ê°œ</strong><br>
                <strong>ì¤‘ë³µ ì œê±° ì™„ë£Œ!</strong>
            `;
        }

        document.getElementById('startCleanup').addEventListener('click', cleanupDuplicates);
    </script>
</body>
</html>
