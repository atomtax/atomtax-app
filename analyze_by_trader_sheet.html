<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê¸°ì¥ì´ê´„í‘œ ìƒì„¸ ë¶„ì„ (ê±°ë˜ì²˜ë³„ ì‹œíŠ¸)</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 30px;
        }
        h1 {
            color: #667eea;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        h2 {
            color: #374151;
            margin: 20px 0 10px;
            background: #f3f4f6;
            padding: 10px;
            border-radius: 5px;
        }
        .sheet-card {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
        .sheet-card.highlighted {
            border-color: #10b981;
            background: #d1fae5;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 11px;
        }
        th, td {
            border: 1px solid #d1d5db;
            padding: 6px;
            text-align: left;
        }
        th {
            background: #4b5563;
            color: white;
            font-weight: 600;
        }
        tr:nth-child(even) { background: #f9fafb; }
        pre {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 11px;
            max-height: 400px;
        }
        .info {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .success {
            background: #d1fae5;
            border-left: 4px solid #10b981;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin: 10px 5px;
        }
        .btn:hover { background: #5568d3; }
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .data-item {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 10px;
            border-radius: 5px;
        }
        .data-item strong {
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ê¸°ì¥ì´ê´„í‘œ ìƒì„¸ ë¶„ì„ (ê±°ë˜ì²˜ë³„ ì‹œíŠ¸)</h1>
        
        <div class="info">
            <strong>ğŸ“Œ ë¶„ì„ ëª©ì :</strong> ê° ì‹œíŠ¸ê°€ ê±°ë˜ì²˜ëª…ìœ¼ë¡œ ë˜ì–´ìˆê³ , ê° ì‹œíŠ¸ ì•ˆì— ë¬¼ê±´ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
        </div>
        
        <div id="output">
            <p>íŒŒì¼ì„ ë¡œë“œí•˜ëŠ” ì¤‘...</p>
        </div>
        
        <div id="conversionSection" style="display: none;">
            <h2>ğŸ”„ ë³€í™˜ ì‘ì—…</h2>
            <button class="btn" onclick="convertAllSheets()">âœ¨ ëª¨ë“  ê±°ë˜ì²˜ ë°ì´í„° ë³€í™˜ ì‹œì‘</button>
            <div id="convertOutput"></div>
        </div>
    </div>

    <script>
        let workbookData = null;
        let traderSheets = [];

        async function init() {
            const output = document.getElementById('output');
            
            try {
                output.innerHTML = '<div class="info"><strong>ğŸ”„ íŒŒì¼ ë¡œë“œ ì¤‘...</strong></div>';
                
                const response = await fetch('ê¸°ì¥ì´ê´„í‘œ_ì›ë³¸.xlsx');
                if (!response.ok) throw new Error('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(new Uint8Array(arrayBuffer), {type: 'array', cellDates: true});
                
                workbookData = workbook;
                
                output.innerHTML = `<div class="success"><strong>âœ… íŒŒì¼ ë¡œë“œ ì™„ë£Œ</strong><br>ì´ ì‹œíŠ¸ ìˆ˜: ${workbook.SheetNames.length}ê°œ</div>`;
                
                // ê° ì‹œíŠ¸ ìƒì„¸ ë¶„ì„
                output.innerHTML += '<h2>ğŸ“Š ê° ì‹œíŠ¸ ìƒì„¸ ë¶„ì„</h2>';
                
                workbook.SheetNames.forEach((sheetName, idx) => {
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonArray = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: ''});
                    const jsonObjects = XLSX.utils.sheet_to_json(worksheet, {defval: ''});
                    
                    // ì‹œíŠ¸ ë¶„ì„
                    const analysis = analyzeSheet(sheetName, jsonArray, jsonObjects);
                    
                    let html = `<div class="sheet-card ${analysis.isTradingSheet ? 'highlighted' : ''}">
                        <h3>${idx + 1}. ${sheetName} ${analysis.isTradingSheet ? 'âœ… (ë§¤ë§¤ì‚¬ì—…ì ì‹œíŠ¸)' : ''}</h3>
                        <div class="data-grid">
                            <div class="data-item"><strong>í–‰ ìˆ˜:</strong> ${jsonArray.length}</div>
                            <div class="data-item"><strong>ë°ì´í„° í–‰:</strong> ${jsonObjects.length}</div>
                            <div class="data-item"><strong>ì»¬ëŸ¼ ìˆ˜:</strong> ${jsonArray[0] ? jsonArray[0].length : 0}</div>
                        </div>`;
                    
                    if (jsonArray.length > 0) {
                        html += '<h4>ğŸ“‹ ì»¬ëŸ¼ ëª©ë¡:</h4>';
                        html += '<div style="background: #f3f4f6; padding: 10px; border-radius: 5px; font-size: 12px;">';
                        jsonArray[0].forEach((col, i) => {
                            html += `<span style="margin-right: 10px;"><strong>${i + 1}.</strong> ${col || '(ë¹ˆì¹¸)'}</span>`;
                        });
                        html += '</div>';
                        
                        html += '<h4>ğŸ“„ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (ì²˜ìŒ 10í–‰):</h4>';
                        html += '<div style="overflow-x: auto;"><table>';
                        html += '<thead><tr>';
                        jsonArray[0].forEach(h => {
                            html += `<th>${h || ''}</th>`;
                        });
                        html += '</tr></thead><tbody>';
                        jsonArray.slice(1, 11).forEach(row => {
                            html += '<tr>';
                            row.forEach(cell => {
                                html += `<td>${cell || ''}</td>`;
                            });
                            html += '</tr>';
                        });
                        html += '</tbody></table></div>';
                        
                        // JSON ìƒ˜í”Œ
                        if (jsonObjects.length > 0) {
                            html += '<h4>ğŸ” JSON í˜•ì‹ (ì²˜ìŒ 3ê°œ):</h4>';
                            html += `<pre>${JSON.stringify(jsonObjects.slice(0, 3), null, 2)}</pre>`;
                        }
                    }
                    
                    // ë¶„ì„ ê²°ê³¼
                    if (analysis.possibleColumns.length > 0) {
                        html += '<div class="success">';
                        html += '<h4>ğŸ¯ ê°ì§€ëœ ì»¬ëŸ¼:</h4><ul>';
                        analysis.possibleColumns.forEach(col => {
                            html += `<li><strong>${col.name}:</strong> ${col.column} (ì¸ë±ìŠ¤ ${col.index})</li>`;
                        });
                        html += '</ul></div>';
                    }
                    
                    html += '</div>';
                    
                    output.innerHTML += html;
                    
                    // ë§¤ë§¤ì‚¬ì—…ì ì‹œíŠ¸ë©´ ì €ì¥
                    if (analysis.isTradingSheet) {
                        traderSheets.push({
                            name: sheetName,
                            data: jsonObjects,
                            headers: jsonArray[0] || [],
                            analysis: analysis
                        });
                    }
                });
                
                // ë³€í™˜ ê°€ëŠ¥í•œ ì‹œíŠ¸ ìš”ì•½
                if (traderSheets.length > 0) {
                    output.innerHTML += `<div class="success">
                        <h3>âœ… ë§¤ë§¤ì‚¬ì—…ì ì‹œíŠ¸ ë°œê²¬: ${traderSheets.length}ê°œ</h3>
                        <p>ë‹¤ìŒ ì‹œíŠ¸ë“¤ì´ ë³€í™˜ ëŒ€ìƒì…ë‹ˆë‹¤:</p>
                        <ul>${traderSheets.map(s => `<li><strong>${s.name}</strong> (${s.data.length}ê°œ ë°ì´í„°)</li>`).join('')}</ul>
                    </div>`;
                    
                    document.getElementById('conversionSection').style.display = 'block';
                } else {
                    output.innerHTML += `<div class="warning">
                        <strong>âš ï¸ ë§¤ë§¤ì‚¬ì—…ì ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</strong>
                        <p>ê° ì‹œíŠ¸ì˜ ì»¬ëŸ¼ êµ¬ì¡°ë¥¼ í™•ì¸í•˜ê³ , ì–´ë–¤ ì‹œíŠ¸ë¥¼ ë³€í™˜í•´ì•¼ í•˜ëŠ”ì§€ ì•Œë ¤ì£¼ì„¸ìš”.</p>
                    </div>`;
                }
                
            } catch (error) {
                output.innerHTML = `<div style="background: #fee2e2; border-left: 4px solid #ef4444; padding: 15px; border-radius: 5px;">
                    <strong>âŒ ì˜¤ë¥˜:</strong> ${error.message}
                </div>`;
                console.error(error);
            }
        }

        function analyzeSheet(sheetName, jsonArray, jsonObjects) {
            const headers = jsonArray[0] || [];
            const possibleColumns = [];
            let isTradingSheet = false;
            
            headers.forEach((header, idx) => {
                const h = String(header).toLowerCase().replace(/\s/g, '');
                
                // ë§¤ë§¤ì‚¬ì—…ì ê´€ë ¨ ì»¬ëŸ¼ ê°ì§€
                if (h.includes('ì‚¬ì—…ì') || h.includes('ë²ˆí˜¸')) {
                    possibleColumns.push({name: 'ì‚¬ì—…ìë²ˆí˜¸', column: header, index: idx});
                    isTradingSheet = true;
                }
                if (h.includes('ë¬¼ê±´') || h.includes('ë¶€ë™ì‚°') || h.includes('ëª…ì¹­')) {
                    possibleColumns.push({name: 'ë¬¼ê±´ëª…', column: header, index: idx});
                }
                if (h.includes('ì†Œì¬ì§€') || h.includes('ì£¼ì†Œ')) {
                    possibleColumns.push({name: 'ì†Œì¬ì§€', column: header, index: idx});
                }
                if (h.includes('ì·¨ë“') && (h.includes('ê°€ì•¡') || h.includes('ê¸ˆì•¡'))) {
                    possibleColumns.push({name: 'ì·¨ë“ê°€ì•¡', column: header, index: idx});
                }
                if (h.includes('ì–‘ë„') && (h.includes('ê°€ì•¡') || h.includes('ê¸ˆì•¡'))) {
                    possibleColumns.push({name: 'ì–‘ë„ê°€ì•¡', column: header, index: idx});
                }
                if (h.includes('ì¢…ì†Œì„¸') || (h.includes('ì†Œë“ì„¸') && !h.includes('ì§€ë°©'))) {
                    possibleColumns.push({name: 'ê¸°ë‚©ë¶€ ì¢…ì†Œì„¸', column: header, index: idx});
                }
                if (h.includes('ì§€ë°©') && h.includes('ì†Œë“ì„¸')) {
                    possibleColumns.push({name: 'ê¸°ë‚©ë¶€ ì§€ë°©ì†Œë“ì„¸', column: header, index: idx});
                }
                if (h.includes('ì·¨ë“ì¼') || h.includes('ì·¨ë“ë…„ì›”ì¼')) {
                    possibleColumns.push({name: 'ì·¨ë“ì¼', column: header, index: idx});
                }
                if (h.includes('ì–‘ë„ì¼') || h.includes('ë§¤ë„ì¼')) {
                    possibleColumns.push({name: 'ì–‘ë„ì¼', column: header, index: idx});
                }
            });
            
            return {
                isTradingSheet,
                possibleColumns,
                dataCount: jsonObjects.length
            };
        }

        async function convertAllSheets() {
            const output = document.getElementById('convertOutput');
            output.innerHTML = '<div class="info"><strong>ğŸ”„ ë³€í™˜ ì‘ì—… ì‹œì‘...</strong></div>';
            
            try {
                const allConvertedData = [];
                
                traderSheets.forEach(sheet => {
                    output.innerHTML += `<h3>ğŸ“Š ${sheet.name} ë³€í™˜ ì¤‘...</h3>`;
                    
                    // ì»¬ëŸ¼ ë§¤í•‘
                    const mapping = {};
                    sheet.analysis.possibleColumns.forEach(col => {
                        if (col.name === 'ì‚¬ì—…ìë²ˆí˜¸') mapping.businessNumber = col.index;
                        if (col.name === 'ë¬¼ê±´ëª…') mapping.propertyName = col.index;
                        if (col.name === 'ì†Œì¬ì§€') mapping.address = col.index;
                        if (col.name === 'ì–‘ë„ê°€ì•¡') mapping.transferValue = col.index;
                        if (col.name === 'ê¸°ë‚©ë¶€ ì¢…ì†Œì„¸') mapping.prepaidIncomeTax = col.index;
                        if (col.name === 'ê¸°ë‚©ë¶€ ì§€ë°©ì†Œë“ì„¸') mapping.prepaidLocalTax = col.index;
                        if (col.name === 'ì·¨ë“ì¼') mapping.acquisitionDate = col.index;
                        if (col.name === 'ì–‘ë„ì¼') mapping.transferDate = col.index;
                    });
                    
                    // ë°ì´í„° ë³€í™˜
                    sheet.data.forEach((row, idx) => {
                        const rowArray = sheet.headers.map(h => row[h]);
                        const converted = {
                            'ì‚¬ì—…ìë²ˆí˜¸*': String(rowArray[mapping.businessNumber] || '').trim(),
                            'ë¬¼ê±´ëª…': rowArray[mapping.propertyName] || `${sheet.name}_ë¬¼ê±´${idx + 1}`,
                            'ì†Œì¬ì§€': rowArray[mapping.address] || '',
                            'ì–‘ë„ê°€ì•¡': parseNumber(rowArray[mapping.transferValue]),
                            'ì·¨ë“ì¼(YYYYMMDD)': formatDate(rowArray[mapping.acquisitionDate]),
                            'ì–‘ë„ì¼(YYYYMMDD)': formatDate(rowArray[mapping.transferDate]),
                            'ê¸°ë‚©ë¶€ ì¢…ì†Œì„¸': parseNumber(rowArray[mapping.prepaidIncomeTax]),
                            'ê¸°ë‚©ë¶€ ì§€ë°©ì†Œë“ì„¸': parseNumber(rowArray[mapping.prepaidLocalTax]),
                            '85ì´ˆê³¼(Y/N)': 'N',
                            'ì§„í–‰ë‹¨ê³„': 'ë¯¸í™•ì¸'
                        };
                        
                        if (converted['ì‚¬ì—…ìë²ˆí˜¸*']) {
                            allConvertedData.push(converted);
                        }
                    });
                    
                    output.innerHTML += `<div class="success">âœ… ${sheet.name}: ${sheet.data.length}ê±´ ë³€í™˜ ì™„ë£Œ</div>`;
                });
                
                output.innerHTML += `<div class="success">
                    <h3>âœ… ì „ì²´ ë³€í™˜ ì™„ë£Œ!</h3>
                    <p>ì´ ${allConvertedData.length}ê±´ì˜ ë°ì´í„°ê°€ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                </div>`;
                
                // ë¯¸ë¦¬ë³´ê¸°
                output.innerHTML += '<h3>ğŸ“‹ ë³€í™˜ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° (ì²˜ìŒ 10ê°œ):</h3>';
                output.innerHTML += `<pre>${JSON.stringify(allConvertedData.slice(0, 10), null, 2)}</pre>`;
                
                // ì—‘ì…€ ìƒì„±
                const wb = XLSX.utils.book_new();
                const ws1 = XLSX.utils.json_to_sheet(allConvertedData);
                XLSX.utils.book_append_sheet(wb, ws1, 'ë¬¼ê±´ëª©ë¡');
                
                const ws2 = XLSX.utils.aoa_to_sheet([
                    ['ì‚¬ì—…ìë²ˆí˜¸*', 'ë¬¼ê±´ëª…*', 'ë²ˆí˜¸', 'ë¹„ìš©ëª…', 'êµ¬ë¶„(ì·¨ë“ê°€ì•¡/ê¸°íƒ€í•„ìš”ê²½ë¹„)', 'ê¸ˆì•¡', 'ë¹„ìš©ì¸ì •(O/X)', 'ë¹„ê³ ']
                ]);
                XLSX.utils.book_append_sheet(wb, ws2, 'í•„ìš”ê²½ë¹„ìƒì„¸');
                
                // ë‹¤ìš´ë¡œë“œ
                const fileName = `ë§¤ë§¤ì‚¬ì—…ì_ì¼ê´„ì—…ë¡œë“œ_ì–‘ì‹_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                output.innerHTML += `<div class="success">
                    <h3>ğŸ‰ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!</h3>
                    <p><strong>íŒŒì¼ëª…:</strong> ${fileName}</p>
                    <p>ì´ì œ ë§¤ë§¤ì‚¬ì—…ì ë°ì´í„° í˜ì´ì§€ì—ì„œ "ì¼ê´„ ì—…ë¡œë“œ"ë¥¼ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”!</p>
                </div>`;
                
            } catch (error) {
                output.innerHTML += `<div style="background: #fee2e2; border-left: 4px solid #ef4444; padding: 15px;">
                    <strong>âŒ ë³€í™˜ ì˜¤ë¥˜:</strong> ${error.message}
                </div>`;
                console.error(error);
            }
        }

        function parseNumber(value) {
            if (!value) return 0;
            const num = String(value).replace(/[^0-9.-]/g, '');
            return parseFloat(num) || 0;
        }

        function formatDate(dateValue) {
            if (!dateValue) return '';
            
            const str = String(dateValue).replace(/[^0-9]/g, '');
            if (str.length === 8) return str;
            
            if (dateValue instanceof Date) {
                const y = dateValue.getFullYear();
                const m = String(dateValue.getMonth() + 1).padStart(2, '0');
                const d = String(dateValue.getDate()).padStart(2, '0');
                return `${y}${m}${d}`;
            }
            
            return '';
        }

        window.onload = init;
    </script>
</body>
</html>
