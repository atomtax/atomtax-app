<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>LocalStorage 디버깅</title>
    <style>
        body { font-family: 'Courier New', monospace; padding: 20px; background: #f5f5f5; }
        .section { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h2 { color: #667eea; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; }
        .btn { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #5568d3; }
    </style>
</head>
<body>
    <h1>LocalStorage 디버깅 도구</h1>
    
    <div class="section">
        <h2>1. 모든 LocalStorage 키 확인</h2>
        <button class="btn" onclick="showAllKeys()">키 목록 보기</button>
        <pre id="allKeys"></pre>
    </div>
    
    <div class="section">
        <h2>2. trader_inventory 데이터 확인</h2>
        <button class="btn" onclick="showInventoryData()">인벤토리 데이터 보기</button>
        <pre id="inventoryData"></pre>
    </div>
    
    <div class="section">
        <h2>3. 고객사 데이터 확인</h2>
        <button class="btn" onclick="checkClients()">고객사 확인</button>
        <pre id="clientsData"></pre>
    </div>
    
    <div class="section">
        <h2>4. 테스트 데이터 생성</h2>
        <button class="btn" onclick="createTestData()">테스트 데이터 생성</button>
        <pre id="testResult"></pre>
    </div>

    <script>
        function showAllKeys() {
            const keys = Object.keys(localStorage);
            const result = document.getElementById('allKeys');
            result.textContent = `총 ${keys.length}개의 키:\n\n`;
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                result.textContent += `${key}:\n`;
                result.textContent += `  크기: ${value.length} 문자\n`;
                if (key.includes('trader_inventory')) {
                    result.textContent += `  내용 미리보기: ${value.substring(0, 100)}...\n`;
                }
                result.textContent += '\n';
            });
        }
        
        function showInventoryData() {
            const result = document.getElementById('inventoryData');
            const keys = Object.keys(localStorage).filter(k => k.includes('trader_inventory'));
            
            if (keys.length === 0) {
                result.textContent = 'trader_inventory 데이터가 없습니다!';
                return;
            }
            
            result.textContent = '';
            keys.forEach(key => {
                result.textContent += `\n=== ${key} ===\n\n`;
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    result.textContent += `총 ${data.length}개 항목:\n\n`;
                    data.forEach((item, idx) => {
                        result.textContent += `항목 ${idx + 1}:\n`;
                        result.textContent += `  물건명: ${item.property_name || '(없음)'}\n`;
                        result.textContent += `  진행단계: ${item.progress_status || '(없음)'}\n`;
                        result.textContent += `  양도일: ${item.transfer_date || '(없음)'}\n`;
                        result.textContent += `  85초과: ${item.over_85 || '(없음)'}\n`;
                        result.textContent += '\n';
                    });
                } catch (e) {
                    result.textContent += `파싱 오류: ${e.message}\n`;
                }
            });
        }
        
        async function checkClients() {
            const result = document.getElementById('clientsData');
            result.textContent = '고객사 데이터 로딩 중...\n';
            
            try {
                const response = await fetch('tables/clients?limit=1000');
                const data = await response.json();
                const clients = data.data || [];
                
                result.textContent = `총 ${clients.length}개 고객사\n\n`;
                
                const traders = clients.filter(c => {
                    const code = (c.business_code || '').trim();
                    return code === '703011' || code === '703012';
                });
                
                result.textContent += `매매사업자 (703011/703012): ${traders.length}개\n\n`;
                
                traders.forEach(t => {
                    result.textContent += `${t.company_name} (ID: ${t.id})\n`;
                    result.textContent += `  업종코드: ${t.business_code}\n`;
                    result.textContent += `  담당자: ${t.manager || '(없음)'}\n`;
                    
                    const storageKey = `trader_inventory_${t.id}`;
                    const hasData = localStorage.getItem(storageKey);
                    result.textContent += `  localStorage: ${hasData ? '있음 ✓' : '없음 ✗'}\n`;
                    result.textContent += '\n';
                });
            } catch (e) {
                result.textContent += `오류: ${e.message}`;
            }
        }
        
        async function createTestData() {
            const result = document.getElementById('testResult');
            
            try {
                // Get first trader
                const response = await fetch('tables/clients?limit=1000');
                const data = await response.json();
                const clients = data.data || [];
                
                const traders = clients.filter(c => {
                    const code = (c.business_code || '').trim();
                    return code === '703011' || code === '703012';
                });
                
                if (traders.length === 0) {
                    result.textContent = '매매사업자가 없습니다. 먼저 업종코드 703011 또는 703012인 고객사를 추가하세요.';
                    return;
                }
                
                const testTrader = traders[0];
                const storageKey = `trader_inventory_${testTrader.id}`;
                
                // Create test data
                const testData = [
                    {
                        property_name: '테스트물건1',
                        address: '서울시 강남구',
                        acquisition_value: 300000000,
                        other_expenses: 10000000,
                        transfer_value: 400000000,
                        transfer_income: 90000000,
                        transfer_date: '2024-12-15',
                        report_deadline: '2025-02-28',
                        over_85: 'Y',
                        progress_status: '확인',
                        expenses: []
                    },
                    {
                        property_name: '테스트물건2',
                        address: '서울시 서초구',
                        acquisition_value: 250000000,
                        other_expenses: 8000000,
                        transfer_value: 350000000,
                        transfer_income: 92000000,
                        transfer_date: '2024-11-20',
                        report_deadline: '2025-01-31',
                        over_85: 'N',
                        progress_status: '신고완료',
                        expenses: []
                    },
                    {
                        property_name: '테스트물건3',
                        address: '서울시 송파구',
                        acquisition_value: 280000000,
                        other_expenses: 9000000,
                        transfer_value: 380000000,
                        transfer_income: 91000000,
                        transfer_date: '2024-10-10',
                        report_deadline: '2024-12-31',
                        over_85: 'Y',
                        progress_status: '위하고입력',
                        expenses: []
                    }
                ];
                
                localStorage.setItem(storageKey, JSON.stringify(testData));
                
                result.textContent = `테스트 데이터 생성 완료!\n\n`;
                result.textContent += `고객사: ${testTrader.company_name}\n`;
                result.textContent += `Storage Key: ${storageKey}\n`;
                result.textContent += `생성된 물건: ${testData.length}개\n\n`;
                result.textContent += `진행단계:\n`;
                result.textContent += `  - 확인: 1개\n`;
                result.textContent += `  - 위하고입력: 1개\n`;
                result.textContent += `  - 신고완료: 1개\n\n`;
                result.textContent += `이제 체크리스트 페이지에서 "동기화" 버튼을 클릭하세요!`;
                
            } catch (e) {
                result.textContent = `오류: ${e.message}`;
            }
        }
        
        // Auto load on page open
        window.onload = () => {
            showAllKeys();
            showInventoryData();
        };
    </script>
</body>
</html>
