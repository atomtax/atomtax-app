<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ğŸ”¥ ê¸°ì¥ì´ê´„í‘œ ì™„ì „ ìë™ ë³€í™˜</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
        }
        .status {
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 5px solid #667eea;
        }
        .status.loading { background: #dbeafe; border-color: #3b82f6; }
        .status.success { background: #d1fae5; border-color: #10b981; }
        .status.error { background: #fee2e2; border-color: #ef4444; }
        .status h3 { margin-bottom: 10px; color: #1f2937; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 11px;
            background: white;
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 8px;
            text-align: left;
        }
        th {
            background: #667eea;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        tr:nth-child(even) { background: #f9fafb; }
        tr:hover { background: #f3f4f6; }
        .btn {
            display: inline-block;
            padding: 16px 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            margin: 20px 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        pre {
            background: #1f2937;
            color: #10b981;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.6;
        }
        .sheet-tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .sheet-tab {
            padding: 10px 20px;
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .sheet-tab:hover { background: #e5e7eb; }
        .sheet-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }
        .download-section {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-radius: 12px;
            margin-top: 30px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #bae6fd;
        }
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #0369a1;
        }
        .stat-label {
            color: #075985;
            margin-top: 5px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¥ ê¸°ì¥ì´ê´„í‘œ â†’ ì¼ê´„ì—…ë¡œë“œ ì–‘ì‹ ì™„ì „ ìë™ ë³€í™˜</h1>
        
        <div id="output"></div>
        
        <div id="downloadSection" style="display: none;">
            <div class="download-section">
                <h2 style="color: #065f46; margin-bottom: 20px;">âœ… ë³€í™˜ ì™„ë£Œ!</h2>
                <button class="btn" onclick="downloadExcel()">
                    ğŸ“¥ ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ (ì¼ê´„ì—…ë¡œë“œ ì–‘ì‹)
                </button>
                <p style="margin-top: 15px; color: #047857; font-weight: 600;">
                    ì´ì œ ë§¤ë§¤ì‚¬ì—…ì ë°ì´í„° í˜ì´ì§€ì—ì„œ "ì¼ê´„ ì—…ë¡œë“œ" í•˜ì„¸ìš”!
                </p>
            </div>
        </div>
    </div>

    <script>
        let finalWorkbook = null;
        let allSheetData = {};

        async function init() {
            const output = document.getElementById('output');
            
            try {
                output.innerHTML = '<div class="status loading"><h3>ğŸ”„ íŒŒì¼ ë¡œë“œ ì¤‘...</h3></div>';
                
                const response = await fetch('ê¸°ì¥ì´ê´„í‘œ_ì›ë³¸.xlsx');
                if (!response.ok) throw new Error('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(new Uint8Array(arrayBuffer), {type: 'array', cellDates: true});
                
                output.innerHTML += '<div class="status success"><h3>âœ… íŒŒì¼ ë¡œë“œ ì™„ë£Œ</h3><p>ì‹œíŠ¸ ê°œìˆ˜: ' + workbook.SheetNames.length + 'ê°œ</p></div>';
                
                // í†µê³„
                let html = '<div class="stats">';
                html += `<div class="stat-card"><div class="stat-number">${workbook.SheetNames.length}</div><div class="stat-label">ì´ ì‹œíŠ¸ ìˆ˜</div></div>`;
                
                // ì‹œíŠ¸ íƒ­
                html += '</div><div class="status"><h3>ğŸ“Š ì‹œíŠ¸ ëª©ë¡</h3><div class="sheet-tabs">';
                workbook.SheetNames.forEach((name, idx) => {
                    html += `<div class="sheet-tab ${idx === 0 ? 'active' : ''}" onclick="showSheet(${idx})">${idx + 1}. ${name}</div>`;
                });
                html += '</div></div>';
                
                output.innerHTML += html;
                
                // ëª¨ë“  ì‹œíŠ¸ ë°ì´í„° ì €ì¥
                let totalRows = 0;
                workbook.SheetNames.forEach((sheetName, idx) => {
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonArray = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: ''});
                    const jsonObjects = XLSX.utils.sheet_to_json(worksheet, {defval: ''});
                    
                    allSheetData[idx] = {
                        name: sheetName,
                        array: jsonArray,
                        objects: jsonObjects,
                        headers: jsonArray[0] || []
                    };
                    
                    totalRows += jsonObjects.length;
                });
                
                // ì „ì²´ ë°ì´í„° ê°œìˆ˜ í‘œì‹œ
                output.innerHTML += `<div class="status success"><h3>ğŸ“ˆ ë°ì´í„° ë¶„ì„ ì™„ë£Œ</h3><p>ì´ ë°ì´í„°: ${totalRows}í–‰</p></div>`;
                
                // ì²« ë²ˆì§¸ ì‹œíŠ¸ í‘œì‹œ
                showSheet(0);
                
                // ìë™ ë³€í™˜ ì‹œì‘
                output.innerHTML += '<div class="status loading"><h3>ğŸ”„ ìë™ ë³€í™˜ ì‹œì‘...</h3></div>';
                await convertData(workbook);
                
            } catch (error) {
                output.innerHTML += `<div class="status error"><h3>âŒ ì˜¤ë¥˜ ë°œìƒ</h3><p>${error.message}</p></div>`;
                console.error(error);
            }
        }

        function showSheet(idx) {
            const data = allSheetData[idx];
            if (!data) return;
            
            // í™œì„± íƒ­ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.sheet-tab').forEach((tab, i) => {
                tab.classList.toggle('active', i === idx);
            });
            
            // ê¸°ì¡´ ì‹œíŠ¸ í‘œì‹œ ì œê±°
            const existing = document.getElementById('sheetDisplay');
            if (existing) existing.remove();
            
            let html = `<div id="sheetDisplay" class="status">
                <h3>ğŸ“„ ì‹œíŠ¸: ${data.name} (${data.objects.length}í–‰)</h3>
                <h4>ì»¬ëŸ¼ (${data.headers.length}ê°œ):</h4>
                <p style="color: #6b7280; font-size: 13px;">${data.headers.join(' | ')}</p>
                <div class="table-container">
                    <table>
                        <thead><tr>`;
            
            data.headers.forEach((h, i) => {
                html += `<th>${i + 1}. ${h}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            data.array.slice(1, 21).forEach(row => {
                html += '<tr>';
                row.forEach(cell => {
                    html += `<td>${cell || ''}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div></div>';
            
            document.getElementById('output').insertAdjacentHTML('beforeend', html);
        }

        async function convertData(workbook) {
            try {
                const output = document.getElementById('output');
                
                // ëª¨ë“  ì‹œíŠ¸ ë°ì´í„° í•©ì¹˜ê¸°
                let allData = [];
                let mappingInfo = [];
                
                workbook.SheetNames.forEach((sheetName, idx) => {
                    const data = allSheetData[idx];
                    const headers = data.headers;
                    
                    // ì»¬ëŸ¼ ë§¤í•‘
                    const mapping = detectColumns(headers);
                    mappingInfo.push({sheet: sheetName, mapping: mapping});
                    
                    // ë°ì´í„° ë³€í™˜
                    data.objects.forEach((row, rowIdx) => {
                        const converted = convertRow(row, headers, mapping, allData.length + 1);
                        if (converted['ì‚¬ì—…ìë²ˆí˜¸*']) { // ì‚¬ì—…ìë²ˆí˜¸ê°€ ìˆëŠ” ê²ƒë§Œ
                            allData.push(converted);
                        }
                    });
                });
                
                output.innerHTML += `<div class="status success">
                    <h3>âœ… ë³€í™˜ ì™„ë£Œ</h3>
                    <p>ì´ ${allData.length}ê±´ì˜ ë°ì´í„°ê°€ ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                </div>`;
                
                // ë§¤í•‘ ì •ë³´ í‘œì‹œ
                output.innerHTML += '<div class="status"><h3>ğŸ” ì»¬ëŸ¼ ë§¤í•‘ ì •ë³´</h3><pre>' + 
                    JSON.stringify(mappingInfo, null, 2) + '</pre></div>';
                
                // ë³€í™˜ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°
                output.innerHTML += '<div class="status"><h3>ğŸ“‹ ë³€í™˜ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° (ì²˜ìŒ 10ê°œ)</h3><pre>' + 
                    JSON.stringify(allData.slice(0, 10), null, 2) + '</pre></div>';
                
                // ì—‘ì…€ íŒŒì¼ ìƒì„±
                createExcelFile(allData);
                
                document.getElementById('downloadSection').style.display = 'block';
                
            } catch (error) {
                document.getElementById('output').innerHTML += 
                    `<div class="status error"><h3>âŒ ë³€í™˜ ì˜¤ë¥˜</h3><p>${error.message}</p></div>`;
                console.error(error);
            }
        }

        function detectColumns(headers) {
            const mapping = {};
            
            headers.forEach((header, idx) => {
                const h = String(header).toLowerCase().replace(/\s/g, '');
                
                if (!mapping.businessNumber && (h.includes('ì‚¬ì—…ì') && h.includes('ë²ˆí˜¸'))) {
                    mapping.businessNumber = idx;
                }
                if (!mapping.businessNumber && h.includes('ë“±ë¡ë²ˆí˜¸')) {
                    mapping.businessNumber = idx;
                }
                if (!mapping.propertyName && (h.includes('ë¬¼ê±´') || h.includes('ë¶€ë™ì‚°') || h.includes('ëª…ì¹­'))) {
                    mapping.propertyName = idx;
                }
                if (!mapping.address && (h.includes('ì†Œì¬ì§€') || h.includes('ì£¼ì†Œ') || h.includes('ìœ„ì¹˜'))) {
                    mapping.address = idx;
                }
                if (!mapping.acquisitionValue && h.includes('ì·¨ë“') && (h.includes('ê°€ì•¡') || h.includes('ê¸ˆì•¡') || h.includes('ê°€ê²©'))) {
                    mapping.acquisitionValue = idx;
                }
                if (!mapping.transferValue && h.includes('ì–‘ë„') && (h.includes('ê°€ì•¡') || h.includes('ê¸ˆì•¡') || h.includes('ê°€ê²©'))) {
                    mapping.transferValue = idx;
                }
                if (!mapping.prepaidIncomeTax && (h.includes('ì¢…ì†Œì„¸') || (h.includes('ì†Œë“ì„¸') && !h.includes('ì§€ë°©')))) {
                    mapping.prepaidIncomeTax = idx;
                }
                if (!mapping.prepaidLocalTax && h.includes('ì§€ë°©') && h.includes('ì†Œë“ì„¸')) {
                    mapping.prepaidLocalTax = idx;
                }
                if (!mapping.transferDate && (h.includes('ì–‘ë„ì¼') || h.includes('ë§¤ë„ì¼') || h.includes('ê±°ë˜ì¼'))) {
                    mapping.transferDate = idx;
                }
            });
            
            return mapping;
        }

        function convertRow(row, headers, mapping, index) {
            const rowArray = headers.map(h => row[h]);
            
            return {
                'ì‚¬ì—…ìë²ˆí˜¸*': String(rowArray[mapping.businessNumber] || '').trim(),
                'ë¬¼ê±´ëª…': rowArray[mapping.propertyName] || `ë¬¼ê±´${index}`,
                'ì†Œì¬ì§€': rowArray[mapping.address] || '',
                'ì·¨ë“ê°€ì•¡': parseNumber(rowArray[mapping.acquisitionValue]),
                'ê¸°íƒ€í•„ìš”ê²½ë¹„': 0,
                'ì–‘ë„ê°€ì•¡': parseNumber(rowArray[mapping.transferValue]),
                'ì²˜ë¶„ë¹„': 0,
                'ì–‘ë„ì†Œë“': '',
                'ì–‘ë„ì¼(YYYYMMDD)': formatDate(rowArray[mapping.transferDate]),
                'ì‹ ê³ ê¸°í•œ': '',
                'ê¸°ë‚©ë¶€ ì¢…ì†Œì„¸': parseNumber(rowArray[mapping.prepaidIncomeTax]),
                'ê¸°ë‚©ë¶€ ì§€ë°©ì†Œë“ì„¸': parseNumber(rowArray[mapping.prepaidLocalTax]),
                '85ì´ˆê³¼(Y/N)': 'N',
                'ì§„í–‰ë‹¨ê³„': 'ë¯¸í™•ì¸',
                'ë¹„ê³ ': ''
            };
        }

        function parseNumber(value) {
            if (!value) return 0;
            const num = String(value).replace(/[^0-9.-]/g, '');
            return parseFloat(num) || 0;
        }

        function formatDate(dateValue) {
            if (!dateValue) return '';
            
            const str = String(dateValue).replace(/[^0-9]/g, '');
            if (str.length === 8) return str;
            
            if (dateValue instanceof Date) {
                const y = dateValue.getFullYear();
                const m = String(dateValue.getMonth() + 1).padStart(2, '0');
                const d = String(dateValue.getDate()).padStart(2, '0');
                return `${y}${m}${d}`;
            }
            
            return '';
        }

        function createExcelFile(data) {
            const wb = XLSX.utils.book_new();
            
            // Sheet 1: ë¬¼ê±´ëª©ë¡
            const ws1 = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws1, 'ë¬¼ê±´ëª©ë¡');
            
            // Sheet 2: í•„ìš”ê²½ë¹„ìƒì„¸
            const ws2 = XLSX.utils.aoa_to_sheet([
                ['ì‚¬ì—…ìë²ˆí˜¸*', 'ë¬¼ê±´ëª…*', 'ë²ˆí˜¸', 'ë¹„ìš©ëª…', 'êµ¬ë¶„(ì·¨ë“ê°€ì•¡/ê¸°íƒ€í•„ìš”ê²½ë¹„)', 'ê¸ˆì•¡', 'ë¹„ìš©ì¸ì •(O/X)', 'ë¹„ê³ ']
            ]);
            XLSX.utils.book_append_sheet(wb, ws2, 'í•„ìš”ê²½ë¹„ìƒì„¸');
            
            finalWorkbook = wb;
        }

        function downloadExcel() {
            if (!finalWorkbook) {
                alert('ë³€í™˜ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            const fileName = `ë§¤ë§¤ì‚¬ì—…ì_ì¼ê´„ì—…ë¡œë“œ_ì–‘ì‹_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(finalWorkbook, fileName);
            
            alert(`âœ… ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!\n\níŒŒì¼ëª…: ${fileName}\n\nì´ì œ ë§¤ë§¤ì‚¬ì—…ì ë°ì´í„° í˜ì´ì§€ì—ì„œ "ì¼ê´„ ì—…ë¡œë“œ"ë¥¼ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”!`);
        }

        window.onload = init;
    </script>
</body>
</html>
