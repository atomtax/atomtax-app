  1	<!DOCTYPE html>
     2	<html lang="ko">
     3	<head>
     4	    <meta charset="UTF-8">
     5	    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     6	    <title>ë§¤ë§¤ì‚¬ì—…ì ë°ì´í„° - ì•„í†°ì„¸ë¬´íšŒê³„</title>
     7	    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
     8	    
     9	    <!-- Preconnect to CDNs for faster loading -->
    10	    <link rel="preconnect" href="https://fonts.googleapis.com">
    11	    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    12	    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    13	    
    14	    <!-- Font Awesome (ìµœì†Œí™”: solid ì•„ì´ì½˜ë§Œ) -->
    15	    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/fontawesome.min.css">
    16	    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/solid.min.css">
    17	    
    18	    <!-- Google Fonts (ìµœì í™”: í•„ìš”í•œ ì›¨ì´íŠ¸ë§Œ) -->
    19	    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    20	    
    21	    <!-- Preload critical CSS -->
    22	    <link rel="preload" href="css/style.css" as="style">
    23	    <link rel="preload" href="css/traders-performance.css" as="style">
    24	    
    25	    <!-- Preload JavaScript -->
    26	    <link rel="preload" href="js/common.js" as="script">
    27	    
    28	    <link rel="stylesheet" href="css/style.css">
    29	    <link rel="stylesheet" href="css/traders-performance.css">
    30	    
    31	    <!-- Supabase SDK -->
    32	    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    33	</head>
    34	<body class="trader-performance">
    35	    <div class="app-container">
    36	        <!-- Sidebar -->
    37	        <div class="sidebar">
    38	            <div class="sidebar-header">
    39	                <div class="logo">
    40	                    <span>ì•„í†°ì„¸ë¬´íšŒê³„</span>
    41	                </div>
    42	            </div>
    43	            
    44	            <nav class="sidebar-nav">
    45	                <a href="dashboard.html" class="nav-item">
    46	                    <i class="fas fa-home"></i>
    47	                    <span>ëŒ€ì‹œë³´ë“œ</span>
    48	                </a>
    49	                
    50	                <!-- ê³ ê°ì‚¬ ê´€ë¦¬ (ë“œë¡­ë‹¤ìš´) -->
    51	                <div class="nav-dropdown">
    52	                    <a href="#" class="nav-item" onclick="toggleDropdown(event)">
    53	                        <i class="fas fa-building"></i>
    54	                        <span>ê³ ê°ì‚¬ ê´€ë¦¬</span>
    55	                        <i class="fas fa-chevron-down dropdown-arrow"></i>
    56	                    </a>
    57	                    <div class="dropdown-content">
    58	                        <a href="clients.html" class="dropdown-item">
    59	                            <i class="fas fa-briefcase"></i>
    60	                            <span>ê¸°ì¥ê³ ê° ê´€ë¦¬</span>
    61	                        </a>
    62	                        <a href="clients-terminated.html" class="dropdown-item">
    63	                            <i class="fas fa-user-times"></i>
    64	                            <span>í•´ì„ê³ ê° ê´€ë¦¬</span>
    65	                        </a>
    66	                    </div>
    67	                </div>
    68	                
    69	                <!-- ë§¤ë§¤ì‚¬ì—…ì ê´€ë¦¬ (ë“œë¡­ë‹¤ìš´) -->
    70	                <div class="nav-dropdown active">
    71	                    <a href="#" class="nav-item" onclick="toggleDropdown(event)">
    72	                        <i class="fas fa-store"></i>
    73	                        <span>ë§¤ë§¤ì‚¬ì—…ì ê´€ë¦¬</span>
    74	                        <i class="fas fa-chevron-down dropdown-arrow"></i>
    75	                    </a>
    76	                    <div class="dropdown-content">
    77	                        <a href="traders-data.html" class="dropdown-item active">
    78	                            <i class="fas fa-database"></i>
    79	                            <span>ë§¤ë§¤ì‚¬ì—…ì ë°ì´í„°</span>
    80	                        </a>
    81	                        <a href="traders-checklist.html" class="dropdown-item">
    82	                            <i class="fas fa-check-square"></i>
    83	                            <span>ë§¤ë§¤ì‚¬ì—…ì ì²´í¬ë¦¬ìŠ¤íŠ¸</span>
    84	                        </a>
    85	                        <a href="traders-vat.html" class="dropdown-item">
    86	                            <i class="fas fa-calculator"></i>
    87	                            <span>ë¶€ê°€ê°€ì¹˜ì„¸ ê³„ì‚°</span>
    88	                        </a>
    89	                    </div>
    90	                </div>
    91	                
    92	                <a href="#" class="nav-item">
    93	                    <i class="fas fa-file-invoice-dollar"></i>
    94	                    <span>ì„¸ë¬´ ê´€ë¦¬</span>
    95	                </a>
    96	                <a href="#" class="nav-item">
    97	                    <i class="fas fa-chart-bar"></i>
    98	                    <span>í†µê³„ ë¶„ì„</span>
    99	                </a>
   100	                <a href="#" class="nav-item">
   101	                    <i class="fas fa-cog"></i>
   102	                    <span>ì„¤ì •</span>
   103	                </a>
   104	            </nav>
   105	            
   106	            <div class="sidebar-footer">
   107	                <button id="logoutBtn" class="nav-item" style="width: 100%; border: none; background: none;">
   108	                    <i class="fas fa-sign-out-alt"></i>
   109	                    <span>ë¡œê·¸ì•„ì›ƒ</span>
   110	                </button>
   111	            </div>
   112	        </div>
   113	
   114	        <!-- Main Content -->
   115	        <div class="main-content">
   116	            <!-- Top Bar -->
   117	            <div class="topbar">
   118	                <div class="topbar-left">
   119	                    <button class="menu-toggle">
   120	                        <i class="fas fa-bars"></i>
   121	                    </button>
   122	                    <h1 class="topbar-title">ë§¤ë§¤ì‚¬ì—…ì ë°ì´í„°</h1>
   123	                </div>
   124	                
   125	                <div class="topbar-right">
   126	                    <div class="topbar-search">
   127	                        <input type="text" id="globalSearch" placeholder="ê²€ìƒ‰...">
   128	                        <i class="fas fa-search"></i>
   129	                    </div>
   130	                    
   131	                    <div class="user-profile">
   132	                        <div class="user-avatar" id="userAvatar">A</div>
   133	                        <div class="user-info">
   134	                            <div class="user-name" id="userName">ê´€ë¦¬ì</div>
   135	                            <div class="user-role" id="userRole">Admin</div>
   136	                        </div>
   137	                    </div>
   138	                </div>
   139	            </div>
   140	
   141	            <!-- Content Area -->
   142	            <div class="content-area">
   143	                <!-- Filter Toolbar (ê³ ê°ì‚¬ ê´€ë¦¬ì™€ ë™ì¼í•œ ë””ìì¸) -->
   144	                <div class="card">
   145	                    <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center; justify-content: space-between; padding: 20px 24px;">
   146	                        <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
   147	                            <!-- Manager Filter -->
   148	                            <select id="managerFilter" class="px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-500" style="min-width: 150px;">
   149	                                <option value="">ì „ì²´ ë‹´ë‹¹ì</option>
   150	                            </select>
   151	                            
   152	                            <!-- Company Name Search -->
   153	                            <input type="text" id="companyNameSearch" class="px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-500" placeholder="ê±°ë˜ì²˜ëª… ê²€ìƒ‰..." style="width: 250px;">
   154	                        </div>
   155	                        
   156	                        <div style="display: flex; gap: 12px;">
   157	                            <!-- ì¼ê´„ ì—‘ì…€ ì—…ë¡œë“œ ë²„íŠ¼ -->
   158	                            <button onclick="downloadBulkExcelTemplate()" class="btn btn-success">
   159	                                <i class="fas fa-download"></i> ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
   160	                            </button>
   161	                            <button onclick="document.getElementById('bulkExcelUpload').click()" class="btn btn-primary">
   162	                                <i class="fas fa-upload"></i> ì¼ê´„ ì—…ë¡œë“œ
   163	                            </button>
   164	                            <input type="file" id="bulkExcelUpload" accept=".xlsx, .xls" style="display: none;" onchange="handleBulkExcelUpload(event)">
   165	                            
   166	                            <!-- ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ -->
   167	                            <button onclick="refreshData()" class="btn btn-secondary">
   168	                                <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
   169	                            </button>
   170	                        </div>
   171	                    </div>
   172	                </div>
   173	
   174	                <!-- Traders List -->
   175	                <div class="card">
   176	                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
   177	                        <h3 class="card-title">
   178	                            <i class="fas fa-store mr-2"></i>
   179	                            ë§¤ë§¤ì‚¬ì—…ì ëª©ë¡
   180	                        </h3>
   181	                        <div style="color: #6b7280; font-size: 14px;">
   182	                            <span>ì—…ì¢…ì½”ë“œ: 703011, 703012</span>
   183	                            <span style="margin-left: 16px;">ì´ <strong id="traderCount" style="color: #667eea;">0</strong>ê°œ</span>
   184	                        </div>
   185	                    </div>
   186	                    
   187	                    <!-- Loading -->
   188	                    <div id="loading" style="text-align: center; padding: 60px;">
   189	                        <div class="spinner" style="margin: 0 auto;"></div>
   190	                        <p style="margin-top: 16px; color: #6b7280;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
   191	                    </div>
   192	                    
   193	                    <!-- Traders Grid -->
   194	                    <div id="tradersGridContainer" style="display: none; padding: 24px;">
   195	                        <!-- ë‹´ë‹¹ìë³„ ê·¸ë¦¬ë“œê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
   196	                    </div>
   197	                    
   198	                    <!-- Empty State -->
   199	                    <div id="emptyState" style="display: none; text-align: center; padding: 60px;">
   200	                        <i class="fas fa-inbox" style="font-size: 64px; color: #d1d5db; margin-bottom: 16px;"></i>
   201	                        <p style="color: #6b7280; font-size: 16px;">ë§¤ë§¤ì‚¬ì—…ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>
   202	                        <p style="color: #9ca3af; font-size: 14px; margin-top: 8px;">
   203	                            ê³ ê°ì‚¬ ê´€ë¦¬ì—ì„œ ì—…ì¢…ì½”ë“œê°€ 703011 ë˜ëŠ” 703012ì¸ ê³ ê°ì‚¬ë¥¼ ì¶”ê°€í•˜ë©´<br>
   204	                            ìë™ìœ¼ë¡œ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.
   205	                        </p>
   206	                    </div>
   207	                </div>
   208	            </div>
   209	        </div>
   210	    </div>
   211	
   212	    <!-- Supabase Configuration and Auth -->
   213	    <script src="js/supabase-config.js"></script>
   214	    <script src="js/supabase-auth.js"></script>
   215	    <script src="js/supabase-db.js"></script>
   216	    <script src="js/common.js"></script>
   217	    <script src="js/auto-backup.js"></script>
   218	    <script>
   219	        console.log('ğŸš€ traders-data.html ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘');
   220	        
   221	        // Check authentication with Supabase
   222	        SupabaseAuth.onAuthStateChanged(async (user) => {
   223	            if (!user) {
   224	                window.location.href = 'index.html';
   225	                return;
   226	            }
   227	            
   228	            // Display user info
   229	            try {
   230	                // Supabase user ê°ì²´ì—ì„œ ì§ì ‘ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
   231	                const displayName = user.email?.split('@')[0] || 'User';
   232	                const emailElement = document.getElementById('userName');
   233	                const roleElement = document.getElementById('userRole');
   234	                const avatarElement = document.getElementById('userAvatar');
   235	                
   236	                if (emailElement) emailElement.textContent = user.email || displayName;
   237	                if (roleElement) roleElement.textContent = 'Admin';
   238	                if (avatarElement) avatarElement.textContent = displayName.charAt(0).toUpperCase();
   239	                
   240	                console.log('âœ… ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ì™„ë£Œ:', user.email);
   241	            } catch (error) {
   242	                console.error('ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ì˜¤ë¥˜:', error);
   243	                // ê¸°ë³¸ê°’ ì„¤ì •
   244	                const displayName = user.email?.split('@')[0] || 'User';
   245	                if (document.getElementById('userName')) 
   246	                    document.getElementById('userName').textContent = displayName;
   247	                if (document.getElementById('userRole')) 
   248	                    document.getElementById('userRole').textContent = 'Admin';
   249	                if (document.getElementById('userAvatar')) 
   250	                    document.getElementById('userAvatar').textContent = displayName.charAt(0).toUpperCase();
   251	            }
   252	        });
   253	
   254	        // Global variables
   255	        let allTraders = [];
   256	        let filteredTraders = [];
   257	        let selectedManager = '';
   258	        
   259	        // Cache settings
   260	        const CACHE_KEY = 'traders_data_cache';
   261	        const CACHE_TIME_KEY = 'traders_data_cache_time';
   262	        const CACHE_DURATION = 5 * 60 * 1000; // 5ë¶„
   263	
   264	        // Load traders (ì—…ì¢…ì½”ë“œ 703011, 703012)
   265	        async function loadTraders(forceRefresh = false) {
   266	            console.log('ğŸ”„ loadTraders() ì‹œì‘, forceRefresh:', forceRefresh);
   267	            console.time('â±ï¸ Total Load Time');
   268	            try {
   269	                // ë¡œë”© í‘œì‹œ
   270	                const loadingEl = document.getElementById('loading');
   271	                const gridEl = document.getElementById('tradersGridContainer');
   272	                const emptyEl = document.getElementById('emptyState');
   273	                
   274	                if (!loadingEl || !gridEl || !emptyEl) {
   275	                    console.error('âŒ í•„ìˆ˜ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
   276	                    throw new Error('Required DOM elements not found');
   277	                }
   278	                
   279	                loadingEl.style.display = 'block';
   280	                gridEl.style.display = 'none';
   281	                emptyEl.style.display = 'none';
   282	                console.log('âœ… ë¡œë”© í‘œì‹œ í™œì„±í™”');
   283	                
   284	                // ğŸ”¹ ìºì‹œ í™•ì¸ (forceRefreshê°€ falseì¼ ë•Œë§Œ)
   285	                if (!forceRefresh) {
   286	                    const cachedData = localStorage.getItem(CACHE_KEY);
   287	                    const cacheTime = localStorage.getItem(CACHE_TIME_KEY);
   288	                    
   289	                    if (cachedData && cacheTime) {
   290	                        const elapsed = Date.now() - parseInt(cacheTime);
   291	                        if (elapsed < CACHE_DURATION) {
   292	                            console.log(`âœ… Using cached data (age: ${Math.round(elapsed/1000)}s / ${CACHE_DURATION/1000}s)`);
   293	                            allTraders = JSON.parse(cachedData);
   294	                            
   295	                            if (allTraders.length === 0) {
   296	                                showEmptyState();
   297	                            } else {
   298	                                console.time('â±ï¸ Populate Filters Time');
   299	                                populateFilters();
   300	                                console.timeEnd('â±ï¸ Populate Filters Time');
   301	                                
   302	                                console.time('â±ï¸ Render Grid Time');
   303	                                filteredTraders = [...allTraders];
   304	                                applyFilters();
   305	                                console.timeEnd('â±ï¸ Render Grid Time');
   306	                            }
   307	                            
   308	                            console.timeEnd('â±ï¸ Total Load Time');
   309	                            return;
   310	                        } else {
   311	                            console.log('â° Cache expired, fetching new data...');
   312	                        }
   313	                    }
   314	                }
   315	                
   316	                // Supabaseì—ì„œ ë°ì´í„° ë¡œë“œ
   317	                console.log('ğŸŒ Supabase ë°ì´í„° ë¡œë“œ ì‹œì‘...');
   318	                console.time('â±ï¸ Supabase Fetch Time');
   319	                
   320	                // Get all clients from Supabase
   321	                let allClients = [];
   322	                
   323	                try {
   324	                    // Supabase API ì‚¬ìš©
   325	                    const { data: clients, error } = await supabaseClient
   326	                        .from('clients')
   327	                        .select('*')
   328	                        .order('created_at', { ascending: false });
   329	                    
   330	                    if (error) {
   331	                        console.error('âŒ Supabase ì˜¤ë¥˜:', error);
   332	                        throw error;
   333	                    }
   334	                    
   335	                    allClients = clients || [];
   336	                    console.log(`âœ… Supabase: ${allClients.length}ê°œ ê³ ê°ì‚¬ ë¡œë“œ ì™„ë£Œ`);
   337	                    console.timeEnd('â±ï¸ Supabase Fetch Time');
   338	                } catch (fetchError) {
   339	                    console.timeEnd('â±ï¸ Supabase Fetch Time');
   340	                    console.error('âŒ Supabase ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', fetchError);
   341	                    
   342	                    // Fallback: GenSpark API ì‹œë„
   343	                    try {
   344	                        console.log('ğŸ”„ Fallback: GenSpark API ì‹œë„...');
   345	                        const response = await fetch(`tables/clients?limit=1000`);
   346	                        if (response.ok) {
   347	                            const result = await response.json();
   348	                            allClients = result.data || [];
   349	                            console.log(`âœ… GenSpark: ${allClients.length}ê°œ ê³ ê°ì‚¬ ë¡œë“œë¨ (Fallback)`);
   350	                        }
   351	                    } catch (fallbackError) {
   352	                        console.warn('âŒ Fallbackë„ ì‹¤íŒ¨, ë¹ˆ ë°ì´í„° ì‚¬ìš©:', fallbackError);
   353	                        allClients = [];
   354	                    }
   355	                }
   356	                
   357	                // Filter by business code (703011, 703012)
   358	                console.time('â±ï¸ Filter Time');
   359	                allTraders = allClients.filter(client => {
   360	                    const code = (client.business_code || '').trim();
   361	                    return code === '703011' || code === '703012';
   362	                });
   363	                console.timeEnd('â±ï¸ Filter Time');
   364	                
   365	                console.log(`âœ… Filtered ${allTraders.length} traders from ${allClients.length} clients`);
   366	                
   367	                // ğŸ”¹ ìºì‹œ ì €ì¥
   368	                localStorage.setItem(CACHE_KEY, JSON.stringify(allTraders));
   369	                localStorage.setItem(CACHE_TIME_KEY, Date.now().toString());
   370	                console.log('ğŸ’¾ Data cached for 5 minutes');
   371	                
   372	                if (allTraders.length === 0) {
   373	                    showEmptyState();
   374	                } else {
   375	                    console.time('â±ï¸ Populate Filters Time');
   376	                    populateFilters();
   377	                    console.timeEnd('â±ï¸ Populate Filters Time');
   378	                    
   379	                    console.time('â±ï¸ Render Grid Time');
   380	                    filteredTraders = [...allTraders];
   381	                    applyFilters();
   382	                    console.timeEnd('â±ï¸ Render Grid Time');
   383	                }
   384	                
   385	                console.timeEnd('â±ï¸ Total Load Time');
   386	            } catch (error) {
   387	                console.timeEnd('â±ï¸ Total Load Time');
   388	                console.error('Error loading traders:', error);
   389	                showNotification('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
   390	                showEmptyState();
   391	            }
   392	        }
   393	        
   394	        // ğŸ”¹ ìºì‹œ ì´ˆê¸°í™” ë° ìƒˆë¡œê³ ì¹¨
   395	        function refreshData() {
   396	            localStorage.removeItem(CACHE_KEY);
   397	            localStorage.removeItem(CACHE_TIME_KEY);
   398	            console.log('ğŸ”„ Cache cleared, reloading data...');
   399	            showNotification('ë°ì´í„°ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤...', 'info');
   400	            loadTraders(true); // forceRefresh = true
   401	        }
   402	
   403	        // Populate filters
   404	        function populateFilters() {
   405	            // Get unique managers
   406	            const managers = [...new Set(allTraders.map(t => t.manager).filter(m => m))].sort();
   407	            const managerFilter = document.getElementById('managerFilter');
   408	            managerFilter.innerHTML = '<option value="">ì „ì²´ ë‹´ë‹¹ì</option>' + 
   409	                managers.map(m => `<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join('');
   410	        }
   411	
   412	        // Apply filters
   413	        function applyFilters() {
   414	            const managerFilter = document.getElementById('managerFilter').value;
   415	            const companyNameSearch = document.getElementById('companyNameSearch').value.toLowerCase();
   416	            
   417	            filteredTraders = allTraders.filter(trader => {
   418	                // Manager filter
   419	                if (managerFilter && trader.manager !== managerFilter) return false;
   420	                
   421	                // Company name search
   422	                if (companyNameSearch) {
   423	                    const companyName = (trader.company_name || '').toLowerCase();
   424	                    if (!companyName.includes(companyNameSearch)) return false;
   425	                }
   426	                
   427	                return true;
   428	            });
   429	            
   430	            document.getElementById('traderCount').textContent = filteredTraders.length;
   431	            
   432	            if (filteredTraders.length === 0) {
   433	                showEmptyState();
   434	            } else {
   435	                renderTradersGrid(filteredTraders);
   436	            }
   437	        }
   438	
   439	        // Reset filters
   440	        function resetFilters() {
   441	            document.getElementById('managerFilter').value = '';
   442	            document.getElementById('companyNameSearch').value = '';
   443	            applyFilters();
   444	        }
   445	
   446	        function renderTradersGrid(traders) {
   447	            console.log('ğŸ¨ renderTradersGrid() í˜¸ì¶œë¨, traders.length:', traders.length);
   448	            
   449	            // Group by manager
   450	            const byManager = {};
   451	            traders.forEach(trader => {
   452	                const manager = trader.manager || 'ë¯¸ì§€ì •';
   453	                if (!byManager[manager]) {
   454	                    byManager[manager] = [];
   455	                }
   456	                byManager[manager].push(trader);
   457	            });
   458	            
   459	            console.log('ğŸ‘¥ ë‹´ë‹¹ìë³„ ê·¸ë£¹:', Object.keys(byManager));
   460	            
   461	            // Sort managers
   462	            const managers = Object.keys(byManager).sort();
   463	            
   464	            // Render grid
   465	            const container = document.getElementById('tradersGridContainer');
   466	            let html = '';
   467	            
   468	            managers.forEach((manager, index) => {
   469	                const tradersList = byManager[manager];
   470	                
   471	                // Add spacing between groups
   472	                if (index > 0) {
   473	                    html += '<div style="height: 24px;"></div>';
   474	                }
   475	                
   476	                // Manager header
   477	                html += `
   478	                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px 20px; border-radius: 8px; margin-bottom: 16px;">
   479	                        <div style="color: white; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
   480	                            <i class="fas fa-user-tie"></i>
   481	                            ${escapeHtml(manager)}
   482	                            <span style="font-weight: 400; opacity: 0.9; font-size: 14px;">(${tradersList.length}ê°œ)</span>
   483	                        </div>
   484	                    </div>
   485	                `;
   486	                
   487	                // Trader buttons grid
   488	                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px;">';
   489	                
   490	                tradersList.forEach(trader => {
   491	                    html += `
   492	                        <button onclick="window.location.href='trader-detail.html?id=${trader.id}'" 
   493	                                style="padding: 16px 20px; 
   494	                                       background: white; 
   495	                                       border: 2px solid #e5e7eb; 
   496	                                       border-radius: 8px; 
   497	                                       text-align: center; 
   498	                                       font-size: 15px; 
   499	                                       font-weight: 600; 
   500	                                       color: #1f2937; 
   501	                                       cursor: pointer;
   502	                                       transition: all 0.2s;"
   503	                                onmouseover="this.style.borderColor='#667eea'; this.style.background='#f5f3ff'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.15)';"
   504	                                onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
   505	                            ${escapeHtml(trader.company_name || '-')}
   506	                        </button>
   507	                    `;
   508	                });
   509	                
   510	                html += '</div>';
   511	            });
   512	            
   513	            container.innerHTML = html;
   514	            
   515	            document.getElementById('tradersGridContainer').style.display = 'block';
   516	            document.getElementById('loading').style.display = 'none';
   517	            document.getElementById('emptyState').style.display = 'none';
   518	            console.log('âœ… ê·¸ë¦¬ë“œ ë Œë”ë§ ì™„ë£Œ');
   519	        }
   520	
   521	        function showEmptyState() {
   522	            console.log('ğŸ“­ showEmptyState() í˜¸ì¶œë¨');
   523	            document.getElementById('loading').style.display = 'none';
   524	            document.getElementById('tradersGridContainer').style.display = 'none';
   525	            document.getElementById('emptyState').style.display = 'block';
   526	            console.log('âœ… Empty state í‘œì‹œ ì™„ë£Œ');
   527	        }
   528	
   529	        function escapeHtml(text) {
   530	            const div = document.createElement('div');
   531	            div.textContent = text;
   532	            return div.innerHTML;
   533	        }
   534	
   535	        function formatPhoneNumber(number) {
   536	            if (!number) return '';
   537	            const cleaned = number.replace(/[^0-9]/g, '');
   538	            if (cleaned.length === 11) {
   539	                return cleaned.slice(0, 3) + '-' + cleaned.slice(3, 7) + '-' + cleaned.slice(7);
   540	            }
   541	            return number;
   542	        }
   543	
   544	        // Event listeners
   545	        document.getElementById('managerFilter').addEventListener('change', applyFilters);
   546	        document.getElementById('companyNameSearch').addEventListener('input', applyFilters);
   547	        document.getElementById('globalSearch').addEventListener('input', (e) => {
   548	            // Global search will filter from filteredTraders
   549	            const searchTerm = e.target.value.toLowerCase().trim();
   550	            
   551	            if (!searchTerm) {
   552	                applyFilters();
   553	                return;
   554	            }
   555	            
   556	            const searched = filteredTraders.filter(trader => {
   557	                const searchableText = [
   558	                    trader.company_name,
   559	                    trader.ceo_name,
   560	                    trader.business_code,
   561	                    trader.contact,
   562	                    trader.address,
   563	                    trader.number
   564	                ].join(' ').toLowerCase();
   565	                
   566	                return searchableText.includes(searchTerm);
   567	            });
   568	            
   569	            document.getElementById('traderCount').textContent = searched.length;
   570	            
   571	            if (searched.length === 0) {
   572	                showEmptyState();
   573	            } else {
   574	                renderTradersGrid(searched);
   575	            }
   576	        });
   577	
   578	        // Create mock traders for preview mode
   579	        function createMockTraders() {
   580	            console.log('ğŸ“¦ Creating 60 mock traders for preview mode...');
   581	            
   582	            const managers = ['ê¹€ì² ìˆ˜', 'ì´ì˜í¬', 'ë°•ë¯¼ìˆ˜', 'ì •ë‹¤ì€', 'ìµœì¤€í˜¸'];
   583	            const districts = ['ê°•ë‚¨êµ¬', 'ì„œì´ˆêµ¬', 'ì†¡íŒŒêµ¬', 'ê°•ë™êµ¬', 'ë§ˆí¬êµ¬', 'ìš©ì‚°êµ¬', 'ì˜ë“±í¬êµ¬', 'êµ¬ë¡œêµ¬', 'ê¸ˆì²œêµ¬', 'ê´€ì•…êµ¬'];
   584	            const codes = ['703011', '703012'];
   585	            const names = ['í™ê¸¸ë™', 'ê¹€ì˜ìˆ˜', 'ì´ìˆœì‹ ', 'ì„¸ì¢…ëŒ€ì™•', 'ì¥ë³´ê³ ', 'ì‹ ì‚¬ì„ë‹¹', 'ìœ ê´€ìˆœ', 'ì•ˆì¤‘ê·¼', 'ìœ¤ë´‰ê¸¸', 'ê¹€êµ¬'];
   586	            
   587	            const traders = [];
   588	            for (let i = 1; i <= 60; i++) {
   589	                traders.push({
   590	                    id: `mock-client-${i}`,
   591	                    company_name: `ë§¤ë§¤ì‚¬ì—…ì${i}`,
   592	                    manager: managers[i % managers.length],
   593	                    business_code: codes[i % codes.length],
   594	                    ceo_name: names[i % names.length],
   595	                    contact: `010-${String(1000 + i).slice(-4)}-${String(5000 + i).slice(-4)}`,
   596	                    address: `ì„œìš¸ì‹œ ${districts[i % districts.length]} í…ŒìŠ¤íŠ¸ë¡œ ${i * 10}`,
   597	                    number: String(i)
   598	                });
   599	            }
   600	            
   601	            return traders;
   602	        }
   603	
   604	        // ============================================
   605	        // ì¼ê´„ ì—‘ì…€ ì—…ë¡œë“œ ê¸°ëŠ¥
   606	        // ============================================
   607	
   608	        // ì¼ê´„ ì—…ë¡œë“œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
   609	        function downloadBulkExcelTemplate() {
   610	            if (typeof XLSX === 'undefined') {
   611	                alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
   612	                return;
   613	            }
   614	
   615	            try {
   616	                const wb = XLSX.utils.book_new();
   617	                
   618	                // Sheet 1: ë¬¼ê±´ëª©ë¡
   619	                const inventoryData = [
   620	                    ['ğŸ“‹ ë¬¼ê±´ëª©ë¡ ì‘ì„± ë°©ë²•: ê±°ë˜ì²˜ëª…*ê³¼ ë¬¼ê±´ëª…ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”. ì·¨ë“ê°€ì•¡/ê¸°íƒ€í•„ìš”ê²½ë¹„ëŠ” í•„ìš”ê²½ë¹„ìƒì„¸ ì‹œíŠ¸ì—ì„œ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.'],
   621	                    [],
   622	                    ['ê±°ë˜ì²˜ëª…*', 'ë¬¼ê±´ëª…', 'ì†Œì¬ì§€', 'ì·¨ë“ì¼(YYYYMMDD)', 'ì–‘ë„ì¼(YYYYMMDD)', 'ì–‘ë„ê°€ì•¡', 'ê¸°ë‚©ë¶€ ì¢…ì†Œì„¸', 'ê¸°ë‚©ë¶€ ì§€ë°©ì†Œë“ì„¸', 'ì‹ ê³ ê¸°í•œ', '85ì´ˆê³¼(O/X)', 'ë¹„ê³ '],
   623	                    ['ì˜ˆ: (ì£¼)ì•„í†°ì„¸ë¬´íšŒê³„', 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸', 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123', '20230101', '20250115', '150000000', '1000000', '100000', '', 'O', ''],
   624	                    ['ì˜ˆ: (ì£¼)ì•„í†°ì„¸ë¬´íšŒê³„', 'ì„œìš¸ì‹œ ì„œì´ˆêµ¬ ì˜¤í”¼ìŠ¤í…”', 'ì„œìš¸ì‹œ ì„œì´ˆêµ¬ ì„œì´ˆëŒ€ë¡œ 456', '20230201', '20250220', '120000000', '800000', '80000', '', 'X', ''],
   625	                    ['ì˜ˆ: (ì£¼)ë² íƒ€ì»´í¼ë‹ˆ', 'ë¶€ì‚°ì‹œ í•´ìš´ëŒ€ ìƒê°€', 'ë¶€ì‚°ì‹œ í•´ìš´ëŒ€êµ¬ í•´ìš´ëŒ€ë¡œ 789', '20220315', '20250310', '280000000', '2000000', '200000', '', 'O', ''],
   626	                    ['', '', '', '', '', '', '', '', '', '', '']
   627	                ];
   628	                
   629	                const ws1 = XLSX.utils.aoa_to_sheet(inventoryData);
   630	                
   631	                ws1['!cols'] = [
   632	                    {wch: 20}, // ê±°ë˜ì²˜ëª…
   633	                    {wch: 25}, // ë¬¼ê±´ëª…
   634	                    {wch: 35}, // ì†Œì¬ì§€
   635	                    {wch: 18}, // ì·¨ë“ì¼
   636	                    {wch: 18}, // ì–‘ë„ì¼
   637	                    {wch: 15}, // ì–‘ë„ê°€ì•¡
   638	                    {wch: 15}, // ê¸°ë‚©ë¶€ ì¢…ì†Œì„¸
   639	                    {wch: 18}, // ê¸°ë‚©ë¶€ ì§€ë°©ì†Œë“ì„¸
   640	                    {wch: 15}, // ì‹ ê³ ê¸°í•œ
   641	                    {wch: 12}, // 85ì´ˆê³¼
   642	                    {wch: 20}  // ë¹„ê³ 
   643	                ];
   644	                XLSX.utils.book_append_sheet(wb, ws1, 'ë¬¼ê±´ëª©ë¡');
   645	                
   646	                // Sheet 2: í•„ìš”ê²½ë¹„ ìƒì„¸
   647	                const expenseData = [
   648	                    ['ğŸ“‹ í•„ìš”ê²½ë¹„ ì‘ì„± ë°©ë²•: ê±°ë˜ì²˜ëª…*ê³¼ ë¬¼ê±´ëª…*ì€ ë¬¼ê±´ëª©ë¡ ì‹œíŠ¸ì™€ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤. (ë³µì‚¬&ë¶™ì—¬ë„£ê¸° ê¶Œì¥). ë²ˆí˜¸ëŠ” ìë™ìœ¼ë¡œ ë¶€ì—¬ë©ë‹ˆë‹¤.'],
   649	                    [],
   650	                    ['ê±°ë˜ì²˜ëª…*', 'ë¬¼ê±´ëª…* (ë¬¼ê±´ëª©ë¡ê³¼ ë™ì¼)', 'ë²ˆí˜¸', 'ë¹„ìš©ëª…', 'êµ¬ë¶„(ì·¨ë“ê°€ì•¡/ê¸°íƒ€í•„ìš”ê²½ë¹„)', 'ê¸ˆì•¡', 'ë¹„ìš©ì¸ì •(O/X)', 'ë¹„ê³ '],
   651	                    ['ì˜ˆ: (ì£¼)ì•„í†°ì„¸ë¬´íšŒê³„', 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸', '1', 'ì·¨ë“ê°€ì•¡', 'ì·¨ë“ê°€ì•¡', '100000000', 'O', ''],
   652	                    ['ì˜ˆ: (ì£¼)ì•„í†°ì„¸ë¬´íšŒê³„', 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸', '2', 'ì·¨ë“ì„¸ ë“±', 'ì·¨ë“ê°€ì•¡', '5000000', 'O', ''],
   653	                    ['ì˜ˆ: (ì£¼)ì•„í†°ì„¸ë¬´íšŒê³„', 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸', '3', 'ì¤‘ê°œìˆ˜ìˆ˜ë£Œ', 'ê¸°íƒ€í•„ìš”ê²½ë¹„', '2000000', 'O', ''],
   654	                    ['ì˜ˆ: (ì£¼)ì•„í†°ì„¸ë¬´íšŒê³„', 'ì„œìš¸ì‹œ ì„œì´ˆêµ¬ ì˜¤í”¼ìŠ¤í…”', '1', 'ì·¨ë“ê°€ì•¡', 'ì·¨ë“ê°€ì•¡', '80000000', 'O', ''],
   655	                    ['ì˜ˆ: (ì£¼)ë² íƒ€ì»´í¼ë‹ˆ', 'ë¶€ì‚°ì‹œ í•´ìš´ëŒ€ ìƒê°€', '1', 'ì·¨ë“ê°€ì•¡', 'ì·¨ë“ê°€ì•¡', '200000000', 'O', ''],
   656	                    ['ì˜ˆ: (ì£¼)ë² íƒ€ì»´í¼ë‹ˆ', 'ë¶€ì‚°ì‹œ í•´ìš´ëŒ€ ìƒê°€', '2', 'ì·¨ë“ì„¸ ë“±', 'ì·¨ë“ê°€ì•¡', '10000000', 'O', ''],
   657	                    ['', '', '', '', '', '', '', '']
   658	                ];
   659	                
   660	                const ws2 = XLSX.utils.aoa_to_sheet(expenseData);
   661	                
   662	                ws2['!cols'] = [
   663	                    {wch: 20}, {wch: 25}, {wch: 8}, {wch: 20}, {wch: 28}, {wch: 15}, {wch: 15}, {wch: 20}
   664	                ];
   665	                XLSX.utils.book_append_sheet(wb, ws2, 'í•„ìš”ê²½ë¹„ìƒì„¸');
   666	                
   667	                const fileName = `ë§¤ë§¤ì‚¬ì—…ì_ì¼ê´„ì—…ë¡œë“œ_ì–‘ì‹_${new Date().toISOString().slice(0,10)}.xlsx`;
   668	                XLSX.writeFile(wb, fileName);
   669	                
   670	                alert('âœ… ì—‘ì…€ ì–‘ì‹ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n' +
   671	                      'ğŸ“‹ ì‘ì„± ë°©ë²•:\n' +
   672	                      '1. Sheet 1 (ë¬¼ê±´ëª©ë¡): ê±°ë˜ì²˜ëª…*ê³¼ ë¬¼ê±´ëª…ì„ ì •í™•íˆ ì…ë ¥\n' +
   673	                      '   - 85ì´ˆê³¼: O ë˜ëŠ” X ì…ë ¥ (Y/Në„ ê°€ëŠ¥)\n' +
   674	                      '   - ì·¨ë“ê°€ì•¡/ê¸°íƒ€í•„ìš”ê²½ë¹„ëŠ” í•„ìš”ê²½ë¹„ìƒì„¸ì—ì„œ ìë™ ê³„ì‚°\n\n' +
   675	                      '2. Sheet 2 (í•„ìš”ê²½ë¹„ìƒì„¸): ê±°ë˜ì²˜ëª…*ê³¼ ë¬¼ê±´ëª…*ì„ ë¬¼ê±´ëª©ë¡ê³¼ ë™ì¼í•˜ê²Œ ì…ë ¥\n' +
   676	                      '   - êµ¬ë¶„: "ì·¨ë“ê°€ì•¡" ë˜ëŠ” "ê¸°íƒ€í•„ìš”ê²½ë¹„"ë§Œ ì…ë ¥ (í•„ìˆ˜)\n' +
   677	                      '   - ë²ˆí˜¸ëŠ” ìë™ìœ¼ë¡œ ë¶€ì—¬ë¨\n\n' +
   678	                      'âš ï¸ ì¤‘ìš”: ê±°ë˜ì²˜ëª…ê³¼ ë¬¼ê±´ëª…ì€ ë„ì–´ì“°ê¸°ê¹Œì§€ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ ë§¤ì¹­ë©ë‹ˆë‹¤!\n' +
   679	                      '   (ë³µì‚¬&ë¶™ì—¬ë„£ê¸° ê¶Œì¥)\n\n' +
   680	                      'ì‘ì„± ì™„ë£Œ í›„ "ì¼ê´„ ì—…ë¡œë“œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
   681	            } catch (error) {
   682	                console.error('Excel template download error:', error);
   683	                alert('ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + error.message);
   684	            }
   685	        }
   686	
   687	        // ì¼ê´„ ì—‘ì…€ ì—…ë¡œë“œ ì²˜ë¦¬
   688	        async function handleBulkExcelUpload(event) {
   689	            const file = event.target.files[0];
   690	            if (!file) return;
   691	            
   692	            if (typeof XLSX === 'undefined') {
   693	                alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
   694	                event.target.value = '';
   695	                return;
   696	            }
   697	            
   698	            try {
   699	                showLoading();
   700	                
   701	                console.log('ğŸ“¤ ì—…ë¡œë“œ ì‹œì‘:', file.name, file.size, 'bytes');
   702	                
   703	                const data = await file.arrayBuffer();
   704	                const workbook = XLSX.read(data);
   705	                
   706	                console.log('ğŸ“‹ ì‹œíŠ¸ ëª©ë¡:', workbook.SheetNames);
   707	                
   708	                // Sheet 1: ë¬¼ê±´ëª©ë¡
   709	                const inventorySheet = workbook.Sheets['ë¬¼ê±´ëª©ë¡'];
   710	                if (!inventorySheet) {
   711	                    console.error('âŒ ë¬¼ê±´ëª©ë¡ ì‹œíŠ¸ ì—†ìŒ');
   712	                    throw new Error('ë¬¼ê±´ëª©ë¡ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
   713	                }
   714	                
   715	                // ì›ë³¸ ë°ì´í„° (ë°°ì—´ í˜•ì‹)
   716	                const inventoryRawData = XLSX.utils.sheet_to_json(inventorySheet, { header: 1, defval: '' });
   717	                console.log('ğŸ“Š ì›ë³¸ ì‹œíŠ¸ ì´ í–‰ ìˆ˜:', inventoryRawData.length);
   718	                
   719	                // í—¤ë” í–‰ ì°¾ê¸° (ê±°ë˜ì²˜ëª…* í¬í•¨ëœ í–‰)
   720	                let headerRowIndex = -1;
   721	                for (let i = 0; i < Math.min(10, inventoryRawData.length); i++) {
   722	                    const row = inventoryRawData[i];
   723	                    
   724	                    // ì¡°ê±´ 1: "ê±°ë˜ì²˜ëª…*"ê°€ ìˆì–´ì•¼ í•¨
   725	                    const hasCompanyName = row.some(cell => {
   726	                        const str = String(cell).trim();
   727	                        return str === 'ê±°ë˜ì²˜ëª…*' || str === 'ê±°ë˜ì²˜ëª…' || str === 'íšŒì‚¬ëª…';
   728	                    });
   729	                    
   730	                    // ì¡°ê±´ 2: "ë¬¼ê±´ëª…"ë„ ê°™ì€ í–‰ì— ìˆì–´ì•¼ í•¨
   731	                    const hasPropertyName = row.some(cell => {
   732	                        const str = String(cell).trim();
   733	                        return str === 'ë¬¼ê±´ëª…' || str === 'ë¬¼ê±´ëª…*';
   734	                    });
   735	                    
   736	                    // ì¡°ê±´ 3: ë¹ˆ ì…€ì´ ë„ˆë¬´ ë§ì§€ ì•Šì•„ì•¼ í•¨ (ìµœì†Œ 5ê°œ ì´ìƒì˜ ì»¬ëŸ¼)
   737	                    const nonEmptyCount = row.filter(cell => String(cell).trim() !== '').length;
   738	                    
   739	                    if (hasCompanyName && hasPropertyName && nonEmptyCount >= 5) {
   740	                        headerRowIndex = i;
   741	                        console.log(`âœ… í—¤ë” í–‰ ë°œê²¬: ${i + 1}í–‰`);
   742	                        console.log('ğŸ“‹ í—¤ë”:', row);
   743	                        break;
   744	                    }
   745	                }
   746	                
   747	                if (headerRowIndex === -1) {
   748	                    console.error('âŒ í—¤ë” í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì²˜ìŒ 10í–‰:', inventoryRawData.slice(0, 10));
   749	                    throw new Error('ë¬¼ê±´ëª©ë¡ ì‹œíŠ¸ì—ì„œ "ê±°ë˜ì²˜ëª…*" ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní—¤ë” í–‰ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
   750	                }
   751	                
   752	                // í—¤ë” í–‰ ì´í›„ì˜ ë°ì´í„°ë§Œ JSONìœ¼ë¡œ ë³€í™˜
   753	                const headers = inventoryRawData[headerRowIndex];
   754	                console.log('ğŸ“‹ í—¤ë” ë°°ì—´ ìƒì„¸:', headers);
   755	                console.log('ğŸ“‹ í—¤ë” ê°œìˆ˜:', headers.length);
   756	                headers.forEach((h, idx) => {
   757	                    console.log(`  [${idx}]: "${h}"`);
   758	                });
   759	                
   760	                const dataRows = inventoryRawData.slice(headerRowIndex + 1);
   761	                
   762	                // JSON ë³€í™˜
   763	                const inventoryJson = dataRows.map(row => {
   764	                    const obj = {};
   765	                    headers.forEach((header, idx) => {
   766	                        obj[header] = row[idx] || '';
   767	                    });
   768	                    return obj;
   769	                }).filter(row => {
   770	                    // ì™„ì „íˆ ë¹ˆ í–‰ ì œê±°
   771	                    return Object.values(row).some(val => String(val).trim() !== '');
   772	                });
   773	                
   774	                console.log('âœ… ë¬¼ê±´ëª©ë¡ ë°ì´í„°:', inventoryJson.length, 'í–‰');
   775	                
   776	                if (inventoryJson.length > 0) {
   777	                    console.log('ğŸ“Š ì²« ë²ˆì§¸ ë°ì´í„° í–‰:', inventoryJson[0]);
   778	                    console.log('ğŸ” ì»¬ëŸ¼ëª…:', Object.keys(inventoryJson[0]));
   779	                    
   780	                    // ê° ì»¬ëŸ¼ì˜ ê°’ ì¶œë ¥
   781	                    console.log('ğŸ“‹ ê° ì»¬ëŸ¼ì˜ ê°’:');
   782	                    Object.entries(inventoryJson[0]).forEach(([key, value]) => {
   783	                        console.log(`  "${key}": "${value}"`);
   784	                    });
   785	                }
   786	                
   787	                // Sheet 2: í•„ìš”ê²½ë¹„ìƒì„¸
   788	                // ì›ë³¸ ì‹œíŠ¸ë¥¼ ë°°ì—´ë¡œë„ í™•ì¸ (í—¤ë” ê°ì§€ ë¬¸ì œ í™•ì¸ìš©)
   789	                const rawData = XLSX.utils.sheet_to_json(inventorySheet, { header: 1, defval: '' });
   790	                console.log('ğŸ“Š ì›ë³¸ ì‹œíŠ¸ (ë°°ì—´ í˜•ì‹):');
   791	                console.log('  í–‰ 0 (ì²«ë²ˆì§¸):', rawData[0]);
   792	                console.log('  í–‰ 1 (ë‘ë²ˆì§¸):', rawData[1]);
   793	                console.log('  í–‰ 2 (ì„¸ë²ˆì§¸):', rawData[2]);
   794	                console.log('  í–‰ 3 (ë„¤ë²ˆì§¸):', rawData[3]);
   795	                
   796	                // Sheet 2: í•„ìš”ê²½ë¹„ìƒì„¸
   797	                const expenseSheet = workbook.Sheets['í•„ìš”ê²½ë¹„ìƒì„¸'];
   798	                let expenseJson = [];
   799	                if (expenseSheet) {
   800	                    const expenseRawData = XLSX.utils.sheet_to_json(expenseSheet, { header: 1, defval: '' });
   801	                    console.log('ğŸ“Š í•„ìš”ê²½ë¹„ìƒì„¸ ì›ë³¸ í–‰ ìˆ˜:', expenseRawData.length);
   802	                    
   803	                    // í—¤ë” í–‰ ì°¾ê¸°
   804	                    let expenseHeaderRowIndex = -1;
   805	                    for (let i = 0; i < Math.min(10, expenseRawData.length); i++) {
   806	                        const row = expenseRawData[i];
   807	                        
   808	                        // ì¡°ê±´ 1: "ê±°ë˜ì²˜ëª…*"ê°€ ìˆì–´ì•¼ í•¨
   809	                        const hasCompanyName = row.some(cell => {
   810	                            const str = String(cell).trim();
   811	                            return str === 'ê±°ë˜ì²˜ëª…*' || str === 'ê±°ë˜ì²˜ëª…' || str === 'íšŒì‚¬ëª…';
   812	                        });
   813	                        
   814	                        // ì¡°ê±´ 2: "ë¹„ìš©ëª…" ë˜ëŠ” "êµ¬ë¶„"ì´ ê°™ì€ í–‰ì— ìˆì–´ì•¼ í•¨
   815	                        const hasExpenseField = row.some(cell => {
   816	                            const str = String(cell).trim();
   817	                            return str === 'ë¹„ìš©ëª…' || str.includes('êµ¬ë¶„');
   818	                        });
   819	                        
   820	                        // ì¡°ê±´ 3: ë¹ˆ ì…€ì´ ë„ˆë¬´ ë§ì§€ ì•Šì•„ì•¼ í•¨
   821	                        const nonEmptyCount = row.filter(cell => String(cell).trim() !== '').length;
   822	                        
   823	                        if (hasCompanyName && hasExpenseField && nonEmptyCount >= 4) {
   824	                            expenseHeaderRowIndex = i;
   825	                            console.log(`âœ… í•„ìš”ê²½ë¹„ìƒì„¸ í—¤ë” í–‰ ë°œê²¬: ${i + 1}í–‰`);
   826	                            break;
   827	                        }
   828	                    }
   829	                    
   830	                    if (expenseHeaderRowIndex !== -1) {
   831	                        const expenseHeaders = expenseRawData[expenseHeaderRowIndex];
   832	                        const expenseDataRows = expenseRawData.slice(expenseHeaderRowIndex + 1);
   833	                        
   834	                        expenseJson = expenseDataRows.map(row => {
   835	                            const obj = {};
   836	                            expenseHeaders.forEach((header, idx) => {
   837	                                obj[header] = row[idx] || '';
   838	                            });
   839	                            return obj;
   840	                        }).filter(row => {
   841	                            return Object.values(row).some(val => String(val).trim() !== '');
   842	                        });
   843	                        
   844	                        console.log('âœ… í•„ìš”ê²½ë¹„ìƒì„¸ ë°ì´í„°:', expenseJson.length, 'í–‰');
   845	                    } else {
   846	                        console.log('âš ï¸ í•„ìš”ê²½ë¹„ìƒì„¸ í—¤ë” í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
   847	                    }
   848	                } else {
   849	                    console.log('âš ï¸ í•„ìš”ê²½ë¹„ìƒì„¸ ì‹œíŠ¸ ì—†ìŒ (ì„ íƒì‚¬í•­)');
   850	                }
   851	                
   852	                // ë°ì´í„° ê²€ì¦
   853	                if (inventoryJson.length === 0) {
   854	                    console.error('âŒ ë¬¼ê±´ëª©ë¡ ë°ì´í„° ì—†ìŒ');
   855	                    throw new Error('ë¬¼ê±´ëª©ë¡ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
   856	                }
   857	                
   858	                // ê±°ë˜ì²˜ëª…ë³„ë¡œ ê·¸ë£¹í™”
   859	                const groupedData = {};
   860	                console.log('ğŸ”„ ë°ì´í„° ê·¸ë£¹í™” ì‹œì‘...');
   861	                
   862	                // ìœ ì—°í•œ ì»¬ëŸ¼ëª… ë§¤ì¹­
   863	                const getCompanyName = (row) => {
   864	                    return String(
   865	                        row['ê±°ë˜ì²˜ëª…*'] || 
   866	                        row['ê±°ë˜ì²˜ëª…'] || 
   867	                        row['ê±°ë˜ì²˜ ëª…*'] || 
   868	                        row['ê±°ë˜ì²˜ ëª…'] ||
   869	                        row['íšŒì‚¬ëª…'] ||
   870	                        ''
   871	                    ).trim();
   872	                };
   873	                
   874	                const getPropertyName = (row) => {
   875	                    return String(
   876	                        row['ë¬¼ê±´ëª…'] || 
   877	                        row['ë¬¼ê±´ëª…*'] ||
   878	                        row['ë¬¼ê±´ ëª…'] ||
   879	                        ''
   880	                    ).trim();
   881	                };
   882	                
   883	                for (const row of inventoryJson) {
   884	                    const companyName = getCompanyName(row);
   885	                    const propertyName = getPropertyName(row);
   886	                    
   887	                    console.log('ğŸ“ ì²˜ë¦¬ ì¤‘:', companyName, propertyName);
   888	                    
   889	                    if (!companyName) {
   890	                        console.warn('âš ï¸ ê±°ë˜ì²˜ëª… ì—†ìŒ, ê±´ë„ˆëœ€');
   891	                        console.warn('   í–‰ ë°ì´í„°:', row);
   892	                        continue;
   893	                    }
   894	                    
   895	                    if (!groupedData[companyName]) {
   896	                        groupedData[companyName] = {
   897	                            properties: [],
   898	                            expenses: []
   899	                        };
   900	                    }
   901	                    
   902	                    // 85ì´ˆê³¼ ê²€ì¦ (O/X í˜•ì‹ìœ¼ë¡œ ë³€ê²½)
   903	                    const over85Value = String(
   904	                        row['85ì´ˆê³¼(O/X)'] || 
   905	                        row['85ì´ˆê³¼(Y/N)'] || 
   906	                        row['85ì´ˆê³¼'] || 
   907	                        row['85 ì´ˆê³¼(Y/N)'] ||
   908	                        'X'
   909	                    ).trim().toUpperCase();
   910	                    
   911	                    // O/X ë˜ëŠ” Y/N ëª¨ë‘ í—ˆìš©
   912	                    let over85 = 'N';
   913	                    if (over85Value === 'O' || over85Value === 'Y') {
   914	                        over85 = 'Y';
   915	                    }
   916	                    
   917	                    if (over85Value !== 'Y' && over85Value !== 'N' && over85Value !== 'O' && over85Value !== 'X') {
   918	                        console.warn(`âš ï¸ 85ì´ˆê³¼ ê°’ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤: [${companyName}] ${propertyName} - "${over85Value}" (O/X ë˜ëŠ” Y/Në§Œ ê°€ëŠ¥)`);
   919	                    }
   920	                    
   921	                    // ë¬¼ê±´ ë°ì´í„°
   922	                    const property = {
   923	                        property_name: propertyName,
   924	                        address: row['ì†Œì¬ì§€'] || row['ì£¼ì†Œ'] || '',
   925	                        acquisition_value: 0, // í•„ìš”ê²½ë¹„ ìƒì„¸ì—ì„œ ìë™ ê³„ì‚°
   926	                        other_expenses: 0, // í•„ìš”ê²½ë¹„ ìƒì„¸ì—ì„œ ìë™ ê³„ì‚°
   927	                        transfer_value: parseNumber(row['ì–‘ë„ê°€ì•¡'] || row['ì–‘ë„ ê°€ì•¡']) || 0,
   928	                        acquisition_date: formatDateToISO(row['ì·¨ë“ì¼(YYYYMMDD)'] || row['ì·¨ë“ì¼'] || row['ì·¨ë“ ì¼(YYYYMMDD)']),
   929	                        transfer_date: formatDateToISO(row['ì–‘ë„ì¼(YYYYMMDD)'] || row['ì–‘ë„ì¼'] || row['ì–‘ë„ ì¼(YYYYMMDD)']),
   930	                        report_deadline: '', // ì–‘ë„ì¼ì—ì„œ ìë™ ê³„ì‚°
   931	                        prepaid_income_tax: parseNumber(row['ê¸°ë‚©ë¶€ ì¢…ì†Œì„¸'] || row['ê¸°ë‚©ë¶€ì¢…ì†Œì„¸']) || 0,
   932	                        prepaid_local_tax: parseNumber(row['ê¸°ë‚©ë¶€ ì§€ë°©ì†Œë“ì„¸'] || row['ê¸°ë‚©ë¶€ì§€ë°©ì†Œë“ì„¸']) || 0,
   933	                        over_85: over85,
   934	                        progress_stage: 'ë¯¸í™•ì¸',
   935	                        remarks: row['ë¹„ê³ '] || '',
   936	                        expenses: []
   937	                    };
   938	                    
   939	                    // ì‹ ê³ ê¸°í•œ ìë™ ê³„ì‚° (ì–‘ë„ì¼ì´ ì†í•œ ë‹¬ì˜ ë§ì¼ë¡œë¶€í„° 2ê°œì›” í›„)
   940	                    if (property.transfer_date) {
   941	                        try {
   942	                            const transferDate = new Date(property.transfer_date);
   943	                            // ì–‘ë„ì¼ì´ ì†í•œ ë‹¬ì˜ ë§ì¼
   944	                            const endOfMonth = new Date(transferDate.getFullYear(), transferDate.getMonth() + 1, 0);
   945	                            // 2ê°œì›” í›„ì˜ ë§ì¼
   946	                            const deadline = new Date(endOfMonth.getFullYear(), endOfMonth.getMonth() + 3, 0);
   947	                            property.report_deadline = deadline.toISOString().split('T')[0];
   948	                            console.log(`ğŸ“… ì‹ ê³ ê¸°í•œ ê³„ì‚°: ì–‘ë„ì¼ ${property.transfer_date} â†’ ì‹ ê³ ê¸°í•œ ${property.report_deadline}`);
   949	                        } catch (e) {
   950	                            console.warn('ì‹ ê³ ê¸°í•œ ê³„ì‚° ì‹¤íŒ¨:', e);
   951	                        }
   952	                    }
   953	                    
   954	                    groupedData[companyName].properties.push(property);
   955	                }
   956	                
   957	                // í•„ìš”ê²½ë¹„ ë§¤ì¹­ ë° ìë™ ë„˜ë²„ë§
   958	                let matchedExpenseCount = 0;
   959	                let unmatchedExpenses = [];
   960	                
   961	                for (const expenseRow of expenseJson) {
   962	                    const companyName = getCompanyName(expenseRow);
   963	                    const propertyName = String(
   964	                        expenseRow['ë¬¼ê±´ëª…*'] || 
   965	                        expenseRow['ë¬¼ê±´ëª…* (ë¬¼ê±´ëª©ë¡ê³¼ ë™ì¼)'] || 
   966	                        expenseRow['ë¬¼ê±´ëª…'] ||
   967	                        ''
   968	                    ).trim();
   969	                    
   970	                    if (!companyName || !propertyName) continue;
   971	                    
   972	                    // êµ¬ë¶„ ê²€ì¦
   973	                    const categoryValue = String(
   974	                        expenseRow['êµ¬ë¶„(ì·¨ë“ê°€ì•¡/ê¸°íƒ€í•„ìš”ê²½ë¹„)'] || 
   975	                        expenseRow['êµ¬ë¶„'] ||
   976	                        ''
   977	                    ).trim();
   978	                    if (categoryValue !== 'ì·¨ë“ê°€ì•¡' && categoryValue !== 'ê¸°íƒ€í•„ìš”ê²½ë¹„') {
   979	                        console.warn(`âš ï¸ êµ¬ë¶„ ê°’ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤: [${companyName}] ${propertyName} - "${categoryValue}" (ì·¨ë“ê°€ì•¡ ë˜ëŠ” ê¸°íƒ€í•„ìš”ê²½ë¹„ë§Œ ê°€ëŠ¥)`);
   980	                        continue; // ì˜ëª»ëœ êµ¬ë¶„ì€ ê±´ë„ˆëœ€
   981	                    }
   982	                    
   983	                    const expense = {
   984	                        no: '', // ìë™ ë„˜ë²„ë§ (ë‚˜ì¤‘ì— ì„¤ì •)
   985	                        expense_name: expenseRow['ë¹„ìš©ëª…'] || expenseRow['ê²½ë¹„ëª…'] || '',
   986	                        category: categoryValue,
   987	                        amount: parseNumber(expenseRow['ê¸ˆì•¡']) || 0,
   988	                        preliminary_approved: expenseRow['ë¹„ìš©ì¸ì •(O/X)'] || expenseRow['ë¹„ìš©ì¸ì •'] || 'X',
   989	                        remarks: ''
   990	                    };
   991	                    
   992	                    // í•´ë‹¹ ê±°ë˜ì²˜ëª…ê³¼ ë¬¼ê±´ëª…ì— ë§¤ì¹­
   993	                    let matched = false;
   994	                    if (groupedData[companyName]) {
   995	                        for (const property of groupedData[companyName].properties) {
   996	                            if (property.property_name === propertyName) {
   997	                                property.expenses.push(expense);
   998	                                matched = true;
   999	                                matchedExpenseCount++;
  1000	                                break;
  1001	                            }
  1002	                        }
  1003	                    }
  1004	                    
  1005	                    // ë§¤ì¹­ ì‹¤íŒ¨ ê¸°ë¡
  1006	                    if (!matched) {
  1007	                        unmatchedExpenses.push({
  1008	                            companyName: companyName,
  1009	                            propertyName: propertyName,
  1010	                            expenseName: expense.expense_name
  1011	                        });
  1012	                    }
  1013	                }
  1014	                
  1015	                // ê° ë¬¼ê±´ì˜ í•„ìš”ê²½ë¹„ ìë™ ë„˜ë²„ë§ ë° ì·¨ë“ê°€ì•¡/ê¸°íƒ€í•„ìš”ê²½ë¹„ ê³„ì‚°
  1016	                for (const companyName in groupedData) {
  1017	                    for (const property of groupedData[companyName].properties) {
  1018	                        let acquisitionTotal = 0;
  1019	                        let otherExpensesTotal = 0;
  1020	                        
  1021	                        property.expenses.forEach((expense, idx) => {
  1022	                            // ìë™ ë„˜ë²„ë§
  1023	                            expense.no = String(idx + 1);
  1024	                            
  1025	                            // êµ¬ë¶„ì— ë”°ë¼ í•©ê³„ ê³„ì‚°
  1026	                            if (expense.category === 'ì·¨ë“ê°€ì•¡') {
  1027	                                acquisitionTotal += expense.amount;
  1028	                            } else if (expense.category === 'ê¸°íƒ€í•„ìš”ê²½ë¹„') {
  1029	                                otherExpensesTotal += expense.amount;
  1030	                            }
  1031	                        });
  1032	                        
  1033	                        // ë¬¼ê±´ì˜ ì·¨ë“ê°€ì•¡ê³¼ ê¸°íƒ€í•„ìš”ê²½ë¹„ ì„¤ì •
  1034	                        property.acquisition_value = acquisitionTotal;
  1035	                        property.other_expenses = otherExpensesTotal;
  1036	                        
  1037	                        // ì–‘ë„ì†Œë“ ìë™ ê³„ì‚°
  1038	                        property.transfer_income = property.transfer_value - property.acquisition_value - property.other_expenses;
  1039	                        
  1040	                        console.log(`  ë¬¼ê±´: ${property.property_name}`);
  1041	                        console.log(`    ì·¨ë“ê°€ì•¡: ${acquisitionTotal.toLocaleString()}ì›`);
  1042	                        console.log(`    ê¸°íƒ€í•„ìš”ê²½ë¹„: ${otherExpensesTotal.toLocaleString()}ì›`);
  1043	                        console.log(`    ì–‘ë„ê°€ì•¡: ${property.transfer_value.toLocaleString()}ì›`);
  1044	                        console.log(`    ì–‘ë„ì†Œë“: ${property.transfer_income.toLocaleString()}ì›`);
  1045	                    }
  1046	                }
  1047	                
  1048	                // ê° ê±°ë˜ì²˜ëª…ë³„ë¡œ ë°ì´í„° ì €ì¥
  1049	                let successCount = 0;
  1050	                let failCount = 0;
  1051	                const errors = [];
  1052	                
  1053	                console.log('ğŸ’¾ ë°ì´í„° ì €ì¥ ì‹œì‘...');
  1054	                console.log('ğŸ“Š ê·¸ë£¹í™”ëœ ê±°ë˜ì²˜ ìˆ˜:', Object.keys(groupedData).length);
  1055	                
  1056	                for (const [companyName, data] of Object.entries(groupedData)) {
  1057	                    console.log(`\nğŸ” ì²˜ë¦¬ ì¤‘: ${companyName}`);
  1058	                    console.log(`  ë¬¼ê±´ ìˆ˜: ${data.properties.length}ê°œ`);
  1059	                    
  1060	                    try {
  1061	                        // ê±°ë˜ì²˜ëª…ìœ¼ë¡œ ê³ ê°ì‚¬ ì°¾ê¸°
  1062	                        const client = allTraders.find(t => {
  1063	                            const clientName = (t.company_name || '').trim();
  1064	                            const targetName = companyName.trim();
  1065	                            return clientName === targetName;
  1066	                        });
  1067	                        
  1068	                        if (!client) {
  1069	                            const errorMsg = `ê±°ë˜ì²˜ëª… ${companyName}: ê³ ê°ì‚¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
  1070	                            console.error('âŒ', errorMsg);
  1071	                            errors.push(errorMsg);
  1072	                            failCount += data.properties.length;
  1073	                            continue;
  1074	                        }
  1075	                        
  1076	                        console.log(`  âœ… ê³ ê°ì‚¬ ì°¾ìŒ: ${client.company_name} (ID: ${client.id})`);
  1077	                        
  1078	                        // localStorageì— ì €ì¥
  1079	                        const storageKey = `trader_inventory_${client.id}`;
  1080	                        let existingData = [];
  1081	                        
  1082	                        try {
  1083	                            const stored = localStorage.getItem(storageKey);
  1084	                            if (stored) {
  1085	                                existingData = JSON.parse(stored);
  1086	                                console.log(`  ğŸ“¦ ê¸°ì¡´ ë°ì´í„°: ${existingData.length}ê°œ`);
  1087	                            }
  1088	                        } catch (e) {
  1089	                            console.warn('ê¸°ì¡´ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
  1090	                        }
  1091	                        
  1092	                        // ìƒˆ ë°ì´í„° ì¶”ê°€ (ê¸°ì¡´ ë°ì´í„° ìœ ì§€)
  1093	                        const updatedData = [...existingData, ...data.properties];
  1094	                        localStorage.setItem(storageKey, JSON.stringify(updatedData));
  1095	                        
  1096	                        console.log(`  ğŸ’¾ ì €ì¥ ì™„ë£Œ: ${data.properties.length}ê°œ ë¬¼ê±´ ì¶”ê°€`);
  1097	                        console.log(`  ğŸ“Š ì´ ë°ì´í„°: ${updatedData.length}ê°œ`);
  1098	                        
  1099	                        successCount += data.properties.length;
  1100	                    } catch (error) {
  1101	                        console.error(`ê±°ë˜ì²˜ëª… ${companyName} ì²˜ë¦¬ ì‹¤íŒ¨:`, error);
  1102	                        errors.push(`ê±°ë˜ì²˜ëª… ${companyName}: ${error.message}`);
  1103	                        failCount += data.properties.length;
  1104	                    }
  1105	                }
  1106	                
  1107	                hideLoading();
  1108	                event.target.value = '';
  1109	                
  1110	                console.log('\nğŸ“Š ìµœì¢… ê²°ê³¼:');
  1111	                console.log(`  âœ… ì„±ê³µ: ${successCount}ê±´`);
  1112	                console.log(`  âŒ ì‹¤íŒ¨: ${failCount}ê±´`);
  1113	                console.log(`  ğŸ’° í•„ìš”ê²½ë¹„ ë§¤ì¹­: ${matchedExpenseCount}ê±´`);
  1114	                console.log(`  âš ï¸ í•„ìš”ê²½ë¹„ ë¯¸ë§¤ì¹­: ${unmatchedExpenses.length}ê±´`);
  1115	                
  1116	                // ê²°ê³¼ ì•Œë¦¼
  1117	                let message = `âœ… ì—…ë¡œë“œ ì™„ë£Œ!\n\n`;
  1118	                message += `ğŸ“¦ ë¬¼ê±´ ëª©ë¡: ${successCount}ê±´ ì„±ê³µ, ${failCount}ê±´ ì‹¤íŒ¨\n`;
  1119	                message += `ğŸ’° í•„ìš”ê²½ë¹„: ${matchedExpenseCount}ê±´ ë§¤ì¹­`;
  1120	                
  1121	                if (unmatchedExpenses.length > 0) {
  1122	                    message += `, ${unmatchedExpenses.length}ê±´ ë§¤ì¹­ ì‹¤íŒ¨`;
  1123	                }
  1124	                
  1125	                if (errors.length > 0) {
  1126	                    message += '\n\n[ë¬¼ê±´ ë“±ë¡ ì˜¤ë¥˜]\n' + errors.slice(0, 3).join('\n');
  1127	                    if (errors.length > 3) {
  1128	                        message += `\n... ì™¸ ${errors.length - 3}ê±´`;
  1129	                    }
  1130	                }
  1131	                
  1132	                if (unmatchedExpenses.length > 0) {
  1133	                    message += '\n\n[í•„ìš”ê²½ë¹„ ë§¤ì¹­ ì‹¤íŒ¨]\n';
  1134	                    message += 'âš ï¸ ë¬¼ê±´ëª…ì´ ì¼ì¹˜í•˜ì§€ ì•Šì•„ ì—°ê²°ë˜ì§€ ì•Šì€ ê²½ë¹„:\n';
  1135	                    const samples = unmatchedExpenses.slice(0, 3);
  1136	                    for (const exp of samples) {
  1137	                        message += `- ${exp.companyName} / "${exp.propertyName}" / ${exp.expenseName}\n`;
  1138	                    }
  1139	                    if (unmatchedExpenses.length > 3) {
  1140	                        message += `... ì™¸ ${unmatchedExpenses.length - 3}ê±´`;
  1141	                    }
  1142	                    message += '\nğŸ’¡ ë¬¼ê±´ëª…ì„ ë¬¼ê±´ëª©ë¡ ì‹œíŠ¸ì™€ ì •í™•íˆ ì¼ì¹˜ì‹œì¼œì£¼ì„¸ìš”.';
  1143	                }
  1144	                
  1145	                alert(message);
  1146	                
  1147	                if (successCount > 0) {
  1148	                    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì œì•ˆ
  1149	                    if (confirm('ì—…ë¡œë“œëœ ë°ì´í„°ë¥¼ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(í™•ì¸ ì‹œ í˜ì´ì§€ê°€ ìƒˆë¡œê³ ì¹¨ë©ë‹ˆë‹¤)')) {
  1150	                        location.reload();
  1151	                    }
  1152	                }
  1153	                
  1154	            } catch (error) {
  1155	                hideLoading();
  1156	                event.target.value = '';
  1157	                console.error('Bulk upload error:', error);
  1158	                alert('âŒ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' + error.message + '\n\nì–‘ì‹ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  1159	            }
  1160	        }
  1161	
  1162	        // ë‚ ì§œ í¬ë§· ë³€í™˜ í•¨ìˆ˜ (YYYYMMDD â†’ YYYY-MM-DD, ì—‘ì…€ ì‹œë¦¬ì–¼ ë²ˆí˜¸ ì§€ì›)
  1163	        function formatDateToISO(dateStr) {
  1164	            if (!dateStr) return '';
  1165	            
  1166	            const str = String(dateStr).trim();
  1167	            
  1168	            // 1) ì—‘ì…€ ì‹œë¦¬ì–¼ ë²ˆí˜¸ ê°ì§€ (ìˆ«ìë§Œ ìˆê³ , 8ìë¦¬ê°€ ì•„ë‹ˆê³ , 5ìë¦¬ ì •ë„)
  1169	            // ì—‘ì…€ ë‚ ì§œ ì‹œë¦¬ì–¼: 1900-01-01 ê¸°ì¤€ (ì‹œë¦¬ì–¼ ë²ˆí˜¸ 1)
  1170	            // ì˜ˆ: 45700 = 2025-02-08
  1171	            const numOnly = str.replace(/[^0-9]/g, '');
  1172	            if (numOnly === str && numOnly.length >= 4 && numOnly.length <= 6) {
  1173	                const serialNumber = parseInt(numOnly, 10);
  1174	                
  1175	                // ì—‘ì…€ ë‚ ì§œ ì‹œë¦¬ì–¼ ë²”ìœ„ ì²´í¬ (1900ë…„ ~ 2100ë…„ ì •ë„)
  1176	                // 1: 1900-01-01, 45700: 2025ë…„, 73050: 2100ë…„
  1177	                if (serialNumber >= 1 && serialNumber <= 80000) {
  1178	                    // ì—‘ì…€ ì‹œë¦¬ì–¼ â†’ Date ê°ì²´
  1179	                    // ì—‘ì…€ì€ 1900-01-01ì„ 1ë¡œ ì‹œì‘ (ë‹¨, 1900ë…„ ìœ¤ë…„ ë²„ê·¸ ë³´ì • í•„ìš”)
  1180	                    const excelEpoch = new Date(1899, 11, 30); // 1899-12-30 (ì—‘ì…€ ê¸°ì¤€ì¼)
  1181	                    const jsDate = new Date(excelEpoch.getTime() + serialNumber * 24 * 60 * 60 * 1000);
  1182	                    
  1183	                    // YYYY-MM-DD í¬ë§·
  1184	                    const year = jsDate.getFullYear();
  1185	                    const month = String(jsDate.getMonth() + 1).padStart(2, '0');
  1186	                    const day = String(jsDate.getDate()).padStart(2, '0');
  1187	                    
  1188	                    console.log(`ğŸ“… ì—‘ì…€ ì‹œë¦¬ì–¼ ë³€í™˜: ${serialNumber} â†’ ${year}-${month}-${day}`);
  1189	                    return `${year}-${month}-${day}`;
  1190	                }
  1191	            }
  1192	            
  1193	            // 2) YYYYMMDD í˜•ì‹ (8ìë¦¬)
  1194	            if (numOnly.length === 8) {
  1195	                return `${numOnly.slice(0, 4)}-${numOnly.slice(4, 6)}-${numOnly.slice(6, 8)}`;
  1196	            }
  1197	            
  1198	            // 3) ì´ë¯¸ YYYY-MM-DD í˜•ì‹ì´ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
  1199	            if (/^\d{4}-\d{2}-\d{2}$/.test(str)) {
  1200	                return str;
  1201	            }
  1202	            
  1203	            // 4) ë³€í™˜ ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
  1204	            console.warn(`âš ï¸ ë‚ ì§œ í˜•ì‹ ì¸ì‹ ì‹¤íŒ¨: "${dateStr}"`);
  1205	            return dateStr;
  1206	        }
  1207	
  1208	        // ìˆ«ì íŒŒì‹± í•¨ìˆ˜
  1209	        function parseNumber(value) {
  1210	            if (!value || value === '') return 0;
  1211	            const str = String(value).replace(/[^0-9.-]/g, '');
  1212	            return parseFloat(str) || 0;
  1213	        }
  1214	
  1215	        // ============================================
  1216	
  1217	        // Load on page load
  1218	        console.log('ğŸ“¥ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ - loadTraders() í˜¸ì¶œ ì¤€ë¹„');
  1219	        
  1220	        // DOMì´ ì™„ì „íˆ ë¡œë“œëœ í›„ ì‹¤í–‰
  1221	        if (document.readyState === 'loading') {
  1222	            console.log('â³ DOM ë¡œë”© ëŒ€ê¸° ì¤‘...');
  1223	            document.addEventListener('DOMContentLoaded', () => {
  1224	                console.log('âœ… DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ');
  1225	                loadTraders();
  1226	            });
  1227	        } else {
  1228	            console.log('âœ… DOM ì´ë¯¸ ë¡œë“œë¨ - ì¦‰ì‹œ ì‹¤í–‰');
  1229	            loadTraders();
  1230	        }
  1231	    </script>
  1232	</body>
  1233	</html>
  1234	
