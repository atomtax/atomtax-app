<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¤ë§¤ì‚¬ì—…ì ë°ì´í„° - ì•„í†°ì„¸ë¬´íšŒê³„</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Preconnect to CDNs for faster loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    
    <!-- Font Awesome (ìµœì†Œí™”: solid ì•„ì´ì½˜ë§Œ) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/fontawesome.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/solid.min.css">
    
    <!-- Google Fonts (ìµœì í™”: í•„ìš”í•œ ì›¨ì´íŠ¸ë§Œ) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Preload critical CSS -->
    <link rel="preload" href="css/style.css" as="style">
    <link rel="preload" href="css/traders-performance.css" as="style">
    
    <!-- Preload JavaScript -->
    <link rel="preload" href="js/common.js" as="script">
    
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/traders-performance.css">
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="trader-performance">
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <span>ì•„í†°ì„¸ë¬´íšŒê³„</span>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-home"></i>
                    <span>ëŒ€ì‹œë³´ë“œ</span>
                </a>
                
                <!-- ê³ ê°ì‚¬ ê´€ë¦¬ (ë“œë¡­ë‹¤ìš´) -->
                <div class="nav-dropdown">
                    <a href="#" class="nav-item" onclick="toggleDropdown(event)">
                        <i class="fas fa-building"></i>
                        <span>ê³ ê°ì‚¬ ê´€ë¦¬</span>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </a>
                    <div class="dropdown-content">
                        <a href="clients.html" class="dropdown-item">
                            <i class="fas fa-briefcase"></i>
                            <span>ê¸°ì¥ê³ ê° ê´€ë¦¬</span>
                        </a>
                        <a href="clients-terminated.html" class="dropdown-item">
                            <i class="fas fa-user-times"></i>
                            <span>í•´ì„ê³ ê° ê´€ë¦¬</span>
                        </a>
                    </div>
                </div>
                
                <!-- ë§¤ë§¤ì‚¬ì—…ì ê´€ë¦¬ (ë“œë¡­ë‹¤ìš´) -->
                <div class="nav-dropdown active">
                    <a href="#" class="nav-item" onclick="toggleDropdown(event)">
                        <i class="fas fa-store"></i>
                        <span>ë§¤ë§¤ì‚¬ì—…ì ê´€ë¦¬</span>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </a>
                    <div class="dropdown-content">
                        <a href="traders-data.html" class="dropdown-item active">
                            <i class="fas fa-database"></i>
                            <span>ë§¤ë§¤ì‚¬ì—…ì ë°ì´í„°</span>
                        </a>
                        <a href="traders-checklist.html" class="dropdown-item">
                            <i class="fas fa-check-square"></i>
                            <span>ë§¤ë§¤ì‚¬ì—…ì ì²´í¬ë¦¬ìŠ¤íŠ¸</span>
                        </a>
                        <a href="traders-vat.html" class="dropdown-item">
                            <i class="fas fa-calculator"></i>
                            <span>ë¶€ê°€ê°€ì¹˜ì„¸ ê³„ì‚°</span>
                        </a>
                    </div>
                </div>
                
                <a href="#" class="nav-item">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>ì„¸ë¬´ ê´€ë¦¬</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="fas fa-chart-bar"></i>
                    <span>í†µê³„ ë¶„ì„</span>
                </a>
                <a href="#" class="nav-item">
                    <i class="fas fa-cog"></i>
                    <span>ì„¤ì •</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <button id="logoutBtn" class="nav-item" style="width: 100%; border: none; background: none;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>ë¡œê·¸ì•„ì›ƒ</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="topbar">
                <div class="topbar-left">
                    <button class="menu-toggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="topbar-title">ë§¤ë§¤ì‚¬ì—…ì ë°ì´í„°</h1>
                </div>
                
                <div class="topbar-right">
                    <div class="topbar-search">
                        <input type="text" id="globalSearch" placeholder="ê²€ìƒ‰...">
                        <i class="fas fa-search"></i>
                    </div>
                    
                    <div class="user-profile">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <div class="user-info">
                            <div class="user-name" id="userName">ê´€ë¦¬ì</div>
                            <div class="user-role" id="userRole">Admin</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Filter Toolbar (ê³ ê°ì‚¬ ê´€ë¦¬ì™€ ë™ì¼í•œ ë””ìì¸) -->
                <div class="card">
                    <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center; justify-content: space-between; padding: 20px 24px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
                            <!-- Manager Filter -->
                            <select id="managerFilter" class="px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-500" style="min-width: 150px;">
                                <option value="">ì „ì²´ ë‹´ë‹¹ì</option>
                            </select>
                            
                            <!-- Company Name Search -->
                            <input type="text" id="companyNameSearch" class="px-4 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-500" placeholder="ê±°ë˜ì²˜ëª… ê²€ìƒ‰..." style="width: 250px;">
                        </div>
                        
                        <div style="display: flex; gap: 12px;">
                            <!-- ì¼ê´„ ì—‘ì…€ ì—…ë¡œë“œ ë²„íŠ¼ -->
                            <button onclick="downloadBulkExcelTemplate()" class="btn btn-success">
                                <i class="fas fa-download"></i> ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
                            </button>
                            <button onclick="document.getElementById('bulkExcelUpload').click()" class="btn btn-primary">
                                <i class="fas fa-upload"></i> ì¼ê´„ ì—…ë¡œë“œ
                            </button>
                            <input type="file" id="bulkExcelUpload" accept=".xlsx, .xls" style="display: none;" onchange="handleBulkExcelUpload(event)">
                            
                            <!-- ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ -->
                            <button onclick="refreshData()" class="btn btn-secondary">
                                <i class="fas fa-sync-alt"></i> ìƒˆë¡œê³ ì¹¨
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Traders List -->
                <div class="card">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 class="card-title">
                            <i class="fas fa-store mr-2"></i>
                            ë§¤ë§¤ì‚¬ì—…ì ëª©ë¡
                        </h3>
                        <div style="color: #6b7280; font-size: 14px;">
                            <span>ì—…ì¢…ì½”ë“œ: 703011, 703012</span>
                            <span style="margin-left: 16px;">ì´ <strong id="traderCount" style="color: #667eea;">0</strong>ê°œ</span>
                        </div>
                    </div>
                    
                    <!-- Loading -->
                    <div id="loading" style="text-align: center; padding: 60px;">
                        <div class="spinner" style="margin: 0 auto;"></div>
                        <p style="margin-top: 16px; color: #6b7280;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                    </div>
                    
                    <!-- Traders Grid -->
                    <div id="tradersGridContainer" style="display: none; padding: 24px;">
                        <!-- ë‹´ë‹¹ìë³„ ê·¸ë¦¬ë“œê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                    
                    <!-- Empty State -->
                    <div id="emptyState" style="display: none; text-align: center; padding: 60px;">
                        <i class="fas fa-inbox" style="font-size: 64px; color: #d1d5db; margin-bottom: 16px;"></i>
                        <p style="color: #6b7280; font-size: 16px;">ë§¤ë§¤ì‚¬ì—…ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p style="color: #9ca3af; font-size: 14px; margin-top: 8px;">
                            ê³ ê°ì‚¬ ê´€ë¦¬ì—ì„œ ì—…ì¢…ì½”ë“œê°€ 703011 ë˜ëŠ” 703012ì¸ ê³ ê°ì‚¬ë¥¼ ì¶”ê°€í•˜ë©´<br>
                            ìë™ìœ¼ë¡œ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase Configuration and Auth -->
    <script src="js/supabase-config.js"></script>
    <script src="js/supabase-auth.js"></script>
    <script src="js/supabase-db.js"></script>
    <script src="js/common.js"></script>
    <script src="js/auto-backup.js"></script>
    <script>
        console.log('ğŸš€ traders-data.html ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘');
        
        // Check authentication with Supabase
        SupabaseAuth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            
            // Display user info from Firestore
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    document.getElementById('userName').textContent = userData.name || user.email;
                    document.getElementById('userRole').textContent = userData.role === 'admin' ? 'ê´€ë¦¬ì' : 'ë§¤ë‹ˆì €';
                    document.getElementById('userAvatar').textContent = (userData.name || user.email).charAt(0).toUpperCase();
                } else {
                    const displayName = user.displayName || user.email.split('@')[0];
                    document.getElementById('userName').textContent = displayName;
                    document.getElementById('userRole').textContent = 'ë§¤ë‹ˆì €';
                    document.getElementById('userAvatar').textContent = displayName.charAt(0).toUpperCase();
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
                const displayName = user.displayName || user.email.split('@')[0];
                document.getElementById('userName').textContent = displayName;
                document.getElementById('userRole').textContent = 'ë§¤ë‹ˆì €';
                document.getElementById('userAvatar').textContent = displayName.charAt(0).toUpperCase();
            }
        });

        // Global variables
        let allTraders = [];
        let filteredTraders = [];
        let selectedManager = '';
        
        // Cache settings
        const CACHE_KEY = 'traders_data_cache';
        const CACHE_TIME_KEY = 'traders_data_cache_time';
        const CACHE_DURATION = 5 * 60 * 1000; // 5ë¶„

        // Load traders (ì—…ì¢…ì½”ë“œ 703011, 703012)
        async function loadTraders(forceRefresh = false) {
            console.log('ğŸ”„ loadTraders() ì‹œì‘, forceRefresh:', forceRefresh);
            console.time('â±ï¸ Total Load Time');
            try {
                // ë¡œë”© í‘œì‹œ
                const loadingEl = document.getElementById('loading');
                const gridEl = document.getElementById('tradersGridContainer');
                const emptyEl = document.getElementById('emptyState');
                
                if (!loadingEl || !gridEl || !emptyEl) {
                    console.error('âŒ í•„ìˆ˜ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                    throw new Error('Required DOM elements not found');
                }
                
                loadingEl.style.display = 'block';
                gridEl.style.display = 'none';
                emptyEl.style.display = 'none';
                console.log('âœ… ë¡œë”© í‘œì‹œ í™œì„±í™”');
                
                // ğŸ”¹ ìºì‹œ í™•ì¸ (forceRefreshê°€ falseì¼ ë•Œë§Œ)
                if (!forceRefresh) {
                    const cachedData = localStorage.getItem(CACHE_KEY);
                    const cacheTime = localStorage.getItem(CACHE_TIME_KEY);
                    
                    if (cachedData && cacheTime) {
                        const elapsed = Date.now() - parseInt(cacheTime);
                        if (elapsed < CACHE_DURATION) {
                            console.log(`âœ… Using cached data (age: ${Math.round(elapsed/1000)}s / ${CACHE_DURATION/1000}s)`);
                            allTraders = JSON.parse(cachedData);
                            
                            if (allTraders.length === 0) {
                                showEmptyState();
                            } else {
                                console.time('â±ï¸ Populate Filters Time');
                                populateFilters();
                                console.timeEnd('â±ï¸ Populate Filters Time');
                                
                                console.time('â±ï¸ Render Grid Time');
                                filteredTraders = [...allTraders];
                                applyFilters();
                                console.timeEnd('â±ï¸ Render Grid Time');
                            }
                            
                            console.timeEnd('â±ï¸ Total Load Time');
                            return;
                        } else {
                            console.log('â° Cache expired, fetching new data...');
                        }
                    }
                }
                
                // API í˜¸ì¶œ
                console.log('ğŸŒ API í˜¸ì¶œ ì‹œì‘...');
                console.time('â±ï¸ API Fetch Time');
                
                // Get all clients
                let allClients = [];
                
                try {
                    let page = 1;
                    let hasMore = true;
                    
                    while (hasMore) {
                        console.log(`ğŸ“¡ í˜ì´ì§€ ${page} ìš”ì²­ ì¤‘...`);
                        const response = await fetch(`tables/clients?limit=1000&page=${page}`);
                        console.log(`ğŸ“¥ í˜ì´ì§€ ${page} ì‘ë‹µ:`, response.status, response.ok);
                        
                        if (!response.ok) throw new Error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                        
                        const result = await response.json();
                        const clients = result.data || [];
                        console.log(`âœ… í˜ì´ì§€ ${page}: ${clients.length}ê°œ ê³ ê°ì‚¬ ë¡œë“œë¨`);
                        
                        if (clients.length === 0) {
                            hasMore = false;
                        } else {
                            allClients = allClients.concat(clients);
                            page++;
                            if (clients.length < 1000) hasMore = false;
                        }
                    }
                    console.log(`ğŸ“Š ì´ ${allClients.length}ê°œ ê³ ê°ì‚¬ ë¡œë“œ ì™„ë£Œ`);
                    console.timeEnd('â±ï¸ API Fetch Time');
                } catch (fetchError) {
                    console.timeEnd('â±ï¸ API Fetch Time');
                    console.warn('API í˜¸ì¶œ ì‹¤íŒ¨ - Preview ëª¨ë“œë¡œ ì „í™˜í•©ë‹ˆë‹¤:', fetchError);
                    // Preview mode: use mock data
                    allClients = createMockTraders();
                }
                
                // Filter by business code (703011, 703012)
                console.time('â±ï¸ Filter Time');
                allTraders = allClients.filter(client => {
                    const code = (client.business_code || '').trim();
                    return code === '703011' || code === '703012';
                });
                console.timeEnd('â±ï¸ Filter Time');
                
                console.log(`âœ… Filtered ${allTraders.length} traders from ${allClients.length} clients`);
                
                // ğŸ”¹ ìºì‹œ ì €ì¥
                localStorage.setItem(CACHE_KEY, JSON.stringify(allTraders));
                localStorage.setItem(CACHE_TIME_KEY, Date.now().toString());
                console.log('ğŸ’¾ Data cached for 5 minutes');
                
                if (allTraders.length === 0) {
                    showEmptyState();
                } else {
                    console.time('â±ï¸ Populate Filters Time');
                    populateFilters();
                    console.timeEnd('â±ï¸ Populate Filters Time');
                    
                    console.time('â±ï¸ Render Grid Time');
                    filteredTraders = [...allTraders];
                    applyFilters();
                    console.timeEnd('â±ï¸ Render Grid Time');
                }
                
                console.timeEnd('â±ï¸ Total Load Time');
            } catch (error) {
                console.timeEnd('â±ï¸ Total Load Time');
                console.error('Error loading traders:', error);
                showNotification('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                showEmptyState();
            }
        }
        
        // ğŸ”¹ ìºì‹œ ì´ˆê¸°í™” ë° ìƒˆë¡œê³ ì¹¨
        function refreshData() {
            localStorage.removeItem(CACHE_KEY);
            localStorage.removeItem(CACHE_TIME_KEY);
            console.log('ğŸ”„ Cache cleared, reloading data...');
            showNotification('ë°ì´í„°ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤...', 'info');
            loadTraders(true); // forceRefresh = true
        }

        // Populate filters
        function populateFilters() {
            // Get unique managers
            const managers = [...new Set(allTraders.map(t => t.manager).filter(m => m))].sort();
            const managerFilter = document.getElementById('managerFilter');
            managerFilter.innerHTML = '<option value="">ì „ì²´ ë‹´ë‹¹ì</option>' + 
                managers.map(m => `<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join('');
        }

        // Apply filters
        function applyFilters() {
            const managerFilter = document.getElementById('managerFilter').value;
            const companyNameSearch = document.getElementById('companyNameSearch').value.toLowerCase();
            
            filteredTraders = allTraders.filter(trader => {
                // Manager filter
                if (managerFilter && trader.manager !== managerFilter) return false;
                
                // Company name search
                if (companyNameSearch) {
                    const companyName = (trader.company_name || '').toLowerCase();
                    if (!companyName.includes(companyNameSearch)) return false;
                }
                
                return true;
            });
            
            document.getElementById('traderCount').textContent = filteredTraders.length;
            
            if (filteredTraders.length === 0) {
                showEmptyState();
            } else {
                renderTradersGrid(filteredTraders);
            }
        }

        // Reset filters
        function resetFilters() {
            document.getElementById('managerFilter').value = '';
            document.getElementById('companyNameSearch').value = '';
            applyFilters();
        }

        function renderTradersGrid(traders) {
            console.log('ğŸ¨ renderTradersGrid() í˜¸ì¶œë¨, traders.length:', traders.length);
            
            // Group by manager
            const byManager = {};
            traders.forEach(trader => {
                const manager = trader.manager || 'ë¯¸ì§€ì •';
                if (!byManager[manager]) {
                    byManager[manager] = [];
                }
                byManager[manager].push(trader);
            });
            
            console.log('ğŸ‘¥ ë‹´ë‹¹ìë³„ ê·¸ë£¹:', Object.keys(byManager));
            
            // Sort managers
            const managers = Object.keys(byManager).sort();
            
            // Render grid
            const container = document.getElementById('tradersGridContainer');
            let html = '';
            
            managers.forEach((manager, index) => {
                const tradersList = byManager[manager];
                
                // Add spacing between groups
                if (index > 0) {
                    html += '<div style="height: 24px;"></div>';
                }
                
                // Manager header
                html += `
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px 20px; border-radius: 8px; margin-bottom: 16px;">
                        <div style="color: white; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-user-tie"></i>
                            ${escapeHtml(manager)}
                            <span style="font-weight: 400; opacity: 0.9; font-size: 14px;">(${tradersList.length}ê°œ)</span>
                        </div>
                    </div>
                `;
                
                // Trader buttons grid
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px;">';
                
                tradersList.forEach(trader => {
                    html += `
                        <button onclick="window.location.href='trader-detail.html?id=${trader.id}'" 
                                style="padding: 16px 20px; 
                                       background: white; 
                                       border: 2px solid #e5e7eb; 
                                       border-radius: 8px; 
                                       text-align: center; 
                                       font-size: 15px; 
                                       font-weight: 600; 
                                       color: #1f2937; 
                                       cursor: pointer;
                                       transition: all 0.2s;"
                                onmouseover="this.style.borderColor='#667eea'; this.style.background='#f5f3ff'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.15)';"
                                onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                            ${escapeHtml(trader.company_name || '-')}
                        </button>
                    `;
                });
                
                html += '</div>';
            });
            
            container.innerHTML = html;
            
            document.getElementById('tradersGridContainer').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            console.log('âœ… ê·¸ë¦¬ë“œ ë Œë”ë§ ì™„ë£Œ');
        }

        function showEmptyState() {
            console.log('ğŸ“­ showEmptyState() í˜¸ì¶œë¨');
            document.getElementById('loading').style.display = 'none';
            document.getElementById('tradersGridContainer').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            console.log('âœ… Empty state í‘œì‹œ ì™„ë£Œ');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatPhoneNumber(number) {
            if (!number) return '';
            const cleaned = number.replace(/[^0-9]/g, '');
            if (cleaned.length === 11) {
                return cleaned.slice(0, 3) + '-' + cleaned.slice(3, 7) + '-' + cleaned.slice(7);
            }
            return number;
        }

        // Event listeners
        document.getElementById('managerFilter').addEventListener('change', applyFilters);
        document.getElementById('companyNameSearch').addEventListener('input', applyFilters);
        document.getElementById('globalSearch').addEventListener('input', (e) => {
            // Global search will filter from filteredTraders
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (!searchTerm) {
                applyFilters();
                return;
            }
            
            const searched = filteredTraders.filter(trader => {
                const searchableText = [
                    trader.company_name,
                    trader.ceo_name,
                    trader.business_code,
                    trader.contact,
                    trader.address,
                    trader.number
                ].join(' ').toLowerCase();
                
                return searchableText.includes(searchTerm);
            });
            
            document.getElementById('traderCount').textContent = searched.length;
            
            if (searched.length === 0) {
                showEmptyState();
            } else {
                renderTradersGrid(searched);
            }
        });

        // Create mock traders for preview mode
        function createMockTraders() {
            console.log('ğŸ“¦ Creating 60 mock traders for preview mode...');
            
            const managers = ['ê¹€ì² ìˆ˜', 'ì´ì˜í¬', 'ë°•ë¯¼ìˆ˜', 'ì •ë‹¤ì€', 'ìµœì¤€í˜¸'];
            const districts = ['ê°•ë‚¨êµ¬', 'ì„œì´ˆêµ¬', 'ì†¡íŒŒêµ¬', 'ê°•ë™êµ¬', 'ë§ˆí¬êµ¬', 'ìš©ì‚°êµ¬', 'ì˜ë“±í¬êµ¬', 'êµ¬ë¡œêµ¬', 'ê¸ˆì²œêµ¬', 'ê´€ì•…êµ¬'];
            const codes = ['703011', '703012'];
            const names = ['í™ê¸¸ë™', 'ê¹€ì˜ìˆ˜', 'ì´ìˆœì‹ ', 'ì„¸ì¢…ëŒ€ì™•', 'ì¥ë³´ê³ ', 'ì‹ ì‚¬ì„ë‹¹', 'ìœ ê´€ìˆœ', 'ì•ˆì¤‘ê·¼', 'ìœ¤ë´‰ê¸¸', 'ê¹€êµ¬'];
            
            const traders = [];
            for (let i = 1; i <= 60; i++) {
                traders.push({
                    id: `mock-client-${i}`,
                    company_name: `ë§¤ë§¤ì‚¬ì—…ì${i}`,
                    manager: managers[i % managers.length],
                    business_code: codes[i % codes.length],
                    ceo_name: names[i % names.length],
                    contact: `010-${String(1000 + i).slice(-4)}-${String(5000 + i).slice(-4)}`,
                    address: `ì„œìš¸ì‹œ ${districts[i % districts.length]} í…ŒìŠ¤íŠ¸ë¡œ ${i * 10}`,
                    number: String(i)
                });
            }
            
            return traders;
        }

        // ============================================
        // ì¼ê´„ ì—‘ì…€ ì—…ë¡œë“œ ê¸°ëŠ¥
        // ============================================

        // ì¼ê´„ ì—…ë¡œë“œ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
        function downloadBulkExcelTemplate() {
            if (typeof XLSX === 'undefined') {
                alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const wb = XLSX.utils.book_new();
                
                // Sheet 1: ë¬¼ê±´ëª©ë¡
                const inventoryData = [
                    ['ğŸ“‹ ë¬¼ê±´ëª©ë¡ ì‘ì„± ë°©ë²•: ê±°ë˜ì²˜ëª…*ê³¼ ë¬¼ê±´ëª…ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”. ì·¨ë“ê°€ì•¡/ê¸°íƒ€í•„ìš”ê²½ë¹„ëŠ” í•„ìš”ê²½ë¹„ìƒì„¸ ì‹œíŠ¸ì—ì„œ ìë™ ê³„ì‚°ë©ë‹ˆë‹¤.'],
                    [],
                    ['ê±°ë˜ì²˜ëª…*', 'ë¬¼ê±´ëª…', 'ì†Œì¬ì§€', 'ì·¨ë“ì¼(YYYYMMDD)', 'ì–‘ë„ì¼(YYYYMMDD)', 'ì–‘ë„ê°€ì•¡', 'ê¸°ë‚©ë¶€ ì¢…ì†Œì„¸', 'ê¸°ë‚©ë¶€ ì§€ë°©ì†Œë“ì„¸', 'ì‹ ê³ ê¸°í•œ', '85ì´ˆê³¼(O/X)', 'ë¹„ê³ '],
                    ['ì˜ˆ: (ì£¼)ì•„í†°ì„¸ë¬´íšŒê³„', 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸', 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123', '20230101', '20250115', '150000000', '1000000', '100000', '', 'O', ''],
                    ['ì˜ˆ: (ì£¼)ì•„í†°ì„¸ë¬´íšŒê³„', 'ì„œìš¸ì‹œ ì„œì´ˆêµ¬ ì˜¤í”¼ìŠ¤í…”', 'ì„œìš¸ì‹œ ì„œì´ˆêµ¬ ì„œì´ˆëŒ€ë¡œ 456', '20230201', '20250220', '120000000', '800000', '80000', '', 'X', ''],
                    ['ì˜ˆ: (ì£¼)ë² íƒ€ì»´í¼ë‹ˆ', 'ë¶€ì‚°ì‹œ í•´ìš´ëŒ€ ìƒê°€', 'ë¶€ì‚°ì‹œ í•´ìš´ëŒ€êµ¬ í•´ìš´ëŒ€ë¡œ 789', '20220315', '20250310', '280000000', '2000000', '200000', '', 'O', ''],
                    ['', '', '', '', '', '', '', '', '', '', '']
                ];
                
                const ws1 = XLSX.utils.aoa_to_sheet(inventoryData);
                
                ws1['!cols'] = [
                    {wch: 20}, // ê±°ë˜ì²˜ëª…
                    {wch: 25}, // ë¬¼ê±´ëª…
                    {wch: 35}, // ì†Œì¬ì§€
                    {wch: 18}, // ì·¨ë“ì¼
                    {wch: 18}, // ì–‘ë„ì¼
                    {wch: 15}, // ì–‘ë„ê°€ì•¡
                    {wch: 15}, // ê¸°ë‚©ë¶€ ì¢…ì†Œì„¸
                    {wch: 18}, // ê¸°ë‚©ë¶€ ì§€ë°©ì†Œë“ì„¸
                    {wch: 15}, // ì‹ ê³ ê¸°í•œ
                    {wch: 12}, // 85ì´ˆê³¼
                    {wch: 20}  // ë¹„ê³ 
                ];
                XLSX.utils.book_append_sheet(wb, ws1, 'ë¬¼ê±´ëª©ë¡');
                
                // Sheet 2: í•„ìš”ê²½ë¹„ ìƒì„¸
                const expenseData = [
                    ['ğŸ“‹ í•„ìš”ê²½ë¹„ ì‘ì„± ë°©ë²•: ê±°ë˜ì²˜ëª…*ê³¼ ë¬¼ê±´ëª…*ì€ ë¬¼ê±´ëª©ë¡ ì‹œíŠ¸ì™€ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤. (ë³µì‚¬&ë¶™ì—¬ë„£ê¸° ê¶Œì¥). ë²ˆí˜¸ëŠ” ìë™ìœ¼ë¡œ ë¶€ì—¬ë©ë‹ˆë‹¤.'],
                    [],
                    ['ê±°ë˜ì²˜ëª…*', 'ë¬¼ê±´ëª…* (ë¬¼ê±´ëª©ë¡ê³¼ ë™ì¼)', 'ë²ˆí˜¸', 'ë¹„ìš©ëª…', 'êµ¬ë¶„(ì·¨ë“ê°€ì•¡/ê¸°íƒ€í•„ìš”ê²½ë¹„)', 'ê¸ˆì•¡', 'ë¹„ìš©ì¸ì •(O/X)', 'ë¹„ê³ '],
                    ['ì˜ˆ: (ì£¼)ì•„í†°ì„¸ë¬´íšŒê³„', 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸', '1', 'ì·¨ë“ê°€ì•¡', 'ì·¨ë“ê°€ì•¡', '100000000', 'O', ''],
                    ['ì˜ˆ: (ì£¼)ì•„í†°ì„¸ë¬´íšŒê³„', 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸', '2', 'ì·¨ë“ì„¸ ë“±', 'ì·¨ë“ê°€ì•¡', '5000000', 'O', ''],
                    ['ì˜ˆ: (ì£¼)ì•„í†°ì„¸ë¬´íšŒê³„', 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì•„íŒŒíŠ¸', '3', 'ì¤‘ê°œìˆ˜ìˆ˜ë£Œ', 'ê¸°íƒ€í•„ìš”ê²½ë¹„', '2000000', 'O', ''],
                    ['ì˜ˆ: (ì£¼)ì•„í†°ì„¸ë¬´íšŒê³„', 'ì„œìš¸ì‹œ ì„œì´ˆêµ¬ ì˜¤í”¼ìŠ¤í…”', '1', 'ì·¨ë“ê°€ì•¡', 'ì·¨ë“ê°€ì•¡', '80000000', 'O', ''],
                    ['ì˜ˆ: (ì£¼)ë² íƒ€ì»´í¼ë‹ˆ', 'ë¶€ì‚°ì‹œ í•´ìš´ëŒ€ ìƒê°€', '1', 'ì·¨ë“ê°€ì•¡', 'ì·¨ë“ê°€ì•¡', '200000000', 'O', ''],
                    ['ì˜ˆ: (ì£¼)ë² íƒ€ì»´í¼ë‹ˆ', 'ë¶€ì‚°ì‹œ í•´ìš´ëŒ€ ìƒê°€', '2', 'ì·¨ë“ì„¸ ë“±', 'ì·¨ë“ê°€ì•¡', '10000000', 'O', ''],
                    ['', '', '', '', '', '', '', '']
                ];
                
                const ws2 = XLSX.utils.aoa_to_sheet(expenseData);
                
                ws2['!cols'] = [
                    {wch: 20}, {wch: 25}, {wch: 8}, {wch: 20}, {wch: 28}, {wch: 15}, {wch: 15}, {wch: 20}
                ];
                XLSX.utils.book_append_sheet(wb, ws2, 'í•„ìš”ê²½ë¹„ìƒì„¸');
                
                const fileName = `ë§¤ë§¤ì‚¬ì—…ì_ì¼ê´„ì—…ë¡œë“œ_ì–‘ì‹_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                alert('âœ… ì—‘ì…€ ì–‘ì‹ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n' +
                      'ğŸ“‹ ì‘ì„± ë°©ë²•:\n' +
                      '1. Sheet 1 (ë¬¼ê±´ëª©ë¡): ê±°ë˜ì²˜ëª…*ê³¼ ë¬¼ê±´ëª…ì„ ì •í™•íˆ ì…ë ¥\n' +
                      '   - 85ì´ˆê³¼: O ë˜ëŠ” X ì…ë ¥ (Y/Në„ ê°€ëŠ¥)\n' +
                      '   - ì·¨ë“ê°€ì•¡/ê¸°íƒ€í•„ìš”ê²½ë¹„ëŠ” í•„ìš”ê²½ë¹„ìƒì„¸ì—ì„œ ìë™ ê³„ì‚°\n\n' +
                      '2. Sheet 2 (í•„ìš”ê²½ë¹„ìƒì„¸): ê±°ë˜ì²˜ëª…*ê³¼ ë¬¼ê±´ëª…*ì„ ë¬¼ê±´ëª©ë¡ê³¼ ë™ì¼í•˜ê²Œ ì…ë ¥\n' +
                      '   - êµ¬ë¶„: "ì·¨ë“ê°€ì•¡" ë˜ëŠ” "ê¸°íƒ€í•„ìš”ê²½ë¹„"ë§Œ ì…ë ¥ (í•„ìˆ˜)\n' +
                      '   - ë²ˆí˜¸ëŠ” ìë™ìœ¼ë¡œ ë¶€ì—¬ë¨\n\n' +
                      'âš ï¸ ì¤‘ìš”: ê±°ë˜ì²˜ëª…ê³¼ ë¬¼ê±´ëª…ì€ ë„ì–´ì“°ê¸°ê¹Œì§€ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ ë§¤ì¹­ë©ë‹ˆë‹¤!\n' +
                      '   (ë³µì‚¬&ë¶™ì—¬ë„£ê¸° ê¶Œì¥)\n\n' +
                      'ì‘ì„± ì™„ë£Œ í›„ "ì¼ê´„ ì—…ë¡œë“œ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.');
            } catch (error) {
                console.error('Excel template download error:', error);
                alert('ì—‘ì…€ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n' + error.message);
            }
        }

        // ì¼ê´„ ì—‘ì…€ ì—…ë¡œë“œ ì²˜ë¦¬
        async function handleBulkExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (typeof XLSX === 'undefined') {
                alert('ì—‘ì…€ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                event.target.value = '';
                return;
            }
            
            try {
                showLoading();
                
                console.log('ğŸ“¤ ì—…ë¡œë“œ ì‹œì‘:', file.name, file.size, 'bytes');
                
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                
                console.log('ğŸ“‹ ì‹œíŠ¸ ëª©ë¡:', workbook.SheetNames);
                
                // Sheet 1: ë¬¼ê±´ëª©ë¡
                const inventorySheet = workbook.Sheets['ë¬¼ê±´ëª©ë¡'];
                if (!inventorySheet) {
                    console.error('âŒ ë¬¼ê±´ëª©ë¡ ì‹œíŠ¸ ì—†ìŒ');
                    throw new Error('ë¬¼ê±´ëª©ë¡ ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // ì›ë³¸ ë°ì´í„° (ë°°ì—´ í˜•ì‹)
                const inventoryRawData = XLSX.utils.sheet_to_json(inventorySheet, { header: 1, defval: '' });
                console.log('ğŸ“Š ì›ë³¸ ì‹œíŠ¸ ì´ í–‰ ìˆ˜:', inventoryRawData.length);
                
                // í—¤ë” í–‰ ì°¾ê¸° (ê±°ë˜ì²˜ëª…* í¬í•¨ëœ í–‰)
                let headerRowIndex = -1;
                for (let i = 0; i < Math.min(10, inventoryRawData.length); i++) {
                    const row = inventoryRawData[i];
                    
                    // ì¡°ê±´ 1: "ê±°ë˜ì²˜ëª…*"ê°€ ìˆì–´ì•¼ í•¨
                    const hasCompanyName = row.some(cell => {
                        const str = String(cell).trim();
                        return str === 'ê±°ë˜ì²˜ëª…*' || str === 'ê±°ë˜ì²˜ëª…' || str === 'íšŒì‚¬ëª…';
                    });
                    
                    // ì¡°ê±´ 2: "ë¬¼ê±´ëª…"ë„ ê°™ì€ í–‰ì— ìˆì–´ì•¼ í•¨
                    const hasPropertyName = row.some(cell => {
                        const str = String(cell).trim();
                        return str === 'ë¬¼ê±´ëª…' || str === 'ë¬¼ê±´ëª…*';
                    });
                    
                    // ì¡°ê±´ 3: ë¹ˆ ì…€ì´ ë„ˆë¬´ ë§ì§€ ì•Šì•„ì•¼ í•¨ (ìµœì†Œ 5ê°œ ì´ìƒì˜ ì»¬ëŸ¼)
                    const nonEmptyCount = row.filter(cell => String(cell).trim() !== '').length;
                    
                    if (hasCompanyName && hasPropertyName && nonEmptyCount >= 5) {
                        headerRowIndex = i;
                        console.log(`âœ… í—¤ë” í–‰ ë°œê²¬: ${i + 1}í–‰`);
                        console.log('ğŸ“‹ í—¤ë”:', row);
                        break;
                    }
                }
                
                if (headerRowIndex === -1) {
                    console.error('âŒ í—¤ë” í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì²˜ìŒ 10í–‰:', inventoryRawData.slice(0, 10));
                    throw new Error('ë¬¼ê±´ëª©ë¡ ì‹œíŠ¸ì—ì„œ "ê±°ë˜ì²˜ëª…*" ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní—¤ë” í–‰ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
                
                // í—¤ë” í–‰ ì´í›„ì˜ ë°ì´í„°ë§Œ JSONìœ¼ë¡œ ë³€í™˜
                const headers = inventoryRawData[headerRowIndex];
                console.log('ğŸ“‹ í—¤ë” ë°°ì—´ ìƒì„¸:', headers);
                console.log('ğŸ“‹ í—¤ë” ê°œìˆ˜:', headers.length);
                headers.forEach((h, idx) => {
                    console.log(`  [${idx}]: "${h}"`);
                });
                
                const dataRows = inventoryRawData.slice(headerRowIndex + 1);
                
                // JSON ë³€í™˜
                const inventoryJson = dataRows.map(row => {
                    const obj = {};
                    headers.forEach((header, idx) => {
                        obj[header] = row[idx] || '';
                    });
                    return obj;
                }).filter(row => {
                    // ì™„ì „íˆ ë¹ˆ í–‰ ì œê±°
                    return Object.values(row).some(val => String(val).trim() !== '');
                });
                
                console.log('âœ… ë¬¼ê±´ëª©ë¡ ë°ì´í„°:', inventoryJson.length, 'í–‰');
                
                if (inventoryJson.length > 0) {
                    console.log('ğŸ“Š ì²« ë²ˆì§¸ ë°ì´í„° í–‰:', inventoryJson[0]);
                    console.log('ğŸ” ì»¬ëŸ¼ëª…:', Object.keys(inventoryJson[0]));
                    
                    // ê° ì»¬ëŸ¼ì˜ ê°’ ì¶œë ¥
                    console.log('ğŸ“‹ ê° ì»¬ëŸ¼ì˜ ê°’:');
                    Object.entries(inventoryJson[0]).forEach(([key, value]) => {
                        console.log(`  "${key}": "${value}"`);
                    });
                }
                
                // Sheet 2: í•„ìš”ê²½ë¹„ìƒì„¸
                // ì›ë³¸ ì‹œíŠ¸ë¥¼ ë°°ì—´ë¡œë„ í™•ì¸ (í—¤ë” ê°ì§€ ë¬¸ì œ í™•ì¸ìš©)
                const rawData = XLSX.utils.sheet_to_json(inventorySheet, { header: 1, defval: '' });
                console.log('ğŸ“Š ì›ë³¸ ì‹œíŠ¸ (ë°°ì—´ í˜•ì‹):');
                console.log('  í–‰ 0 (ì²«ë²ˆì§¸):', rawData[0]);
                console.log('  í–‰ 1 (ë‘ë²ˆì§¸):', rawData[1]);
                console.log('  í–‰ 2 (ì„¸ë²ˆì§¸):', rawData[2]);
                console.log('  í–‰ 3 (ë„¤ë²ˆì§¸):', rawData[3]);
                
                // Sheet 2: í•„ìš”ê²½ë¹„ìƒì„¸
                const expenseSheet = workbook.Sheets['í•„ìš”ê²½ë¹„ìƒì„¸'];
                let expenseJson = [];
                if (expenseSheet) {
                    const expenseRawData = XLSX.utils.sheet_to_json(expenseSheet, { header: 1, defval: '' });
                    console.log('ğŸ“Š í•„ìš”ê²½ë¹„ìƒì„¸ ì›ë³¸ í–‰ ìˆ˜:', expenseRawData.length);
                    
                    // í—¤ë” í–‰ ì°¾ê¸°
                    let expenseHeaderRowIndex = -1;
                    for (let i = 0; i < Math.min(10, expenseRawData.length); i++) {
                        const row = expenseRawData[i];
                        
                        // ì¡°ê±´ 1: "ê±°ë˜ì²˜ëª…*"ê°€ ìˆì–´ì•¼ í•¨
                        const hasCompanyName = row.some(cell => {
                            const str = String(cell).trim();
                            return str === 'ê±°ë˜ì²˜ëª…*' || str === 'ê±°ë˜ì²˜ëª…' || str === 'íšŒì‚¬ëª…';
                        });
                        
                        // ì¡°ê±´ 2: "ë¹„ìš©ëª…" ë˜ëŠ” "êµ¬ë¶„"ì´ ê°™ì€ í–‰ì— ìˆì–´ì•¼ í•¨
                        const hasExpenseField = row.some(cell => {
                            const str = String(cell).trim();
                            return str === 'ë¹„ìš©ëª…' || str.includes('êµ¬ë¶„');
                        });
                        
                        // ì¡°ê±´ 3: ë¹ˆ ì…€ì´ ë„ˆë¬´ ë§ì§€ ì•Šì•„ì•¼ í•¨
                        const nonEmptyCount = row.filter(cell => String(cell).trim() !== '').length;
                        
                        if (hasCompanyName && hasExpenseField && nonEmptyCount >= 4) {
                            expenseHeaderRowIndex = i;
                            console.log(`âœ… í•„ìš”ê²½ë¹„ìƒì„¸ í—¤ë” í–‰ ë°œê²¬: ${i + 1}í–‰`);
                            break;
                        }
                    }
                    
                    if (expenseHeaderRowIndex !== -1) {
                        const expenseHeaders = expenseRawData[expenseHeaderRowIndex];
                        const expenseDataRows = expenseRawData.slice(expenseHeaderRowIndex + 1);
                        
                        expenseJson = expenseDataRows.map(row => {
                            const obj = {};
                            expenseHeaders.forEach((header, idx) => {
                                obj[header] = row[idx] || '';
                            });
                            return obj;
                        }).filter(row => {
                            return Object.values(row).some(val => String(val).trim() !== '');
                        });
                        
                        console.log('âœ… í•„ìš”ê²½ë¹„ìƒì„¸ ë°ì´í„°:', expenseJson.length, 'í–‰');
                    } else {
                        console.log('âš ï¸ í•„ìš”ê²½ë¹„ìƒì„¸ í—¤ë” í–‰ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                } else {
                    console.log('âš ï¸ í•„ìš”ê²½ë¹„ìƒì„¸ ì‹œíŠ¸ ì—†ìŒ (ì„ íƒì‚¬í•­)');
                }
                
                // ë°ì´í„° ê²€ì¦
                if (inventoryJson.length === 0) {
                    console.error('âŒ ë¬¼ê±´ëª©ë¡ ë°ì´í„° ì—†ìŒ');
                    throw new Error('ë¬¼ê±´ëª©ë¡ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                // ê±°ë˜ì²˜ëª…ë³„ë¡œ ê·¸ë£¹í™”
                const groupedData = {};
                console.log('ğŸ”„ ë°ì´í„° ê·¸ë£¹í™” ì‹œì‘...');
                
                // ìœ ì—°í•œ ì»¬ëŸ¼ëª… ë§¤ì¹­
                const getCompanyName = (row) => {
                    return String(
                        row['ê±°ë˜ì²˜ëª…*'] || 
                        row['ê±°ë˜ì²˜ëª…'] || 
                        row['ê±°ë˜ì²˜ ëª…*'] || 
                        row['ê±°ë˜ì²˜ ëª…'] ||
                        row['íšŒì‚¬ëª…'] ||
                        ''
                    ).trim();
                };
                
                const getPropertyName = (row) => {
                    return String(
                        row['ë¬¼ê±´ëª…'] || 
                        row['ë¬¼ê±´ëª…*'] ||
                        row['ë¬¼ê±´ ëª…'] ||
                        ''
                    ).trim();
                };
                
                for (const row of inventoryJson) {
                    const companyName = getCompanyName(row);
                    const propertyName = getPropertyName(row);
                    
                    console.log('ğŸ“ ì²˜ë¦¬ ì¤‘:', companyName, propertyName);
                    
                    if (!companyName) {
                        console.warn('âš ï¸ ê±°ë˜ì²˜ëª… ì—†ìŒ, ê±´ë„ˆëœ€');
                        console.warn('   í–‰ ë°ì´í„°:', row);
                        continue;
                    }
                    
                    if (!groupedData[companyName]) {
                        groupedData[companyName] = {
                            properties: [],
                            expenses: []
                        };
                    }
                    
                    // 85ì´ˆê³¼ ê²€ì¦ (O/X í˜•ì‹ìœ¼ë¡œ ë³€ê²½)
                    const over85Value = String(
                        row['85ì´ˆê³¼(O/X)'] || 
                        row['85ì´ˆê³¼(Y/N)'] || 
                        row['85ì´ˆê³¼'] || 
                        row['85 ì´ˆê³¼(Y/N)'] ||
                        'X'
                    ).trim().toUpperCase();
                    
                    // O/X ë˜ëŠ” Y/N ëª¨ë‘ í—ˆìš©
                    let over85 = 'N';
                    if (over85Value === 'O' || over85Value === 'Y') {
                        over85 = 'Y';
                    }
                    
                    if (over85Value !== 'Y' && over85Value !== 'N' && over85Value !== 'O' && over85Value !== 'X') {
                        console.warn(`âš ï¸ 85ì´ˆê³¼ ê°’ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤: [${companyName}] ${propertyName} - "${over85Value}" (O/X ë˜ëŠ” Y/Në§Œ ê°€ëŠ¥)`);
                    }
                    
                    // ë¬¼ê±´ ë°ì´í„°
                    const property = {
                        property_name: propertyName,
                        address: row['ì†Œì¬ì§€'] || row['ì£¼ì†Œ'] || '',
                        acquisition_value: 0, // í•„ìš”ê²½ë¹„ ìƒì„¸ì—ì„œ ìë™ ê³„ì‚°
                        other_expenses: 0, // í•„ìš”ê²½ë¹„ ìƒì„¸ì—ì„œ ìë™ ê³„ì‚°
                        transfer_value: parseNumber(row['ì–‘ë„ê°€ì•¡'] || row['ì–‘ë„ ê°€ì•¡']) || 0,
                        acquisition_date: formatDateToISO(row['ì·¨ë“ì¼(YYYYMMDD)'] || row['ì·¨ë“ì¼'] || row['ì·¨ë“ ì¼(YYYYMMDD)']),
                        transfer_date: formatDateToISO(row['ì–‘ë„ì¼(YYYYMMDD)'] || row['ì–‘ë„ì¼'] || row['ì–‘ë„ ì¼(YYYYMMDD)']),
                        report_deadline: '', // ì–‘ë„ì¼ì—ì„œ ìë™ ê³„ì‚°
                        prepaid_income_tax: parseNumber(row['ê¸°ë‚©ë¶€ ì¢…ì†Œì„¸'] || row['ê¸°ë‚©ë¶€ì¢…ì†Œì„¸']) || 0,
                        prepaid_local_tax: parseNumber(row['ê¸°ë‚©ë¶€ ì§€ë°©ì†Œë“ì„¸'] || row['ê¸°ë‚©ë¶€ì§€ë°©ì†Œë“ì„¸']) || 0,
                        over_85: over85,
                        progress_stage: 'ë¯¸í™•ì¸',
                        remarks: row['ë¹„ê³ '] || '',
                        expenses: []
                    };
                    
                    // ì‹ ê³ ê¸°í•œ ìë™ ê³„ì‚° (ì–‘ë„ì¼ì´ ì†í•œ ë‹¬ì˜ ë§ì¼ë¡œë¶€í„° 2ê°œì›” í›„)
                    if (property.transfer_date) {
                        try {
                            const transferDate = new Date(property.transfer_date);
                            // ì–‘ë„ì¼ì´ ì†í•œ ë‹¬ì˜ ë§ì¼
                            const endOfMonth = new Date(transferDate.getFullYear(), transferDate.getMonth() + 1, 0);
                            // 2ê°œì›” í›„ì˜ ë§ì¼
                            const deadline = new Date(endOfMonth.getFullYear(), endOfMonth.getMonth() + 3, 0);
                            property.report_deadline = deadline.toISOString().split('T')[0];
                            console.log(`ğŸ“… ì‹ ê³ ê¸°í•œ ê³„ì‚°: ì–‘ë„ì¼ ${property.transfer_date} â†’ ì‹ ê³ ê¸°í•œ ${property.report_deadline}`);
                        } catch (e) {
                            console.warn('ì‹ ê³ ê¸°í•œ ê³„ì‚° ì‹¤íŒ¨:', e);
                        }
                    }
                    
                    groupedData[companyName].properties.push(property);
                }
                
                // í•„ìš”ê²½ë¹„ ë§¤ì¹­ ë° ìë™ ë„˜ë²„ë§
                let matchedExpenseCount = 0;
                let unmatchedExpenses = [];
                
                for (const expenseRow of expenseJson) {
                    const companyName = getCompanyName(expenseRow);
                    const propertyName = String(
                        expenseRow['ë¬¼ê±´ëª…*'] || 
                        expenseRow['ë¬¼ê±´ëª…* (ë¬¼ê±´ëª©ë¡ê³¼ ë™ì¼)'] || 
                        expenseRow['ë¬¼ê±´ëª…'] ||
                        ''
                    ).trim();
                    
                    if (!companyName || !propertyName) continue;
                    
                    // êµ¬ë¶„ ê²€ì¦
                    const categoryValue = String(
                        expenseRow['êµ¬ë¶„(ì·¨ë“ê°€ì•¡/ê¸°íƒ€í•„ìš”ê²½ë¹„)'] || 
                        expenseRow['êµ¬ë¶„'] ||
                        ''
                    ).trim();
                    if (categoryValue !== 'ì·¨ë“ê°€ì•¡' && categoryValue !== 'ê¸°íƒ€í•„ìš”ê²½ë¹„') {
                        console.warn(`âš ï¸ êµ¬ë¶„ ê°’ì´ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤: [${companyName}] ${propertyName} - "${categoryValue}" (ì·¨ë“ê°€ì•¡ ë˜ëŠ” ê¸°íƒ€í•„ìš”ê²½ë¹„ë§Œ ê°€ëŠ¥)`);
                        continue; // ì˜ëª»ëœ êµ¬ë¶„ì€ ê±´ë„ˆëœ€
                    }
                    
                    const expense = {
                        no: '', // ìë™ ë„˜ë²„ë§ (ë‚˜ì¤‘ì— ì„¤ì •)
                        expense_name: expenseRow['ë¹„ìš©ëª…'] || expenseRow['ê²½ë¹„ëª…'] || '',
                        category: categoryValue,
                        amount: parseNumber(expenseRow['ê¸ˆì•¡']) || 0,
                        preliminary_approved: expenseRow['ë¹„ìš©ì¸ì •(O/X)'] || expenseRow['ë¹„ìš©ì¸ì •'] || 'X',
                        remarks: ''
                    };
                    
                    // í•´ë‹¹ ê±°ë˜ì²˜ëª…ê³¼ ë¬¼ê±´ëª…ì— ë§¤ì¹­
                    let matched = false;
                    if (groupedData[companyName]) {
                        for (const property of groupedData[companyName].properties) {
                            if (property.property_name === propertyName) {
                                property.expenses.push(expense);
                                matched = true;
                                matchedExpenseCount++;
                                break;
                            }
                        }
                    }
                    
                    // ë§¤ì¹­ ì‹¤íŒ¨ ê¸°ë¡
                    if (!matched) {
                        unmatchedExpenses.push({
                            companyName: companyName,
                            propertyName: propertyName,
                            expenseName: expense.expense_name
                        });
                    }
                }
                
                // ê° ë¬¼ê±´ì˜ í•„ìš”ê²½ë¹„ ìë™ ë„˜ë²„ë§ ë° ì·¨ë“ê°€ì•¡/ê¸°íƒ€í•„ìš”ê²½ë¹„ ê³„ì‚°
                for (const companyName in groupedData) {
                    for (const property of groupedData[companyName].properties) {
                        let acquisitionTotal = 0;
                        let otherExpensesTotal = 0;
                        
                        property.expenses.forEach((expense, idx) => {
                            // ìë™ ë„˜ë²„ë§
                            expense.no = String(idx + 1);
                            
                            // êµ¬ë¶„ì— ë”°ë¼ í•©ê³„ ê³„ì‚°
                            if (expense.category === 'ì·¨ë“ê°€ì•¡') {
                                acquisitionTotal += expense.amount;
                            } else if (expense.category === 'ê¸°íƒ€í•„ìš”ê²½ë¹„') {
                                otherExpensesTotal += expense.amount;
                            }
                        });
                        
                        // ë¬¼ê±´ì˜ ì·¨ë“ê°€ì•¡ê³¼ ê¸°íƒ€í•„ìš”ê²½ë¹„ ì„¤ì •
                        property.acquisition_value = acquisitionTotal;
                        property.other_expenses = otherExpensesTotal;
                        
                        // ì–‘ë„ì†Œë“ ìë™ ê³„ì‚°
                        property.transfer_income = property.transfer_value - property.acquisition_value - property.other_expenses;
                        
                        console.log(`  ë¬¼ê±´: ${property.property_name}`);
                        console.log(`    ì·¨ë“ê°€ì•¡: ${acquisitionTotal.toLocaleString()}ì›`);
                        console.log(`    ê¸°íƒ€í•„ìš”ê²½ë¹„: ${otherExpensesTotal.toLocaleString()}ì›`);
                        console.log(`    ì–‘ë„ê°€ì•¡: ${property.transfer_value.toLocaleString()}ì›`);
                        console.log(`    ì–‘ë„ì†Œë“: ${property.transfer_income.toLocaleString()}ì›`);
                    }
                }
                
                // ê° ê±°ë˜ì²˜ëª…ë³„ë¡œ ë°ì´í„° ì €ì¥
                let successCount = 0;
                let failCount = 0;
                const errors = [];
                
                console.log('ğŸ’¾ ë°ì´í„° ì €ì¥ ì‹œì‘...');
                console.log('ğŸ“Š ê·¸ë£¹í™”ëœ ê±°ë˜ì²˜ ìˆ˜:', Object.keys(groupedData).length);
                
                for (const [companyName, data] of Object.entries(groupedData)) {
                    console.log(`\nğŸ” ì²˜ë¦¬ ì¤‘: ${companyName}`);
                    console.log(`  ë¬¼ê±´ ìˆ˜: ${data.properties.length}ê°œ`);
                    
                    try {
                        // ê±°ë˜ì²˜ëª…ìœ¼ë¡œ ê³ ê°ì‚¬ ì°¾ê¸°
                        const client = allTraders.find(t => {
                            const clientName = (t.company_name || '').trim();
                            const targetName = companyName.trim();
                            return clientName === targetName;
                        });
                        
                        if (!client) {
                            const errorMsg = `ê±°ë˜ì²˜ëª… ${companyName}: ê³ ê°ì‚¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
                            console.error('âŒ', errorMsg);
                            errors.push(errorMsg);
                            failCount += data.properties.length;
                            continue;
                        }
                        
                        console.log(`  âœ… ê³ ê°ì‚¬ ì°¾ìŒ: ${client.company_name} (ID: ${client.id})`);
                        
                        // localStorageì— ì €ì¥
                        const storageKey = `trader_inventory_${client.id}`;
                        let existingData = [];
                        
                        try {
                            const stored = localStorage.getItem(storageKey);
                            if (stored) {
                                existingData = JSON.parse(stored);
                                console.log(`  ğŸ“¦ ê¸°ì¡´ ë°ì´í„°: ${existingData.length}ê°œ`);
                            }
                        } catch (e) {
                            console.warn('ê¸°ì¡´ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
                        }
                        
                        // ìƒˆ ë°ì´í„° ì¶”ê°€ (ê¸°ì¡´ ë°ì´í„° ìœ ì§€)
                        const updatedData = [...existingData, ...data.properties];
                        localStorage.setItem(storageKey, JSON.stringify(updatedData));
                        
                        console.log(`  ğŸ’¾ ì €ì¥ ì™„ë£Œ: ${data.properties.length}ê°œ ë¬¼ê±´ ì¶”ê°€`);
                        console.log(`  ğŸ“Š ì´ ë°ì´í„°: ${updatedData.length}ê°œ`);
                        
                        successCount += data.properties.length;
                    } catch (error) {
                        console.error(`ê±°ë˜ì²˜ëª… ${companyName} ì²˜ë¦¬ ì‹¤íŒ¨:`, error);
                        errors.push(`ê±°ë˜ì²˜ëª… ${companyName}: ${error.message}`);
                        failCount += data.properties.length;
                    }
                }
                
                hideLoading();
                event.target.value = '';
                
                console.log('\nğŸ“Š ìµœì¢… ê²°ê³¼:');
                console.log(`  âœ… ì„±ê³µ: ${successCount}ê±´`);
                console.log(`  âŒ ì‹¤íŒ¨: ${failCount}ê±´`);
                console.log(`  ğŸ’° í•„ìš”ê²½ë¹„ ë§¤ì¹­: ${matchedExpenseCount}ê±´`);
                console.log(`  âš ï¸ í•„ìš”ê²½ë¹„ ë¯¸ë§¤ì¹­: ${unmatchedExpenses.length}ê±´`);
                
                // ê²°ê³¼ ì•Œë¦¼
                let message = `âœ… ì—…ë¡œë“œ ì™„ë£Œ!\n\n`;
                message += `ğŸ“¦ ë¬¼ê±´ ëª©ë¡: ${successCount}ê±´ ì„±ê³µ, ${failCount}ê±´ ì‹¤íŒ¨\n`;
                message += `ğŸ’° í•„ìš”ê²½ë¹„: ${matchedExpenseCount}ê±´ ë§¤ì¹­`;
                
                if (unmatchedExpenses.length > 0) {
                    message += `, ${unmatchedExpenses.length}ê±´ ë§¤ì¹­ ì‹¤íŒ¨`;
                }
                
                if (errors.length > 0) {
                    message += '\n\n[ë¬¼ê±´ ë“±ë¡ ì˜¤ë¥˜]\n' + errors.slice(0, 3).join('\n');
                    if (errors.length > 3) {
                        message += `\n... ì™¸ ${errors.length - 3}ê±´`;
                    }
                }
                
                if (unmatchedExpenses.length > 0) {
                    message += '\n\n[í•„ìš”ê²½ë¹„ ë§¤ì¹­ ì‹¤íŒ¨]\n';
                    message += 'âš ï¸ ë¬¼ê±´ëª…ì´ ì¼ì¹˜í•˜ì§€ ì•Šì•„ ì—°ê²°ë˜ì§€ ì•Šì€ ê²½ë¹„:\n';
                    const samples = unmatchedExpenses.slice(0, 3);
                    for (const exp of samples) {
                        message += `- ${exp.companyName} / "${exp.propertyName}" / ${exp.expenseName}\n`;
                    }
                    if (unmatchedExpenses.length > 3) {
                        message += `... ì™¸ ${unmatchedExpenses.length - 3}ê±´`;
                    }
                    message += '\nğŸ’¡ ë¬¼ê±´ëª…ì„ ë¬¼ê±´ëª©ë¡ ì‹œíŠ¸ì™€ ì •í™•íˆ ì¼ì¹˜ì‹œì¼œì£¼ì„¸ìš”.';
                }
                
                alert(message);
                
                if (successCount > 0) {
                    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì œì•ˆ
                    if (confirm('ì—…ë¡œë“œëœ ë°ì´í„°ë¥¼ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(í™•ì¸ ì‹œ í˜ì´ì§€ê°€ ìƒˆë¡œê³ ì¹¨ë©ë‹ˆë‹¤)')) {
                        location.reload();
                    }
                }
                
            } catch (error) {
                hideLoading();
                event.target.value = '';
                console.error('Bulk upload error:', error);
                alert('âŒ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\n' + error.message + '\n\nì–‘ì‹ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        // ë‚ ì§œ í¬ë§· ë³€í™˜ í•¨ìˆ˜ (YYYYMMDD â†’ YYYY-MM-DD, ì—‘ì…€ ì‹œë¦¬ì–¼ ë²ˆí˜¸ ì§€ì›)
        function formatDateToISO(dateStr) {
            if (!dateStr) return '';
            
            const str = String(dateStr).trim();
            
            // 1) ì—‘ì…€ ì‹œë¦¬ì–¼ ë²ˆí˜¸ ê°ì§€ (ìˆ«ìë§Œ ìˆê³ , 8ìë¦¬ê°€ ì•„ë‹ˆê³ , 5ìë¦¬ ì •ë„)
            // ì—‘ì…€ ë‚ ì§œ ì‹œë¦¬ì–¼: 1900-01-01 ê¸°ì¤€ (ì‹œë¦¬ì–¼ ë²ˆí˜¸ 1)
            // ì˜ˆ: 45700 = 2025-02-08
            const numOnly = str.replace(/[^0-9]/g, '');
            if (numOnly === str && numOnly.length >= 4 && numOnly.length <= 6) {
                const serialNumber = parseInt(numOnly, 10);
                
                // ì—‘ì…€ ë‚ ì§œ ì‹œë¦¬ì–¼ ë²”ìœ„ ì²´í¬ (1900ë…„ ~ 2100ë…„ ì •ë„)
                // 1: 1900-01-01, 45700: 2025ë…„, 73050: 2100ë…„
                if (serialNumber >= 1 && serialNumber <= 80000) {
                    // ì—‘ì…€ ì‹œë¦¬ì–¼ â†’ Date ê°ì²´
                    // ì—‘ì…€ì€ 1900-01-01ì„ 1ë¡œ ì‹œì‘ (ë‹¨, 1900ë…„ ìœ¤ë…„ ë²„ê·¸ ë³´ì • í•„ìš”)
                    const excelEpoch = new Date(1899, 11, 30); // 1899-12-30 (ì—‘ì…€ ê¸°ì¤€ì¼)
                    const jsDate = new Date(excelEpoch.getTime() + serialNumber * 24 * 60 * 60 * 1000);
                    
                    // YYYY-MM-DD í¬ë§·
                    const year = jsDate.getFullYear();
                    const month = String(jsDate.getMonth() + 1).padStart(2, '0');
                    const day = String(jsDate.getDate()).padStart(2, '0');
                    
                    console.log(`ğŸ“… ì—‘ì…€ ì‹œë¦¬ì–¼ ë³€í™˜: ${serialNumber} â†’ ${year}-${month}-${day}`);
                    return `${year}-${month}-${day}`;
                }
            }
            
            // 2) YYYYMMDD í˜•ì‹ (8ìë¦¬)
            if (numOnly.length === 8) {
                return `${numOnly.slice(0, 4)}-${numOnly.slice(4, 6)}-${numOnly.slice(6, 8)}`;
            }
            
            // 3) ì´ë¯¸ YYYY-MM-DD í˜•ì‹ì´ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
            if (/^\d{4}-\d{2}-\d{2}$/.test(str)) {
                return str;
            }
            
            // 4) ë³€í™˜ ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
            console.warn(`âš ï¸ ë‚ ì§œ í˜•ì‹ ì¸ì‹ ì‹¤íŒ¨: "${dateStr}"`);
            return dateStr;
        }

        // ìˆ«ì íŒŒì‹± í•¨ìˆ˜
        function parseNumber(value) {
            if (!value || value === '') return 0;
            const str = String(value).replace(/[^0-9.-]/g, '');
            return parseFloat(str) || 0;
        }

        // ============================================

        // Load on page load
        console.log('ğŸ“¥ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ - loadTraders() í˜¸ì¶œ ì¤€ë¹„');
        
        // DOMì´ ì™„ì „íˆ ë¡œë“œëœ í›„ ì‹¤í–‰
        if (document.readyState === 'loading') {
            console.log('â³ DOM ë¡œë”© ëŒ€ê¸° ì¤‘...');
            document.addEventListener('DOMContentLoaded', () => {
                console.log('âœ… DOMContentLoaded ì´ë²¤íŠ¸ ë°œìƒ');
                loadTraders();
            });
        } else {
            console.log('âœ… DOM ì´ë¯¸ ë¡œë“œë¨ - ì¦‰ì‹œ ì‹¤í–‰');
            loadTraders();
        }
    </script>
</body>
</html>
